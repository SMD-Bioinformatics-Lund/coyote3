version: "3.9"
# usage:
# COYOTE3_VERSION is read from coyote/__version__.py (example):
#   export COYOTE3_VERSION="$(python3 coyote/__version__.py)"
# docker-compose up -d
# docker-compose down
services:
  coyote3_dev_web:
    container_name: coyote3_dev_web
    image: coyote3:${COYOTE3_VERSION:-local}-dev
    build:
      context: .
      dockerfile: Dockerfile.dev
      network: host
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    ports:
      - "6815:8000"
    env_file:
      - .coyote3_dev_env
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - FLASK_APP=wsgi
      - FLASK_DEBUG=1
      - ENABLE_FLASK_API_BLUEPRINT=0
      - REQUIRE_EXTERNAL_API=1
      - API_BASE_URL=http://coyote3_dev_api:8001
      - API_BROWSER_BASE=/api
      - TZ=Europe/Stockholm
      - GIT_COMMIT=${GIT_COMMIT:-unknown}
      - BUILD_TIME=${BUILD_TIME:-unknown}
    restart: always
    dns:
      - ${APP_DNS:-1.1.1.1}
      - 8.8.8.8
    networks:
      - coyote3-dev-net
    volumes:
      - ".git:/app/.git"
      - "./coyote:/app/coyote"
      - "./coyote_web:/app/coyote_web"
      - "./coyote_api:/app/coyote_api"
      - "./config:/app/config"
      - "/data/coyote3/logs:/app/logs"
      - "./docs:/app/docs"
      - "./config.py:/app/config.py"
      - "./wsgi.py:/app/wsgi.py"
      - "./gunicorn.conf.py:/app/gunicorn.conf.py"
      - "./logging_setup.py:/app/logging_setup.py"
      - "./CHANGELOG.md:/app/CHANGELOG.md"
      - "./README.md:/app/README.md"
      - "./LICENSE.txt:/app/LICENSE.txt"
      - "/access:/access"
      - "/media:/media"
      - "/data:/data"
      - "/fs1:/fs1"
    command: "python3 -m wsgi"
    depends_on:
      - coyote3_dev_api

  coyote3_dev_api:
    container_name: coyote3_dev_api
    image: coyote3:${COYOTE3_VERSION:-local}-dev
    build:
      context: .
      dockerfile: Dockerfile.dev
      network: host
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    ports:
      - "6816:8001"
    env_file:
      - .coyote3_dev_env
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - ENABLE_FLASK_API_BLUEPRINT=0
      - REQUIRE_EXTERNAL_API=0
      - TZ=Europe/Stockholm
      - GIT_COMMIT=${GIT_COMMIT:-unknown}
      - BUILD_TIME=${BUILD_TIME:-unknown}
    restart: always
    dns:
      - ${APP_DNS:-1.1.1.1}
      - 8.8.8.8
    networks:
      - coyote3-dev-net
    volumes:
      - ".git:/app/.git"
      - "./coyote:/app/coyote"
      - "./coyote_web:/app/coyote_web"
      - "./coyote_api:/app/coyote_api"
      - "./config:/app/config"
      - "/data/coyote3/logs:/app/logs"
      - "./docs:/app/docs"
      - "./config.py:/app/config.py"
      - "./wsgi.py:/app/wsgi.py"
      - "./asgi.py:/app/asgi.py"
      - "./gunicorn.conf.py:/app/gunicorn.conf.py"
      - "./logging_setup.py:/app/logging_setup.py"
      - "./CHANGELOG.md:/app/CHANGELOG.md"
      - "./README.md:/app/README.md"
      - "./LICENSE.txt:/app/LICENSE.txt"
      - "/access:/access"
      - "/media:/media"
      - "/data:/data"
      - "/fs1:/fs1"
    command: "python3 -m uvicorn coyote_api.app:app --host 0.0.0.0 --port 8001 --reload --reload-dir /app/coyote --reload-dir /app/coyote_api --reload-dir /app/coyote_web --reload-dir /app"

  coyote3_dev_tailwind:
    container_name: coyote3_dev_tailwind
    image: node:20-alpine
    working_dir: /app
    command: >
      sh -c "for i in 1 2 3 4 5; do npm install --no-audit --no-fund && break || sleep 5; done && npm run build:css && npm run dev:css"
    dns:
      - ${APP_DNS:-1.1.1.1}
      - 8.8.8.8
    volumes:
      - ".:/app"
      - "coyote3-node-modules:/app/node_modules"
    networks:
      - coyote3-dev-net
    restart: unless-stopped

  redis_coyote3_dev:
    container_name: redis_coyote3_dev
    image: ramsainanduri/redis:7.4.3
    ports:
      - "5818:6379"
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    dns:
      - ${APP_DNS:-1.1.1.1}
      - 8.8.8.8
    networks:
      - coyote3-dev-net
    restart: unless-stopped
    privileged: true

networks:
  coyote3-dev-net:
    external: true

volumes:
  coyote3-node-modules:
