{% extends "layout.html" %}
{% block title %}Manage Assay Configs{% endblock %}
{% block body %}

<div class="flex w-full h-full overflow-hidden">
  {% include "admin_sidebar.html" %}
  <main class="flex-1 overflow-y-auto p-6 bg-indigo-50">

    <!-- Header -->
    <div class="mb-6 flex flex-col md:flex-row justify-between items-center">
      <h1 class="text-xl font-semibold tracking-wide text-gray-800">Manage Assay Configs</h1>
      <div class="flex gap-3 mt-4 md:mt-0">
        <select id="assay-selector" class="border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 shadow-sm focus:ring-2 focus:ring-blue-500">
          <option disabled selected>Select Assay</option>
        </select>
        <button id="load-assay-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm shadow">Show</button>
      </div>
    </div>

    <!-- Form -->
    <form id="assay-form" class="space-y-6 hidden">
      <div id="default-fields"></div>

      <!-- Add New Field -->
      <div class="mt-6 bg-white rounded-xl shadow-md p-6">
        <h2 class="text-md font-semibold mb-4 text-gray-800">âž• Add Custom Field</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label for="new-key" class="block text-sm font-medium text-gray-700 mb-1">Key</label>
            <input id="new-key" type="text" placeholder="e.g., DNA.images"
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none" />
          </div>
          <div>
            <label for="new-value" class="block text-sm font-medium text-gray-700 mb-1">Value</label>
            <input id="new-value" type="text" placeholder='e.g., ["img1", "img2"] or {"foo": true}'
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none" />
          </div>
          <div>
            <label for="new-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="new-type" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 shadow-sm">
              <option value="auto">Auto</option>
              <option value="string">String</option>
              <option value="int">Integer</option>
              <option value="float">Float</option>
              <option value="bool">Boolean</option>
              <option value="json">JSON</option>
            </select>
          </div>
          <div class="flex items-end">
            <button type="button" id="add-field-btn"
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md px-4 py-2 text-sm shadow">âž• Add Field</button>
          </div>
        </div>
      </div>

      <!-- JSON Preview -->
      <div class="bg-gray-100 rounded-xl p-4 text-sm text-gray-700 font-mono">
        <h3 class="text-sm font-semibold mb-2">Live JSON Preview</h3>
        <pre id="json-preview" class="whitespace-pre-wrap"></pre>
      </div>

      <div class="flex justify-end">
        <button type="button" id="save-assay-btn"
          class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md text-sm shadow">Save Config</button>
      </div>
    </form>
  </main>
</div>

<script>
  const keyGroups = {
    Frequency: ["default_popfreq", "default_min_freq", "default_max_freq"],
    Coverage: ["default_min_reads", "default_mindepth", "warn_cov", "error_cov"],
    CNV: ["default_max_cnv_size", "default_min_cnv_size"],
    DNA: ["DNA"],
    RNA: ["RNA"],
    Query: ["query"],
    Verification: ["verif_samples"],
    Metadata: ["assay_name", "panel_name", "updated", "created", "updated_by", "created_by"]
  };
  

function flattenObject(obj, parent = '', res = {}) {
  for (let key in obj) {
    const propName = parent ? parent + '.' + key : key;
    if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
      flattenObject(obj[key], propName, res);
    } else {
      res[propName] = obj[key];
    }
  }
  return res;
}

function setNested(obj, path, value) {
  const keys = path.split(".");
  let current = obj;
  while (keys.length > 1) {
    const k = keys.shift();
    if (!(k in current)) current[k] = {};
    current = current[k];
  }
  current[keys[0]] = value;
}

function deleteNested(obj, path) {
  const keys = path.split(".");
  let current = obj;
  while (keys.length > 1) {
    const k = keys.shift();
    if (!(k in current)) return;
    current = current[k];
  }
  delete current[keys[0]];
}

function renderFormFromConfig(config) {
  const container = document.getElementById("default-fields");
  container.innerHTML = "";
  const flat = flattenObject(config);
  const grouped = {};

  // 1. Group defined keys
  Object.entries(keyGroups).forEach(([group, keys]) => {
    grouped[group] = keys.filter(k => k in flat);
  });
  
  // 2. Track all grouped keys
  const alreadyGrouped = new Set(Object.values(grouped).flat());
  
  // 3. Group remaining keys by top-level prefix
  Object.keys(flat).forEach(key => {
    if (alreadyGrouped.has(key)) return;
    const top = key.includes(".") ? key.split(".")[0] : key;
    if (!grouped[top]) grouped[top] = [];
    grouped[top].push(key);
  });
  
  

  for (const [section, keys] of Object.entries(grouped)) {
    if (keys.length === 0) continue;
    const groupDiv = document.createElement("div");
    groupDiv.className = "bg-white rounded-xl shadow p-4 mb-6";

    const title = document.createElement("h3");
    title.className = "text-md font-semibold text-gray-800 mb-4";
    title.textContent = section;
    groupDiv.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";

    keys.sort().forEach(key => {
      const value = flat[key];
      const type = typeof value;

      const wrapper = document.createElement("div");
      wrapper.className = "flex flex-col relative hover:bg-red-50 rounded-md p-1";

      const label = document.createElement("label");
      label.className = "text-sm font-medium text-gray-700 mb-1";
      label.textContent = key;

      let input;
      if (type === "boolean") {
        input = document.createElement("input");
        input.type = "checkbox";
        input.checked = value;
        input.className = "h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500";
      } else {
        input = document.createElement("input");
        input.type = "text";
        input.value = Array.isArray(value) || typeof value === "object" ? JSON.stringify(value) : value;
        input.className = "border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-800 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none";
      }

      input.dataset.key = key;
      input.dataset.rawType = type;

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.innerHTML = "âŒ";
      delBtn.title = "Delete this field";
      delBtn.className = "absolute top-1 right-1 text-red-500 text-xs";
      delBtn.onclick = () => {
        deleteNested(currentConfig, key);
        renderFormFromConfig(currentConfig);
      };
      

      wrapper.appendChild(label);
      wrapper.appendChild(input);
      wrapper.appendChild(delBtn);
      grid.appendChild(wrapper);
    });

    groupDiv.appendChild(grid);
    container.appendChild(groupDiv);
  }
  updateJsonPreview();
}

let currentConfig = {};

function gatherConfigFromForm() {
  const result = {};
  document.querySelectorAll("#default-fields input").forEach(input => {
    const key = input.dataset.key;
    let val;
    if (input.type === "checkbox") {
      val = input.checked;
    } else {
      try {
        val = JSON.parse(input.value);
      } catch {
        val = input.value;
      }
    }
    setNested(result, key, val);
  });
  return result;
}

function updateJsonPreview() {
  const config = gatherConfigFromForm();
  document.getElementById("json-preview").textContent = JSON.stringify(config, null, 2);
}

fetch("/admin/assays")
  .then(res => res.json())
  .then(assays => {
    const dropdown = document.getElementById("assay-selector");
    assays.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      dropdown.appendChild(opt);
    });
  });

document.getElementById("load-assay-btn").onclick = () => {
  const assay = document.getElementById("assay-selector").value;
  fetch(`/admin/assay/${assay}`)
    .then(res => res.json())
    .then(data => {
      currentConfig = data;
      renderFormFromConfig(currentConfig);
      document.getElementById("assay-form").classList.remove("hidden");
    });
};

document.getElementById("add-field-btn").onclick = () => {
  const key = document.getElementById("new-key").value.trim();
  const valRaw = document.getElementById("new-value").value.trim();
  const typeHint = document.getElementById("new-type").value;

  if (!key) return alert("Key is required");

  let val;
  try {
    switch (typeHint) {
      case "int": val = parseInt(valRaw); break;
      case "float": val = parseFloat(valRaw); break;
      case "bool": val = valRaw === "true"; break;
      case "json": val = JSON.parse(valRaw); break;
      case "string": val = valRaw; break;
      default:
        try { val = JSON.parse(valRaw); } catch { val = valRaw; }
    }
  } catch {
    return alert("Invalid value or type");
  }

  setNested(currentConfig, key, val);
  renderFormFromConfig(currentConfig);
  document.getElementById("new-key").value = "";
  document.getElementById("new-value").value = "";
};

document.getElementById("save-assay-btn").onclick = () => {
  const assay = document.getElementById("assay-selector").value;
  const config = gatherConfigFromForm();
  config.assay_name = assay;

  fetch(`/admin/assay/${assay}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(config)
  })
    .then(res => res.json())
    .then(() => {
      // ðŸ” Re-fetch updated config from the server
      return fetch(`/admin/assay/${assay}`);
    })
    .then(res => res.json())
    .then(updated => {
      currentConfig = updated;
      renderFormFromConfig(currentConfig);
      alert("Assay config saved and refreshed.");
    })
    .catch(err => {
      console.error("Save failed:", err);
      alert("Failed to save. See console for details.");
    });
};


</script>

{% endblock %}