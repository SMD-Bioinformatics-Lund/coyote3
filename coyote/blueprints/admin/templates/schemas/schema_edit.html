{% extends "layout.html" %}
{% block title %}Edit Schema{% endblock %}

{% block body %}

<style>
  .CodeMirror {
    height: auto !important;
    min-height: 400px;
  }

  .CodeMirror-scroll {
    overflow-y: hidden !important;
    overflow-x: auto;
  }
</style>

<div class="flex w-full h-full overflow-hidden">
  {% include "admin_sidebar.html" %}
  <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col">
    <section class="p-2 ml-2 mt-2">
      <div class="bg-white border border-gray-200 rounded-2xl shadow-xl p-6">

        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-xl font-bold text-blue-500 tracking-wide capitalize flex gap-4 align-middle"><img src="{{ url_for('static', filename='icons/heroicons_outline_24/pencil-square.svg') }}" alt="Schema Edit Icon" class="h-6 w-6"> Edit Schema - <i>{{schema_blob._id}}</i></h1>
          <a href="{{ url_for('admin_bp.schemas') }}" class="text-sm text-blue-500 hover:underline">← Back to Schemas</a>
        </div>

        <!-- JSON Editor Form -->
        <form method="POST" onsubmit="return validateJSON()" class="space-y-4">
          <div>
            <label for="json_blob" class="block text-sm font-medium text-gray-700 mb-2">Schema JSON</label>
            <textarea id="json_blob" name="json_blob" class="hidden">{{ schema_blob | prettyjson }} </textarea>
            <div id="json_editor" class="border rounded-xl shadow-sm text-sm w-full min-h-[400px]"></div>
            <p id="json_error" class="mt-2 text-red-500 text-sm hidden"></p>
          </div>

          <div class="text-right">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow-sm transition">
              Save Schema
            </button>
          </div>
        </form>
      </div>
    </section>
  </main>
</div>

<!-- CodeMirror CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/lint/lint.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/lint/json-lint.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/idea.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/lint/lint.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsonlint/1.6.0/jsonlint.min.js"></script>

<!-- CodeMirror Setup -->
<script>
  let editor = CodeMirror(document.getElementById("json_editor"), {
    mode: { name: "application/json", globalVars: true },
    lineNumbers: true,
    tabSize: 2,
    theme: "idea",
    gutters: ["CodeMirror-lint-markers"],
    lint: true,
    value: document.getElementById("json_blob").value,
    viewportMargin: Infinity  // ✨ auto-expand height
  });
  

  // ⏱ Ensure it resizes correctly
  setTimeout(() => {
    editor.refresh();
  }, 100);

  function validateJSON() {
    const jsonError = document.getElementById("json_error");
    try {
      const value = editor.getValue();
      JSON.parse(value);
      document.getElementById("json_blob").value = value;
      jsonError.classList.add("hidden");
      return true;
    } catch (e) {
      jsonError.textContent = "⚠️ Invalid JSON: " + e.message;
      jsonError.classList.remove("hidden");
      return false;
    }
  }
</script>

{% endblock %}
