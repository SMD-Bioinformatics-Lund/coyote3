{% extends "layout.html" %}
{% block title %}Create New User{% endblock %}
{% block body %}
<div class="flex w-full h-full overflow-hidden">
  <!-- Sidebar -->
  {% include "admin_sidebar.html" %}

  <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col items-center">
    <section id="create-user-section" class="bg-blue-50 shadow-lg rounded-xl px-6 py-6 my-4 border border-gray-200 w-full max-w-xl">

      <h1 class="text-xl text-center font-semibold text-black tracking-wide uppercase">Create New User</h1>

      <form method="POST" action="{{ url_for('admin_bp.create_user') }}" id="user-form" class="space-y-2 text-sm">
        {{ form.hidden_tag() }}
      
        <!-- Full Name -->
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="fullname">Full Name</label>
          {{ form.fullname(class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400") }}
          {% if form.fullname.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.fullname.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Username -->
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="username">Username</label>
          {{ form.username(class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400", id="username") }}
          <p id="username-feedback" class="text-xs text-gray-500 mt-1"></p>
          {% if form.username.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.username.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Email -->
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="email">Email</label>
          {{ form.email(class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400", id="email") }}
          <p id="email-feedback" class="text-xs text-gray-500 mt-1"></p>
          {% if form.email.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.email.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Job Title -->
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="job_title">Job Title</label>
          {{ form.job_title(class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400") }}
          {% if form.job_title.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.job_title.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Password -->
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="password">Password</label>
          {{ form.password(class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400", id="password") }}
          {% if form.password.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.password.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Confirm Password -->
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="confirm_password">Confirm Password</label>
          {{ form.confirm_password(class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400", id="confirm_password") }}
          <p id="password-feedback" class="text-xs text-gray-500 mt-1"></p>
          {% if form.confirm_password.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.confirm_password.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Groups -->
        <div>
          <label class="block text-gray-700 font-medium mb-1">Groups</label>
          <div id="group-container" class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-inner bg-white flex flex-wrap gap-2 hidden"></div>
          <input type="text"
                 id="group-input"
                 class="mt-3 w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400"
                 placeholder="Add new group and press Enter"
                 onkeydown="addGroup(event)">
          {{ form.groups(class="hidden", id="groups-hidden") }}
        </div>
      
        <!-- Role -->
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="role">Role</label>
          {{ form.role(class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm text-gray-900 focus:ring-2 focus:ring-indigo-400 bg-indigo-50") }}
          {% if form.role.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.role.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Is Active -->
        <div class="pt-2">
          <label class="inline-flex items-center">
            {{ form.is_active(class="form-checkbox h-4 w-4 text-indigo-600") }}
            <span class="ml-2 text-gray-700 font-medium">Active</span>
          </label>
          {% if form.is_active.errors %}
            <p class="text-red-500 text-xs mt-1">{{ form.is_active.errors[0] }}</p>
          {% endif %}
        </div>
      
        <!-- Submit -->
        <div class="pt-4 flex justify-center">
          <button class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-6 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                  type="submit" onclick="createUser()">
            Create User
          </button>
        </div>
      </form>
      

    </section>
  </main>
</div>



<script>
  document.getElementById('username').addEventListener('blur', function() {
      const username = this.value;
      if (username) {
          fetch('{{ url_for("admin_bp.validate_username") }}', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
              },
              body: JSON.stringify({ username: username })
          })
          .then(response => response.json())
          .then(data => {
              const feedback = document.getElementById('username-feedback');
              if (data.exists) {
                  feedback.textContent = 'Username already exists';
                  feedback.className = 'text-red-500';
              } else {
                  feedback.textContent = 'Username available';
                  feedback.className = 'text-green-500';
              }
          });
      }
  });

  document.getElementById('email').addEventListener('blur', function() {
      const email = this.value;
      if (email) {
          fetch('{{ url_for("admin_bp.validate_email") }}', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
              },
              body: JSON.stringify({ email: email })
          })
          .then(response => response.json())
          .then(data => {
              const feedback = document.getElementById('email-feedback');
              if (data.exists) {
                  feedback.textContent = 'Email already exists';
                  feedback.className = 'text-red-500';
              } else {
                  feedback.textContent = 'Email available';
                  feedback.className = 'text-green-500';
              }
          });
      }
  });

  document.getElementById('confirm_password').addEventListener('input', function() {
      const password = document.getElementById('password').value;
      const confirmPassword = this.value;
      const feedback = document.getElementById('password-feedback');
      if (password !== confirmPassword) {
          feedback.textContent = 'Passwords do not match';
          feedback.className = 'text-red-500';
      } else {
          feedback.textContent = 'Passwords match';
          feedback.className = 'text-green-500';
      }
  });

  function removeGroup(element) {
    element.parentElement.remove();
    updateHiddenGroupsField();
}

  function addGroup(event) {
      if (event.key === 'Enter') {
          event.preventDefault();
          const groupInput = document.getElementById('group-input');
          const groupName = groupInput.value.trim();
          if (groupName) {
              const groupContainer = document.getElementById('group-container');
              const newGroup = document.createElement('div');
              newGroup.className = 'bg-gray-200 rounded-md py-2 px-2 mt-1 flex items-center group-item';
              newGroup.innerHTML = `
                  <span class="text-gray-800 font-semibold py-1 px-2 rounded-lg">${groupName}</span>
                  <button type="button" class="ml-2 text-red-500" onclick="removeGroup(this)">x</button>
              `;
              groupContainer.appendChild(newGroup);
              groupContainer.style.display = 'flex'; // Show the group container
              groupInput.value = '';
              updateHiddenGroupsField();
          }
      }
  }

  function updateHiddenGroupsField() {
      const groupContainer = document.getElementById('group-container');
      const groups = Array.from(groupContainer.getElementsByClassName('group-item')).map(item => {
          return item.querySelector('span').textContent.trim();
      });
      document.getElementById('groups-hidden').value = groups.join(',');

      // Hide the group container if there are no groups
      if (groups.length === 0) {
          groupContainer.style.display = 'none';
      }
  }

  function createUser() {
    updateHiddenGroupsField();
    document.getElementById('user-form').submit();
}

</script>
{% endblock %}
