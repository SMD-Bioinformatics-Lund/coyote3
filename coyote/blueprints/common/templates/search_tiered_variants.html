{% extends "layout.html" %}

{% block body %}
<!-- PAGE LAYOUT: main content + fixed right sidebar -->
<div class="flex w-full h-full overflow-hidden">
  <!-- MAIN WRAPPER (add right padding when sidebar exists) -->
  <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col">

    <!-- Search Bar -->
    <section id="tiered_variant-search" class="mt-2 flex flex-col ml-4">
      <div class="flex">
        <h2 class="text-xl font-semibold mb-2">Search Tiered Variants</h2>
      </div>

      <!-- Form only (no right stats card here anymore) -->
      <div class="w-full">
        <form action="" method="POST" class="flex flex-col gap-3 relative max-w-4xl w-full">
          <div class="flex items-center gap-4 w-full">
            {{ form.hidden_tag() }}

            <div class="relative group flex-grow min-w-[250px]">
              <input
                type="text"
                name="variant_search"
                id="tiered-variant-search-input"
                value="{{ search_str or '' }}"
                class="border border-gray-500 rounded-full py-1 pl-10 pr-4 focus:outline-none focus:border-blue-500 w-full"
                placeholder="Search Gene, Variant(HGVSp, HGVSc, Genomic), Transcript, Assay, Sub Panel">

              <img
                src="{{ url_for('static', filename='icons/heroicons_outline_24/magnifying-glass.svg') }}"
                alt="Search Icon"
                class="absolute left-1 top-1 mb-2 pb-2 h-8 w-5 cursor-pointer"
                onclick="document.getElementById('tiered-variant-search-input').focus()">
            </div>

            <details class="relative" id="tiered-mode-dd">
              <summary class="list-none cursor-pointer border border-gray-500 rounded-full py-1 px-4 bg-white hover:bg-gray-50 text-sm flex items-center">
                <span id="tiered-mode-label">
                  {{ dict(form.search_options.choices).get(form.search_options.data, "Search mode") }}
                </span>
                <span class="ml-1">â–¾</span>
              </summary>

              <div class="absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg w-72 z-50">
                {% for value, label in form.search_options.choices %}
                  <label class="px-3 py-2 hover:bg-gray-50 flex items-center cursor-pointer">
                    <input
                      type="radio"
                      name="{{ form.search_options.name }}"
                      value="{{ value }}"
                      class="h-4 w-4"
                      {% if form.search_options.data == value %}checked{% endif %}>
                    <span class="ml-2 text-sm">{{ label }}</span>
                  </label>
                {% endfor %}
              </div>
            </details>

            <div class="flex items-center px-3 py-1.5 border border-gray-300 rounded-3xl bg-gray-50">
              {{ form.include_annotation_text(class="h-4 w-4 text-blue-600") }}
              <label class="ml-2 text-sm cursor-pointer">
                Include annotation text
              </label>
            </div>

            <button type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-4 rounded-full">
              Search
            </button>
          </div>

          <div class="pt-1 border-t border-gray-200">
            <div class="text-sm font-semibold text-gray-800 mb-2">
              {{ form.assay.label }}
            </div>

            <div class="flex flex-wrap gap-3">
              {% for subfield in form.assay %}
                <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border bg-gray-50 hover:bg-gray-100 cursor-pointer">
                  {{ subfield }}
                  <span class="text-sm text-gray-800">{{ subfield.label.text }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        </form>
      </div>
    </section>

    <!-- Search Results -->
    <section id="search-results" class="py-2 mt-2 ml-4">
      <div class="justify-start">

        <div class="bg-blue-50 shadow-3xl rounded-2xl p-4 relative overflow-hidden">
          <!-- Header -->
          <div class="flex flex-row justify-between items-center gap-4 px-2 py-2">
            <h2 class="text-base font-semibold text-black tracking-wide uppercase">
              Search returned {{ docs|length }} entries
            </h2>

            <div class="relative w-64">
              <input type="text" id="search-input"
                      class="w-full border border-gray-300 rounded-lg py-2 pl-4 pr-10 text-sm text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"
                      placeholder="Search...">
              <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                <img src="{{ url_for('static', filename='icons/heroicons_outline_24/magnifying-glass.svg') }}"
                      alt="search results table"
                      class="h-5 w-5 text-gray-500 cursor-pointer"
                      onclick="document.getElementById('search-input').focus()">
              </div>
            </div>
          </div>

          <div class="overflow-x-auto rounded-2xl shadow-3xl relative pagination"
                id="tiered-variants-list"
                data-rows-per-page="30"
                pagination-button-color="blue"
                pagination-button-text-color="black">

            <table id="tiered-variants-list-table"
                    class="min-w-full bg-transparent shadow-md rounded-2xl text-xs my-2 overflow-hidden">
              <thead class="sortable rounded-t-2xl overflow-hidden border-gray-800">
                <tr class="border-b text-left border-gray-800 bg-blue-200 uppercase tracking-wider shadow-xl rounded-t-2xl">
                  <th class="p-2 font-normal">Variant</th>
                  <th class="p-2 font-normal">Tier</th>
                  <th class="p-2 font-normal">Gene</th>
                  <th class="p-2 font-normal">Transcript</th>
                  <th class="p-2 font-normal">Assay</th>
                  <th class="p-2 font-normal">Sub Panel</th>
                  <th class="p-2 font-normal">Author</th>
                  {% if include_annotation_text %}
                    <th class="p-2 font-normal max-w-2xl">Comment</th>
                  {% endif %}
                  <th class="p-2 font-normal" data-nosort="true">Samples</th>
                </tr>
              </thead>

              <tbody id="tiered-variants-list-table-body"
                      class="text-gray-800 rounded-b-2xl overflow-hidden">
              {% if docs %}
                {% for doc in docs %}
                  <tr class="border-t border-gray-400 hover:bg-blue-100 text-left last:rounded-b-2xl">
                    <td class="p-2 font-medium">{{ doc.variant }}</td>

                    <td class="p-2 font-medium">
                      {% if doc.class %}
                        <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-tier{{ doc.class }} text-white shadow-md">
                          {{ doc.class }}
                        </div>
                      {% else %}
                        -
                      {% endif %}
                    </td>

                    <td class="p-2 font-medium">{{ doc.gene or '-' }}</td>
                    <td class="p-2 font-medium">{{ doc.transcript or '-' }}</td>

                    {% if doc.assay %}
                      <td class="p-2 font-medium">{{ doc.assay }}</td>
                    {% else %}
                      <td class="p-2 font-medium text-red-600">Historic</td>
                    {% endif %}

                    <td class="p-2 font-medium">{{ doc.subpanel or '-' }}</td>
                    <td class="p-2 font-medium">
                      {{ doc.author or 'unknown' }}<br>
                      <small>{{ doc.time_created|human_date or '-' }}</small>
                    </td>

                    {% if include_annotation_text %}
                      <td class="p-2 font-medium max-w-lg" data-nosort="true">{{ doc.text }}</td>
                    {% endif %}

                    <td class="p-2 font-medium" data-nosort="true">
                      {% for sample_oid, sample_info in doc.samples.items() %}
                        <div class="mb-2">
                          <a href="{{ url_for('dna_bp.list_variants', sample_id=sample_info.sample_name) }}"
                              class="text-blue-500 hover:underline">
                            {{ sample_info.sample_name }}
                          </a>
                          <p class="inline-block text-lg mx-1">|</p>

                          {% if has_access('view_reports', min_role='admin') %}
                            {% for report_id, report_num in sample_info.report_oids.items() %}
                              <a href="{{ url_for('home_bp.view_report', sample_id=sample_info.sample_name, report_id=report_id) }}"
                                  class="inline-block bg-blue-400 text-white my-1 px-2 py-0.5 rounded-lg text-xs font-bold mx-1 hover:bg-blue-500 transition">
                                {{ report_num }}
                              </a>
                            {% endfor %}
                          {% else %}
                            No Access
                          {% endif %}
                        </div>
                      {% else %}
                        -
                      {% endfor %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="{% if include_annotation_text %}9{% else %}8{% endif %}"
                      class="p-4 text-center text-sm text-gray-600">
                    {% if search_str %}
                      No tiered variants found for "<strong>{{ search_str }}</strong> in <strong>{{ search_mode }}</strong>".
                      Please try a different search term or change the <strong>mode</strong> of search.
                    {% else %}
                      Use the search bar above to find tiered variants.
                    {% endif %}
                  </td>
                </tr>
              {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- RIGHT SIDEBAR (fixed, independent scroll) -->
  <aside class="w-72 bg-transparent text-black flex flex-col overflow-y-auto shadow-2xl mx-1 py-1 px-1 right-0 h-full">
    <div class="h-full flex flex-col">

      <!-- Sidebar header -->
      <div class="px-4 py-2 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold text-gray-900">Tier stats</h3>
          <span class="text-xs text-gray-700 tracking-wide capitalize">{{ search_mode }} search</span>
        </div>
      </div>

      <!-- Sidebar content -->
      <div class="flex-1 overflow-y-auto px-4 py-2">
        <!-- TOTAL -->
        <div class="mb-4">
          <div class="text-sm font-semibold text-gray-800 mb-2">Total (unique across assays)</div>
          <div class="grid grid-cols-2 gap-2 text-sm font-semibold">
            <div class="flex justify-between bg-tier1 opacity-70 rounded-lg px-2 py-1">
              <span>Tier 1</span><span class="font-bold">{{ tier_stats.total.tier1 or 0 }}</span>
            </div>
            <div class="flex justify-between bg-tier2 opacity-70 rounded-lg px-2 py-1">
              <span>Tier 2</span><span class="font-bold">{{ tier_stats.total.tier2 or 0 }}</span>
            </div>
            <div class="flex justify-between bg-tier3 opacity-70 rounded-lg px-2 py-1">
              <span>Tier 3</span><span class="font-bold">{{ tier_stats.total.tier3 or 0 }}</span>
            </div>
            <div class="flex justify-between bg-tier4 opacity-70 rounded-lg px-2 py-1">
              <span>Tier 4</span><span class="font-bold">{{ tier_stats.total.tier4 or 0 }}</span>
            </div>
          </div>
        </div>

        <!-- ASSAY-SPECIFIC -->
        {% if tier_stats.by_assay %}
        <div class="pt-3 border-t border-gray-200">
          <div class="text-sm font-semibold text-gray-800 mb-2">
            Assay-specific
            {% if assays %}
              <span class="font-normal text-gray-500">(selected assays)</span>
            {% endif %}
          </div>

          <div class="space-y-2">
            {% for assay, stats in tier_stats.by_assay.items() %}
              <div class="border border-gray-200 rounded-xl p-3 bg-gray-50">
                <div class="text-sm font-semibold text-gray-900 mb-2">{{ assay }}</div>
                <div class="grid grid-cols-4 gap-2 text-xs font-semibold">
                  <div class="items-center align-center px-3 py-1 font-semibold rounded-full text-center opacity-70 bg-tier1">
                    <div>T1</div>
                    <div class="font-bold">{{ stats.tier1 }}</div>
                  </div>
                  <div class="items-center align-center px-3 py-1 font-semibold rounded-full text-center opacity-70 bg-tier2">
                    <div>T2</div>
                    <div class="font-bold">{{ stats.tier2 }}</div>
                  </div>
                  <div class="items-center align-center px-3 py-1 font-semibold rounded-full text-center opacity-70 bg-tier3">
                    <div>T3</div>
                    <div class="font-bold">{{ stats.tier3 }}</div>
                  </div>
                  <div class="items-center align-center px-3 py-1 font-semibold rounded-full text-center opacity-70 bg-tier4">
                    <div>T4</div>
                    <div class="font-bold">{{ stats.tier4 }}</div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </aside>


</div>

<script>
  const input = document.getElementById('search-input');
  const body = document.getElementById('tiered-variants-list-table-body');
  const container = document.getElementById('tiered-variants-list');
  const rowsPerPage = parseInt(container.dataset.rowsPerPage) || 15;
  const originalRows = [...body.querySelectorAll('tr')].map(r => r.cloneNode(true));
  const id = body.id;

  input.addEventListener('input', () => {
    const term = input.value.toLowerCase().trim();

    // Remove any existing pagination controls
    container.querySelectorAll('[data-prev], [data-next], [data-page-info]').forEach(el => el.parentElement?.remove());

    // Filter rows or reset
    const filtered = term
      ? originalRows.filter(row => row.textContent.toLowerCase().includes(term))
      : originalRows;

    // Replace table body with filtered or full rows
    body.innerHTML = '';
    filtered.forEach(row => body.appendChild(row));

    // Trigger pagination if needed
    filtered.length > rowsPerPage ? initializePagination() : displayPage(1, id, rowsPerPage);
  });

  (function () {
    const details = document.getElementById("tiered-mode-dd");
    const labelSpan = document.getElementById("tiered-mode-label");
    if (!details || !labelSpan) return;

    // Close when clicking outside
    document.addEventListener("click", (e) => {
      if (details.open && !details.contains(e.target)) {
        details.open = false;
      }
    });

    // Close when selecting an option + update summary label
    details.addEventListener("change", (e) => {
      const input = e.target;
      if (input && input.matches('input[type="radio"]')) {
        const optionLabel = input.closest("label")?.querySelector("span")?.textContent?.trim();
        if (optionLabel) labelSpan.textContent = optionLabel;
        details.open = false;
      }
    });

    // Optional: close on Escape
    details.addEventListener("keydown", (e) => {
      if (e.key === "Escape") details.open = false;
    });
  })();
</script>
{% endblock %}
