{% extends "layout.html" %}

{% block body %}


{% set sel_csq = variant.INFO.selected_CSQ %}
{% set ns = namespace(alternate_transcripts=0) %}
{% set genomic_change =  variant.CHROM ~ ":" ~ variant.POS ~ ", " ~  variant.REF ~ "/" ~ variant.ALT %}
{% set indel_size = variant.ALT|length - variant.REF|length %}
{% set subfolder = {'dir': "None"} %}
{% set alt_class = variant.additional_classification %}
{% set consequences = sel_csq.Consequence if sel_csq.Consequence is iterable and sel_csq.Consequence is not string else sel_csq.Consequence.split('&') %}
{% set all_samples_bam_paths = [] %}

{# Collect all BAM paths #}
{% for sample_id, bam_paths in bam_id.items() %}
  {% for path in bam_paths %}
    {% set list1 = path.split('/') %}
    {% if subfolder.update({ 'dir': list1[0] }) %} {% endif %}
    {% set _ = all_samples_bam_paths.append("/R:" ~ path) %}
  {% endfor %}
{% endfor %}

{# Append design BED file if available #}
{# Creating design_bed_url as well #}
{% if subfolder.dir != "None" and subfolder.dir != "tumwgs" %}
  {% set design_bed = "http://localhost:60151/load?file=/R:" ~ subfolder.dir ~ "/BED/design.bed"  %}
  {% set design_bed_url = '<a href="' ~ design_bed ~ '" class="text-blue-600 underline">' ~ "open" ~ '</a>'%}
  {% set _ = all_samples_bam_paths.append("/R:" ~ subfolder.dir ~ "/BED/design.bed") %}
{% else %}
  {% set design_bed_url = '-' %}
{% endif %}

{# Build the final IGV URL #}
{% if all_samples_bam_paths and has_access("view_igv", min_role="user", min_level=9) %}
  {% set igv_url = "http://localhost:60151/load?file=" ~ all_samples_bam_paths | join(',') ~ "&locus=" ~ variant.CHROM ~ ":" ~ variant.POS %}
  {% set igv_genomic_position = '<a href="' ~ igv_url ~ '" class="text-blue-600 underline">' ~ genomic_change ~ '</a>' %}
{% else %}
  {% set igv_url = none %}
  {% set igv_genomic_position = genomic_change %}
{% endif %}

{# variant to display on the main top card #}
{% if sel_csq.HGVSp %}
  {% set show_variant = sel_csq.HGVSp | one_letter_p | unesc %}
{% elif sel_csq.HGVSc %}
  {% set show_variant = sel_csq.HGVSc %}
{% else %}
  {% set show_variant = "g." ~ genomic_change %}
{% endif %}

{# check permissions for the tier #}
{% set dna_tier_disabled = not has_access('tier_dna_variant', min_role='manager', min_level=99) %}
{% set dna_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if dna_tier_disabled else "" %}
{% set dna_tier_disabled_attr = "disabled" if dna_tier_disabled else "" %}

{# check permissions for remove variant tier #}
{% set can_remove_tier = has_access('remove_dna_variant_tier', min_role='manager', min_level=99) %}
{% set can_remove_global_tier = has_access('remove_dna_variant_tier_global', min_role='admin') %}
{% set remove_tier_disabled = not can_remove_tier %}
{% set remove_global_tier_disabled = not can_remove_global_tier %}
{% set remove_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if remove_tier_disabled else "" %}
{% set remove_global_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if remove_global_tier_disabled else "" %}
{% set remove_tier_attr = "disabled" if remove_tier_disabled else "" %}
{% set remove_global_tier_attr = "disabled" if remove_global_tier_disabled else "" %}

{# check permissions for dna variant actions buttons #}
{% set variant_actions_disabled = not has_access('manage_snvs', min_role='user', min_level=9) %}
{% set variant_actions_class = "opacity-70 select-none cursor-not-allowed pointer-events-none" if variant_actions_disabled else "" %}
{% set variant_actions_attr = "disabled" if variant_actions_disabled else "" %}



<div class="flex w-full h-full overflow-hidden ">

  <!-- Variant Wall left side bar -->
  <aside class="w-80 bg-transparent text-black flex flex-col overflow-y-auto shadow-lg rounded-lg mr-2 ml-1 left-0 h-full border-r-2 border-t-2 border-brown-400">

    <!-- Variant Wall -->
    <div class="flex justify-center items-center bg-gradient-to-b from-brown-300 to-brown-200 py-2 rounded-t-md shadow-lg">
      <img src="{{ url_for('static', filename='icons/heroicons_outline_24/bookmark.svg') }}" alt="Tag Icon" class="w-4 h-4 mr-2 opacity-80">
      <h2 class="text-sm font-semibold capitalize tracking-wide text-black">Variant Wall</h2>
    </div>

    <!-- Table Container -->
    <div class="overflow-auto shadow-lg bg-transparent p-0">
      <table class="table-auto bg-blue-50 w-full text-xs text-black border-collapse">
        <tbody class="break-all">
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Gene</th>
            <td class="p-1 text-right font-medium"><a href="{{ url_for('dna_bp.gene_view_simple', gene_name=sel_csq.SYMBOL) }}" class="text-blue-600 underline">{{ sel_csq.SYMBOL }}</a></td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Variant Class</th>
            <td class="p-1 text-right font-medium">
              {% if variant.variant_class in vep_var_class_translations %}
                <span class="relative inline-block cursor-pointer" onmouseover="showTooltip(event, `{{ vep_var_class_translations[variant.variant_class].desc | escape }}`)">{{ vep_var_class_translations[variant.variant_class].short }}</span>
              {% else %}
                {{ variant.variant_class }}
              {% endif %}
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2 break-all">Canonical Transcript</th>
            <td class="p-1 text-right font-medium">{{ sel_csq.Feature }}</td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2 break-all">cDNA</th>
            <td class="p-1 text-right font-medium ">
              <span class="relative cursor-pointer" onmouseover="showTooltip(event, `<span class='break-all inline-flex'>{{ sel_csq.HGVSc|unesc|safe }}</span>`)">
                <div class="relative flex flex-wrap justify-end inline-block pr-1">
                  <div id="hgvsc-short" class="truncate max-w-15c">
                    {{ sel_csq.HGVSc|unesc|safe }}
                  </div>
                  <div id="hgvsc-full" class="hidden break-all whitespace-normal">
                    {{ sel_csq.HGVSc|unesc|safe }}
                  </div>
                  <button class="ml-1 text-toggle hidden hover:text-blue-500 font-bold transition-transform duration-100 transform hover:scale-105"
                          data-target="hgvsc"
                          onclick="toggleLongText(this)">
                    [+]
                  </button>
                </div>
              </span>
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2 break-all">Protein</th>
            <td class="p-1 text-right font-medium">
              <span class="relative cursor-pointer" onmouseover="showTooltip(event, `<span class='break-all inline-flex'>{{ sel_csq.HGVSp|unesc|safe }}</span>`)">
                <div class="relative flex flex-wrap justify-end inline-block pr-1">
                  <div id="hgvsp-short" class="truncate max-w-15c">
                    {{ sel_csq.HGVSp }}
                  </div>
                  <div id="hgvsp-full" class="hidden break-all whitespace-normal">
                    {{ sel_csq.HGVSp|unesc|safe }}
                  </div>
                  <button class="ml-1 text-toggle hidden hover:text-blue-500 font-bold transition-transform duration-100 transform hover:scale-105"
                          data-target="hgvsp"
                          onclick="toggleLongText(this)">
                    [+]
                  </button>
                </div>
              </span>
            </td>
          </tr>
          {% if indel_size != 0 %}
            <tr class="hover:bg-brown-100 shadow-md rounded-lg">
              <th class="p-1 font-semibold text-left w-1/2 break-all">Indel Size</th>
              <td class="p-1 text-right font-medium">{{ indel_size }} bp {% if indel_size < 0 %}DEL{% else %}INS{% endif %}</td>
            </tr>
          {% endif %}
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Consequence</th>
            <td class="py-1 px-1 text-right font-medium">
              {% for conseq in consequences %}
                <div class="inline-block mb-1 py-1 cursor-pointer rounded-full bg-gray-300"
                  onmouseover="showTooltip(event, `{% if conseq in vep_conseq_translations %}
                    <strong>{{ vep_conseq_translations[conseq].display }}</strong><br>
                    {{ vep_conseq_translations[conseq].desc }}<br>
                    <span class='text-yellow-400 font-bold'>Impact: {{ vep_conseq_translations[conseq].impact }}</span>
                  {% else %}
                    {{ conseq }}
                  {% endif %}`)">
                  {% if conseq in vep_conseq_translations %}
                      {{ vep_conseq_translations[conseq].short }}
                  {% else %}
                    {{ conseq }}
                  {% endif %}
                </div>
              {% endfor %}
            </td>
          </tr>
          {% if sel_csq.EXON|length > 0 %}
            <tr class="hover:bg-brown-100 shadow-md rounded-lg">
              <th class="p-1 font-semibold text-left w-1/2">Exon</th>
              <td class="p-1 text-right font-medium">{{ sel_csq.EXON }}</td>
            </tr>
          {% endif %}
          {% if sel_csq.INTRON|length > 0 %}
            <tr class="hover:bg-brown-100 shadow-md rounded-lg">
              <th class="p-1 font-semibold text-left w-1/2">Intron</th>
              <td class="p-1 text-right font-medium">{{ sel_csq.INTRON }}</td>
            </tr>
          {% endif %}
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Genomic Position</th>
            <td class="p-1 text-right font-medium truncate" style="max-width: 15ch">
              <span class="relative cursor-pointer" onmouseover="showTooltip(event, `<span class='break-all inline-flex'>{{ genomic_change }}</span>`)">
                <div class="relative flex flex-wrap justify-end inline-block pr-1">
                  <div id="genomic-change-short" class="truncate max-w-15c">
                    {{ igv_genomic_position|safe }}
                  </div>
                
                  <div id="genomic-change-full" class="hidden break-all whitespace-normal">
                    {{ igv_genomic_position|safe }}
                  </div>
                
                  <button class="ml-1 text-toggle hidden hover:text-blue-500 font-bold transition-transform duration-100 transform hover:scale-105"
                          data-target="genomic-change"
                          onclick="toggleLongText(this)">
                    [+]
                  </button>
                </div>
              </span>
            </td>
          </tr>
          {% for gt in variant.GT %}
            <tr class="hover:bg-brown-100 shadow-md rounded-lg">
              <th class="p-1 font-semibold text-left w-1/2 capitalize">{{gt.type}} VAF</th>
              <td class="p-1 text-right font-medium">{{'%0.1f'| format(100*gt.AF|float) }}% ({{ gt.VD|int }} / {{ gt.DP|int }})</td>
            </tr>
          {% endfor %}
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">CADD</th>
            <td class="p-1 text-right font-medium">
              {% if sel_csq.CADD_PHRED %}
                {{ sel_csq.CADD_PHRED }}
              {%else %}
                -
              {% endif %}
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">SIFT</th> <!-- TODO: Color this based the score -->
            <td class="p-1 text-right font-medium break-all">
              {% if sel_csq.SIFT %}
                {{ sel_csq.SIFT }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Polyphen</th> <!-- TODO: Color this based the score -->
            <td class="p-1 text-right font-medium break-all">
              {% if sel_csq.PolyPhen %}
                {{ sel_csq.PolyPhen }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">dbSNP</th>
            <td class="p-1 text-right font-medium">
              {%if variant.dbsnp_id %}
                <a target="_blank" href="https://www.ncbi.nlm.nih.gov/snp/{{ variant.dbsnp_id }}" class="text-blue-600 underline">{{ variant.dbsnp_id }}</a>
              {% else %}
                -
              {%endif%}
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">COSMIC</th>
            <td class="p-1 text-right font-medium">
              {% if variant.cosmic_ids %}
                {% for cosm_id in variant.cosmic_ids %}
                  <a target="_blank" href="https://cancer.sanger.ac.uk/cosmic/search?q={{ cosm_id }}" class="text-blue-600 underline">{{ cosm_id }}</a><br>
                {% endfor %}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">ClinVar</th>
            <td class="p-1 text-right font-medium">{{ sel_csq.CLIN_SIG|default('')|multirow|safe }}</td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">cBioPortal</th>
            <td class="p-1 text-right font-medium">
              <a target="_blank" href="http://www.cbioportal.org/ln?q={{sel_csq.SYMBOL}}" class="text-blue-600 underline">
                {{sel_csq.SYMBOL}}
              </a>
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">OnkoKB</th>
            <td class="p-1 text-right font-medium">
              <a target="_blank" href="http://oncokb.org/#/gene/{{sel_csq.SYMBOL}}" class="text-blue-600 underline">
                {{sel_csq.SYMBOL}}
              </a>
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">LitVar</th>
            <td class="p-1 text-right font-medium">
              {% if variant.dbsnp_id %}
                <a target="_blank" href="https://www.ncbi.nlm.nih.gov/CBBresearch/Lu/Demo/LitVar/#!?query={{ variant.dbsnp_id }}" class="text-blue-600 underline">
                  {{ variant.dbsnp_id }}
                </a>
              {% else %}
                -
              {% endif %}  
            </td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Alamut</th>
            <td class="p-1 text-right font-medium">
              {% if variant.dbsnp_id %}
                <a target="_blank" href="http://localhost:10000/show?request={{variant.CHROM}}:{{variant.POS}}{{variant.REF}}&gt;{{variant.ALT}}" class="text-blue-600 underline">open</a>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% if assay == "tumwgs" or assay == "fusion" %}
          {% else %}
            <tr class="hover:bg-brown-100 shadow-md rounded-lg">
              <th class="p-1 font-semibold text-left w-1/2">Design Bed</th>
              <td class="p-1 text-right font-medium">
                {{design_bed_url|safe}}
              </td>
            </tr>
          {% endif %}          
        </tbody>
      </table>
    </div>

  </aside>

  <main class="flex-1 bg-transparent overflow-y-auto py-2 px-1 flex flex-col">

    <!-- sample info -->
    {% include "sample_meta_info.html" %}

    <!-- Gene:Transcript:Variant Main Info banner -->
    <section class="bg-gray-100 p-2 my-2 flex flex-wrap justify-between w-full shadow-lg rounded-xl relative gap-2 z-0 border-l-8 border-r-8 border-purple-400 whitespace-normal break-all" id="variant-info">
      <!-- Variant Info Left Section -->
      <div class="flex flex-col ml-2 mr-4">
        <h2 class="text-base font-bold">
          {{ sel_csq.SYMBOL }} ({{ sel_csq.Feature }}): 
          {% if igv_url %}
            <a href="{{ igv_url }}" class="text-black underline"> {{ show_variant }} </a>
          {% else %}
            {{ show_variant }}
          {% endif %}
        </h2>
        <p class="text-sm font-normal py-1 my-1">
          Called by: {{ variant.INFO.variant_callers|join(', ') }}
        </p>
      </div>

      <!-- Right Section Tier info --> <!-- Change this with tooltip -->
      <div class="flex flex-col text-right ml-2 mr-4 overflow-x-auto">
        <h2 class="text-base font-bold pb-1">
          Classify Variant
        </h2>
        <div class="flex flex-wrap items-center justify-end">
          <!-- Tier Buttons -->
          <form action="{{ url_for('dna_bp.classify_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
            <input type="hidden" name="assay" value="{{ assay }}">
            <input type="hidden" name="subpanel" value="{{ subpanel }}">
            <input type="hidden" name="var_g" value="{{ variant.CHROM }}:{{ variant.POS }}:{{ variant.REF }}/{{ variant.ALT }}">
            {% if sel_csq.HGVSc is defined %}
              <input type="hidden" name="gene" value="{{ sel_csq.SYMBOL }}">
              <input type="hidden" name="transcript" value="{{ sel_csq.Feature }}">
              <input type="hidden" name="var_p" value="{{ sel_csq.HGVSp|unesc }}">
              <input type="hidden" name="var_c" value="{{ sel_csq.HGVSc|unesc }}">
            {% endif %}
            <input
            class="m-1 text-black text-sm px-2 py-1 rounded-md shadow-lg whitespace-normal break-all
                    {% if classification.class != 1 %}
                      bg-gray-300 transition-all duration-300 ease-in-out transform hover:translate-y-1 hover:bg-orange-500
                    {% else %}
                      cursor-not-allowed font-bold text-white bg-tier{{ classification.class }}
                    {% endif %}
                    {{ dna_tier_classes }}"
            id="tier1"
            type="submit"
            value="Tier I"
            name="tier1"
            title="Tier I: Strong Clinical Significance"
            {{ dna_tier_disabled_attr }}
          />

          <input
          class="m-1 text-black text-sm px-2 py-1 rounded-md shadow-lg whitespace-normal break-all
                  {% if classification.class != 2 %}
                    bg-gray-300 hover:bg-yellow-400 transition-all duration-300 ease-in-out transform hover:translate-y-1
                  {% else %}
                    cursor-not-allowed font-bold text-white bg-tier{{ classification.class }}
                  {% endif %}
                  {{ dna_tier_classes }}"
          id="tier2"
          type="submit"
          name="tier2"
          value="Tier II"
          title="Tier II: Potential Clinical Significance"
          {{ dna_tier_disabled_attr }}
        />
        
        <input
          class="m-1 text-black text-sm px-2 py-1 rounded-md shadow-lg whitespace-normal break-all
                  {% if classification.class != 3 %}
                    bg-gray-300 hover:bg-blue-500 transition-all duration-300 ease-in-out transform hover:translate-y-1
                  {% else %}
                    cursor-not-allowed font-bold text-white bg-tier{{ classification.class }}
                  {% endif %}
                  {{ dna_tier_classes }}"
          id="tier3"
          type="submit"
          name="tier3"
          value="Tier III"
          title="Tier III: Unknown Clinical Significance"
          {{ dna_tier_disabled_attr }}
        />
        
        <input
          class="m-1 text-black text-sm px-2 py-1 rounded-md shadow-lg whitespace-normal break-all
                  {% if classification.class != 4 %}
                    bg-gray-300 hover:bg-green-600 transition-all duration-300 ease-in-out transform hover:translate-y-1
                  {% else %}
                    cursor-not-allowed font-bold text-white bg-tier{{ classification.class }}
                  {% endif %}
                  {{ dna_tier_classes }}"
          id="tier4"
          type="submit"
          name="tier4"
          value="Tier IV"
          title="Tier IV: Benign"
          {{ dna_tier_disabled_attr }}
        />
        
          </form>

          <!-- Remove Tier Info -->
          {% if classification.class != 999 %}
            <form action="{{ url_for('dna_bp.remove_classified_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input type="hidden" name="assay" value="{{ assay }}">
              <input type="hidden" name="subpanel" value="{{ subpanel }}">
              <input type="hidden" name="var_g" value="{{ variant.CHROM }}:{{ variant.POS }}:{{ variant.REF }}/{{ variant.ALT }}">
              {% if sel_csq.HGVSc is defined %}
                <input type="hidden" name="gene" value="{{ sel_csq.SYMBOL }}">
                <input type="hidden" name="transcript" value="{{ sel_csq.Feature }}">
                <input type="hidden" name="var_p" value="{{ sel_csq.HGVSp|unesc }}">
                <input type="hidden" name="var_c" value="{{ sel_csq.HGVSc|unesc }}">
              {% endif %}
              {% if classification and 'assay' in classification %}
              <input
                class="m-1 bg-gray-300 text-black text-sm px-2 py-1 rounded-md shadow-lg cursor-pointer hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:translate-y-1 whitespace-normal break-all {{ remove_tier_classes }}"
                title="Remove {{ assay }} classifications"
                id="remove"
                type="submit"
                value="❌ Tier"
                onclick="return confirm('This will remove all tiering for {{ assay }}, proceed?')"
                {{ remove_tier_attr }}
              >
            {% elif current_user.is_admin %}
              <input
                class="m-1 bg-gray-300 text-black text-sm px-2 py-1 rounded-md shadow-lg cursor-pointer hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:translate-y-1 whitespace-normal break-all {{ remove_global_tier_classes }}"
                title="Remove historic non-assay classifications"
                id="remove"
                type="submit"
                value="❌ Tier"
                onclick="return confirm('This will remove all historic tiering without any assays assigned, proceed?')"
                {{ remove_global_tier_attr }}
              >
            {% endif %}            
            </form>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Top buttons for links and actions -->
    <section class="relative gap-2 z-0 mt-2 ml-1 bg-gray-100 py-1 shadow-lg rounded-xl border-l-8 border-r-8 border-blue-400" id="variant-actions-buttons">
      <div class="flex flex-wrap items-start justify-end ml-auto mr-4 gap-2">
        <div class="relative">
          <div class="absolute top-0 left-0 w-full h-1 bg-yellow-400 break-all"></div>
          {% if variant.fp == true %}
            <form action="{{ url_for('dna_bp.unmark_false_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-yellow-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-gray-200 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_fp" value="Unmark False Positive" {{ variant_actions_attr }}>
            </form>
          {% else %}
            <form action="{{ url_for('dna_bp.mark_false_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-gray-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-yellow-100 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_fp" value="Mark as False Positive" {{ variant_actions_attr }}>
            </form>
          {% endif %}
        </div>
        <div class="relative">
          <div class="absolute top-0 left-0 w-full h-1 bg-green-400"></div>
          {% if variant.interesting == true %}
            <form action="{{ url_for('dna_bp.unmark_interesting_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-green-200 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-gray-200 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_int" value="Unmark Interesting" {{ variant_actions_attr }}>
            </form>
          {% else %}
            <form action="{{ url_for('dna_bp.mark_interesting_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-gray-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-green-100 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_int" value="Mark as Interesting" {{ variant_actions_attr }}>
            </form>
          {% endif %}
        </div>
        <div class="relative">
          <div class="absolute top-0 left-0 w-full h-1 bg-brown-500"></div>
          {% if variant.irrelevant == true %}
            <form action="{{ url_for('dna_bp.unmark_irrelevant_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-brown-200 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-gray-200 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_irr" value="Unmark Irrelevant" {{ variant_actions_attr }}>
            </form>
          {% else %}
            <form action="{{ url_for('dna_bp.mark_irrelevant_variant', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-gray-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-brown-100 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_irr" value="Mark as Irrelevant" {{ variant_actions_attr }}>
            </form>
          {% endif %}
        </div>
        <div class="relative">
          <div class="absolute top-0 left-0 w-full h-1 bg-orange-500"></div>
          {% if variant.blacklist != true %}
            <form action="{{ url_for('dna_bp.add_variant_to_blacklist', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-gray-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-orange-100 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="blacklist" value="Add to Blacklist" onclick="return confirm('This will affect all samples of this type. Proceed?')" {{ variant_actions_attr }}>
            </form>
          {% endif %}
        </div>
        <div class="relative">
          <div class="absolute top-0 left-0 w-full h-1 bg-purple-500"></div>
          {% if variant.blacklist is defined and variant.override_blacklist != true %}
            <form action="{{ url_for('dna_bp.add_variant_to_blacklist', sample_id=sample.name, var_id=variant._id) }}" method="post">
              <input class="relative bg-purple-200 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-gray-200 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="blacklist" value="Override Blacklist" {{ variant_actions_attr }}>
            </form>
          {% endif %}
        </div>
      </div>
    </section> 

    <!-- other information cards -->
    <section class="bg-transparent p-2 my-2 flex flex-wrap items-start relative gap-4" id="snv-information-cards">
      <!-- Comment box, other tiering and pon -->
      <div class="flex flex-col gap-y-4 min-w-450 max-w-xl">
        <!-- Comment box -->
        {% if has_access("add_variant_comment", min_role="user", min_level=9) %}
          <div class="bg-transparent min-w-400 w-full max-w-xl" id="commenting-box-card">
            <h2 class="text-sm font-semibold bg-gradient-to-b from-indigo-400 to-indigo-200 p-2 shadow-md rounded-t-lg break-all">Add new comment/annotation</h2>
            <div id="commenting_box" class="rounded-b-lg border border-gray-400 shadow-md p-2 overflow-x-auto">
              <form action="{{ url_for('dna_bp.add_variant_comment', var_id=variant._id, sample_id=sample.name) }}" method="post">
                <textarea id="comment_textarea" name="text" placeholder="Enter variant comment/annotation..." class="h-40 w-full p-2 border border-gray-300 rounded-lg focus:bg-yellow-50 mb-4"></textarea><br>
                {% if sel_csq.HGVSc is defined %}
                  <input type="hidden" name="gene" value="{{ sel_csq.SYMBOL }}">      
                  <input type="hidden" name="transcript" value="{{ sel_csq.Feature }}">
                  <input type="hidden" name="var_p" value="{{ sel_csq.HGVSp|unesc }}">
                  <input type="hidden" name="var_c" value="{{ sel_csq.HGVSc|unesc}}">
                {% endif %}
                <input type="hidden" name="var_g" value="{{ variant.CHROM }}:{{ variant.POS }}:{{ variant.REF }}/{{ variant.ALT }}">
                <input type="submit" value="Save" class="bg-blue-500 text-white py-1 px-2 mx-1 mb-1 rounded-lg cursor-pointer shadow-md">&nbsp;&nbsp;
                {% if has_access("add_global_variant_comment", min_role="admin") %}
                  <label class="items-center">
                    <input type="checkbox" name="global" value="global" class="form-checkbox text-blue-500">
                    <span class="ml-2">Use as global annotation</span>
                  </label>
                {% endif %}
                <input type="hidden" name="assay" value="{{ assay }}">
                <input type="hidden" name="subpanel" value="{{ subpanel }}">
              </form>
            </div>
          </div>
        {% endif %}

        <!-- Other Tiering Information -->
        <div class="bg-gray-50 max-w-xl w-full shadow-md rounded-lg mb-1 pagination" data-rows-per-page="2" pagination-button-color="orange" pagination-button-text-color="black" id="other-tiering-info">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-orange-400 to-orange-200 p-2 shadow-md rounded-t-lg break-all">Other Tiering</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if other_classifications %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-orange-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold ">Assay</th>
                    <th class="p-3 font-semibold ">Diagnosis</th>
                    <th class="p-3 font-semibold ">Tier</th>
                  </tr>
                </thead>
                <tbody>
                <tbody id="other-tiering-info-body" class="{% if other_classifications|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for var in other_classifications %}
                    <tr class="hover:bg-orange-50 border-t border-gray-400 text-left align-top">
                      <td class="p-2 font-medium">{{var.assay}}</td>
                      <td class="p-2">
                        {% if "subpanel" in var %}
                          {{ var.subpanel }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="p-2">{{var.class}}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-orange-50 break-all">Other tiering information is not available</em>
            {% endif %}
          </div>
        </div>

        <!-- Panel of Normals -->
        <div class="bg-gray-50 max-w-xl w-full shadow-md rounded-lg mb-1" id="panel-of-normals">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-brown-400 to-brown-200 p-2 shadow-md rounded-t-lg break-all">Panel of Normals</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if pon is not none and pon|length > 0 %}
              <table class="w-full max-w-xl text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-brown-200">
                  <tr class="border-b text-left border-gray-800">
                    <th class="px-1 py-2 font-semibold w-1/6">Variant caller</th>
                    <th class="px-1 py-2 font-semibold w-1/6"># detected</th>
                    <th class="px-1 py-2 font-semibold w-4/6">Variant Frequencies</th>
                  </tr>
                </thead>
                <tbody id="panel-of-normals-body" class="{% if pon|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for vc in pon %}
                    <tr class="hover:bg-brown-50 border-t border-gray-400 text-left align-top">
                      <td class="p-2">{{ vc }}</td>
                      <td class="p-2">{{ pon[vc].NUM }}</td>
                      <td class="p-2">
                        {% for vaf in (pon[vc].VAFS|string).split(",") %}
                        <div class=" inline-block mb-1 cursor-pointer p-1 rounded-full bg-gray-300">
                          <span class="ponfreq">{{'%0.1f'| format(100*vaf|float) }}%</span>
                        </div>
                        {% endfor %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-brown-50 break-all">No Panel of Normals information available.</em>
            {% endif %}
          </div>
        </div>

        <!-- Variant in Other Sample Data -->
        <div class="bg-gray-50 max-w-xl w-full shadow-md rounded-lg mb-1" id="variant-in-other-sample-data">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-blue-400 to-blue-200 p-2 shadow-md rounded-t-lg break-all">Variant in Other Samples</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if in_other %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-blue-200">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold">Sample</th>
                    <th class="p-3 font-semibold">Assay</th>
                    <th class="p-3 font-semibold">Depth</th>
                    <th class="p-3 font-semibold">VAF</th>
                    <th class="p-3 font-semibold">Marked</th>
                  </tr>
                </thead>
                <tbody id="variant-in-other-sample-data-body" class="{% if in_other|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for doc in in_other %}
                    {% set clean_sample = doc.sample_name.split('p')[0] %}
                    {% set sample_gt = doc.GT | selectattr("sample", "equalto", clean_sample) | first %}
                    <tr class="hover:bg-blue-50 border-t border-gray-400 text-left align-top">
                      <td class="p-2">
                          <a href="{{ url_for('dna_bp.list_variants', sample_id=doc.sample_name) }}" class="text-blue-500 hover:underline">
                            {{ doc.sample_name }}
                          </a>
                      </td>
                      <td class="p-2">
                        {% for group in doc.groups %}
                          <div class="inline-block mb-1 cursor-pointer p-1 rounded-full bg-gray-300">
                            <span>{{ assay_group_mappings[group] }}</span>
                          </div>
                        {% endfor %}
                      </td>
                      <td class="p-2">
                        {% if sample_gt %}
                          {{sample_gt.VD}}/{{sample_gt.DP}}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="p-2">
                        {% if sample_gt %}
                          <div class="inline-block mb-1 cursor-pointer p-1 rounded-full bg-gray-300">
                            <span>{{ '%0.1f' | format(sample_gt.AF | float * 100) }}%</span>
                          </div>
                        {% endif %}
                      </td>
                      <td class="p-2 text-center align-middle">
                        <div class="flex items-center gap-2 justify-center h-full">
                          {% if doc.fp == true %}
                          <span class="relative inline-block cursor-pointer font-bold" onmouseover="showTooltip(event, `<span class='text-red-400 '>Variant marked as false positive</span>`)">
                            <img class="w-4 h-4" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-circle.svg') }}">
                          </span>
                          {% endif %}
                          {% if doc.interesting == True %}
                            <span class="relative inline-block cursor-pointer"
                              onmouseover="showTooltip(event, `<span class='text-green-400'>Variant marked as interesting</span>`)">
                              <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/exclamation-circle.svg') }}">
                          </span>
                          {% endif %}
                          {% if doc.irrelevant == True %}
                            <span class="relative inline-block cursor-pointer font-bold"
                              onmouseover="showTooltip(event, `<span class='text-yellow-400'>Variant marked as irrelevant</span>`)">
                              <img class="w-4 h-4" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-mark.svg') }}">
                            </span>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-blue-50 break-all">Variant is not found in other samples.</em>
            {% endif %}
          </div>
        </div>

        <!-- Alternate Transcripts Information -->
        <div class="bg-gray-50 w-full max-w-xl shadow-md rounded-lg mb-1" id="alternate-transcripts-info">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-purple-400 to-purple-200 p-2 shadow-md rounded-t-lg break-all">Alternate Transcripts             
            {% if assay == "swea" or assay == "gmsonco" %}
              <a href="javascript:void(0)" onclick="switchVisibility_noncanonicaltranscripts('noncanonical_transcript')" class="text-blue-600 hover:underline">
                Show/hide
              </a>
            {% endif %}
          </h2>
          <div class="rounded-b-lg overflow-x-auto">
            <table class="w-full max-w-xl text-xs text-gray-800 mx-auto">
              <thead class="capitalize tracking-wide rounded-t-lg bg-purple-200">
                <tr class="border-b text-left border-gray-800">
                  <th class="px-1 py-2 font-semibold">Gene</th>
                  <th class="px-1 py-2 font-semibold">Transcript</th>
                  <th class="px-1 py-2 font-semibold">Exon</th>
                  <th class="px-1 py-2 font-semibold">Protein Change</th>
                  <th class="px-1 py-2 font-semibold">CDS Change</th>
                  <th class="px-1 py-2 font-semibold">Tier</th>
                </tr>
              </thead>
              <tbody id="alternate-transcripts-info-body" class="{% if variant.INFO.CSQ|length > 1 %}border-b border-gray-400 {% endif %}">
                {% for csq in variant.INFO.CSQ %}
                  {% if csq.BIOTYPE == "protein_coding" and (csq.HGVSp|length > 0 or csq.HGVSc|length > 0) %}
                    {% set ns.alternate_transcripts = loop.index %}
                    {% if csq.Feature == sel_csq.Feature %}
                      <tr class="bg-purple-100 hover:bg-green-100 border-t border-gray-400 text-left align-top">
                    {% else %}
                      <tr {% if assay == "swea" or assay == "gmsonco" %}class="noncanonical_transcript visibility-collapsed border-t border-gray-400 text-left align-top"{% else %}class="hover:bg-purple-50 border-t border-gray-400 text-left align-top"{% endif %}>
                    {% endif %}
                    <td class="p-2">{{ csq.SYMBOL }}</td>
                    <td class="p-2">{{ csq.Feature }}</td>
                    <td class="p-2">{{ csq.EXON }}</td>
                    <td class="p-2 ">
                      <span class="relative cursor-pointer" onmouseover="showTooltip(event, `<span class='break-all inline-flex'>{{ csq.HGVSp|unesc|safe }}</span>`)">
                        <div class="relative flex inline-block">
                          <div id="{{csq.Feature}}-hgvsp-short" class="truncate max-w-15c">
                            {{ csq.HGVSp|unesc|safe }}
                          </div>
                          <div id="{{csq.Feature}}-hgvsp-full" class="hidden break-all whitespace-normal">
                            {{ csq.HGVSp|unesc|safe }}
                          </div>
                          <button class="ml-1 text-toggle hidden hover:text-blue-500 font-bold transition-transform duration-100 transform hover:scale-105"
                                  data-target="{{csq.Feature}}-hgvsp"
                                  onclick="toggleLongText(this)">
                            [+]
                          </button>
                        </div>
                      </span>
                    </td>
                    <td class="p-2">
                      <span class="relative cursor-pointer" onmouseover="showTooltip(event, `<span class='break-all inline-flex'>{{ csq.HGVSc|unesc|safe }}</span>`)">
                        <div class="relative flex inline-block">
                          <div id="{{csq.Feature}}-hgvsc-short" class="truncate max-w-15c">
                            {{ csq.HGVSc|unesc|safe }}
                          </div>
                          <div id="{{csq.Feature}}-hgvsc-full" class="hidden break-all whitespace-normal">
                            {{ csq.HGVSc|unesc|safe }}
                          </div>
                          <button class="ml-1 text-toggle hidden hover:text-blue-500 font-bold transition-transform duration-100 transform hover:scale-105"
                                  data-target="{{csq.Feature}}-hgvsc"
                                  onclick="toggleLongText(this)">
                            [+]
                          </button>
                        </div>
                      </span>
                    </td>
                    <td class="p-2">
                      {% if alt_class and csq.Feature == alt_class.transcript and (csq.HGVSc == alt_class.variant or csq.HGVSp == alt_class.variant) %}
                        <div class="inline-block px-2 py-1 text-xs font-bold text-white rounded-full bg-gray-400">
                          {{ alt_class.class }}
                        </div>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
            {% if ns.alternate_transcripts == 0 %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md break-all">No alternate transcripts available.</em>
            {% endif %}
          </div>
        </div>

      </div>

      <div class="flex flex-col gap-y-4 max-w-xl items-start">
        <!-- Variant annotations (All) -->
        {% if has_access('view_global_variant_comment', min_role='user', min_level=9) %}
          <div class="bg-gray-50 w-full max-w-xl pagination shadow-md rounded-lg mb-1" data-rows-per-page="2" pagination-button-color="green" pagination-button-text-color="black" id="variant-annotations-all">
            <h2 class="text-sm font-semibold bg-gradient-to-b from-green-400 to-green-200 p-2 shadow-lg rounded-t-lg break-all">Variant Annotations (All)</h2>
            <div class="rounded-b-lg overflow-x-auto">
              {% if annotations|length > 0 %}
                <table class="w-full max-w-xl table-auto text-xs text-gray-800 mb-1">
                  <thead class="capitalize tracking-wide rounded-t-lg bg-green-100">
                    <tr class="border-b text-left border-gray-800">
                      <th class="p-3 font-semibold w-1/6">Who</th>
                      <th class="p-3 font-semibold w-4/6">Annotation</th>
                      <th class="p-3 font-semibold w-1/6">Assay</th>
                    </tr>
                  </thead>
                  <tbody id="variant-annotations-all-body" class="{% if annotations|length > 1 %}border-b border-gray-400 {% endif %}">
                    {% for anno in annotations|sort(attribute='time_created', reverse=True) %}
                      {% if loop.first == True %}
                        <tr class="hover:bg-green-100 border-t border-gray-400 text-left align-top">
                          <td class="p-2 font-medium">{{ anno.author }}<br><small>{{ anno.time_created|human_date }}</small></td>
                          <td class="p-2" onclick="addText(event)">{{ anno.text|format_comment|safe }}</td>
                          <td class="p-2">
                            {% if "assay" in anno %}
                              {{ anno.assay }}<br><small>{{ anno.subpanel }}</small>
                            {% else %}
                              historic
                            {% endif %}
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md break-all">No variant annotations (all) available.</em>
              {% endif %}
            </div>
          </div>
        {% endif %}

        <!-- Variant annotations (Assay) -->
        <div class="bg-gray-50 w-full max-w-xl pagination shadow-md rounded-lg mb-1" data-rows-per-page="2" pagination-button-color="blue" pagination-button-text-color="black" id="variant-annotations-assay">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-blue-400 to-blue-200 p-2 shadow-md rounded-t-lg break-all">Variant Annotations (Assay)</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if annotations_interesting|length > 0 %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-blue-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold w-1/6">Who</th>
                    <th class="p-3 font-semibold w-4/6">Annotation</th>
                    <th class="p-3 font-semibold w-1/6">Assay</th>
                  </tr>
                </thead>
                <tbody id="variant-annotations-assay-body" class="{% if annotations_interesting|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for assay_sub, key in annotations_interesting.items() %}
                    <tr class="hover:bg-blue-100 border-t border-gray-400 text-left align-top">
                      <td class="p-2 font-medium">{{ key.author }}<br><small>{{ key.time_created|human_date }}</small></td>
                      <td class="p-2" onclick="addText(event)">{{ key.text|format_comment|safe }}</td>
                      <td class="p-2">
                        {% if "assay" in key %}
                          {{ key.assay }}<br><small>{{ key.subpanel }}</small>
                        {% else %}
                          historic
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-blue-100 break-all">No variant annotations (Assay) available.</em>
            {% endif %}
          </div>
        </div>


        <!-- Sample Specific Variant comments -->
        <div class="bg-gray-50 w-full max-w-xl shadow-md rounded-lg mb-1" id="variant-comments">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-yellow-400 to-yellow-200 p-2 shadow-md rounded-t-lg break-all">Sample-Specific Variant Comments</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if variant.comments|length > 0 %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-yellow-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold w-1/6">Who</th>
                    <th class="p-3 font-semibold w-4/6">Comment</th>
                    <th class="p-3 font-semibold w-1/6">Action</th>
                  </tr>
                </thead>
                <tbody id="variant-comments-body" class="{% if variant.comments|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for comment in variant.comments|sort(attribute='time_created', reverse=True) %}
                    {% if comment.hidden != 1 %}
                      <tr class="hover:bg-yellow-50 border-t border-gray-400 text-left align-top">
                    {% else %}
                      <tr class="bg-red-100 hover:bg-red-200 opacity-30 border-t border-gray-400 text-left align-top hidden hidden_comment">
                    {% endif %}
                      <td class="p-2 font-medium">{{ comment.author }}<br><small>{{ comment.time_created|human_date }}</small></td>
                      <td class="p-2" onclick="addText(event)">{{ comment.text|format_comment|safe }}</td>
                      <td class="p-2">
                        {% if comment.hidden != 1 %}
                          <form action="{{ url_for('dna_bp.hide_variant_comment', sample_id=sample.name, var_id=variant._id) }}" method="POST">
                            <input type="hidden" name="comment_id" value="{{ comment._id }}">
                            <input id="hide_comment" type="image" class="w-5 {% if not has_access('hide_variant_comment', min_role='manager', min_level=99) %} opacity-70 select-none cursor-not-allowed pointer-events-none {% endif %}" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye-slash.svg') }}">
                          </form>
                        {% else %}
                          <form action="{{ url_for('dna_bp.unhide_variant_comment', sample_id=sample.name, var_id=variant._id) }}" method="POST">
                            <input type="hidden" name="comment_id" value="{{ comment._id }}">
                            <input id="unhide_comment" type="image" class="w-5 {% if not has_access('unhide_variant_comment', min_role='manager', min_level=99) %} opacity-70 select-none cursor-not-allowed pointer-events-none {% endif %}" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye.svg') }}">
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                  {% if hidden_comments %}
                    <tr>
                      <td colspan=3 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                        <a href="javascript:void(0);" onclick="switchVisibility_comments('hidden_comment')">
                          Show/Hide Deleted Comments
                        </a>
                      </td>
                    </tr>
                {% endif %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md break-all">No sample-specific variant comments available.</em>
            {% endif %}
          </div>
        </div>

        <!-- MELT Annotations -->
        {% if "MELT" in variant.INFO.variant_callers %}
          <div class="bg-gray-50 max-w-lg w-full shadow-md rounded-lg mb-1" id="melt-annotations">
            <h2 class="text-sm font-semibold bg-gradient-to-b from-teal-400 to-teal-200 p-2 shadow-md rounded-t-lg break-all">MELT-Specific Annotations</h2>
            <div class="rounded-b-lg overflow-x-auto">
              <table class="w-full max-w-lg text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-teal-200">
                  <tr class="border-b text-left border-gray-800">
                    <th class="px-1 py-2 font-semibold">Type</th>
                    <th class="px-1 py-2 font-semibold">Annotation</th>
                  </tr>
                </thead>
                <tbody id="melt-annotations-body">
                  {% if "custom" in variant.INFO %}
                    {% set melt_anno = variant.INFO.custom.split(",") %}
                    {% for ma in melt_anno %}
                      {% set keyval = ma.split("|") %}
                      <tr class="hover:bg-teal-50 border-t border-gray-400 text-left align-top">
                        <td class="p-2">{{keyval[0]}}</td>
                        <td class="p-2">{{keyval[1]}}</td>
                      </tr>
                    {% endfor %}
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}

        <!-- Knowledge Base -->
        <div class="bg-gray-50 w-full max-w-xl shadow-md rounded-lg mb-1" id="knowledge-base-card">
          {% set kb_flase = True %}
          <h2 class="text-sm font-semibold bg-gradient-to-b from-pink-400 to-pink-200 p-2 shadow-md rounded-t-lg break-all">Knowledge Base</h2>
          <div class="rounded-b-lg overflow-x-auto">
            <table class="w-full max-w-xl table-auto text-xs text-gray-800">
              <thead class="capitalize tracking-wide rounded-t-lg bg-pink-200">
                <tr class="border-b text-left border-gray-800">
                  <th class="p-3 font-semibold w-1/12">Database</th>
                  <th class="p-3 font-semibold w-1/12">Gene/Variant</th>
                  <th class="p-3 font-semibold w-10/12">Summary</th>
                </tr>
              </thead>
              <tbody id="knowledge-base-card-body">
                <!-- BRCA Exchange Database -->
                <!-- TODO: Update this to the latest design when testing -->
                {#{% set brca_exchange = {} %}#}
                {% if brca_exchange is defined and brca_exchange is not none %}
                  {% set kb_flase = False %}
                  <tr class="hover:bg-pink-50 border-b">
                    <td class="p-2 font-medium align-top">
                      <img class="w-12" alt="BRCA Exchange" src="{{ url_for('static', filename='images/brcaexchange_logo.jpg') }}">
                    </td>
                    <td class="p-2 font-medium align-top py-5">
                      <a href="http://brcaexchange.org/variant/{{brca_exchange.id}}" class="text-blue-600 hover:underline break-words">{{brca_exchange.id}}</a>
                    </td>
                    <td class="p-2 font-medium text-justify break-words">
                      Clinical significance (ENIGMA): <b>{{brca_exchange.enigma_clinsig}}</b><p>
                      {{brca_exchange.enigma_clinsig_comment}}</b><p>
                      {% if brca_exchange.enigma_clinsig_refs != "-" %}
                        Citations: {{brca_exchange.enigma_clinsig_refs|pubmed_links|safe}}
                      {% endif %}
                    </td>
                {% endif %}

                <!-- OnkoKB Database -->
                <!-- TODO: Update this to the latest design when testing -->
                {#{% set oncokb = {} %}#}
                {% if oncokb is defined and oncokb is not none %}
                  {% set kb_flase = False %}
                  <tr class="hover:bg-pink-50 border-b">
                    <td class="p-2 font-medium align-top">
                      <img class="w-12 pt-4" alt="OncoKB" src="{{ url_for('static', filename='images/oncokb_logo.png') }}">
                    </td>
                    <td class="p-2 font-medium align-top py-5">
                      <a href="http://oncokb.org/#/gene/{{sel_csq.SYMBOL}}" class="text-blue-600 hover:underline break-words">{{ oncokb.Alteration }}</a>
                    </td>
                    <td class="p-2 font-medium text-justify break-words">
                      Oncogenicity: <b>{{ oncokb.Oncogenicity }}</b><br>
                      Mutation effect: <b>{{ oncokb['Mutation Effect'] }}</b> {{ oncokb['PMIDs for Mutation Effect']|pubmed_links|safe }}<br><br>
                      {% if oncokb_action.count() > 0 %}
                        <b>Actions:</b>
                        <table class="table-auto text-xs overflow-hidden mx-4 my-1">
                          <thead>
                            <tr class="border-b-2 text-left border-gray-300 capitalize">
                              <th class="p-2 font-semibold">Cancer</th>
                              <th class="p-2 font-semibold">Drug(s)</th>
                              <th class="p-2 font-semibold">Level</th>
                              <th class="p-2 font-semibold">Refs</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for oncokb_act in oncokb_action %}
                              {% if oncokb_act.Alteration != "Oncogenic Mutations" or oncokb.Oncogenicity == "Oncogenic" %}
                              <tr class="border text-left border-gray-300">
                                <td class="p-2 font-base break-words">{{ oncokb_act['Cancer Type'] }}</td>
                                <td class="p-2 font-base break-words">{{ oncokb_act['Drugs(s)'] }}</td>
                                <td class="p-2 font-base break-words">{{ oncokb_act['Level'] }}</td>
                                <td class="p-2 font-base break-words">{{ oncokb_act['PMIDs for drug']|pubmed_links|safe }}</td>
                              </tr>
                              {% endif %}
                            {% endfor %}
                          </tbody>
                        </table>
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}

                
                <!-- CIVIC Database -->
                {% if civic_gene is defined and civic_gene is not none %}
                  {% set kb_flase = False %}
                  <tr class="hover:bg-pink-50 border-b">
                    <td class="p-2 font-medium align-top">
                      <img class="w-10 h-10 object-contain" alt="OncoKB" src="{{ url_for('static', filename='images/civic_logo.png') }}">
                    </td>
                    <td class="p-2 font-medium align-top py-5">
                      <a href="{{ civic_gene.gene_civic_url }}" class="text-blue-600 hover:underline break-words">
                        {{ civic_gene.name }}
                      </a>
                    </td>
                    <td class="p-2 font-medium text-justify break-words">
                      {{ civic_gene.description }}
                    </td>
                  </tr>
                {% endif %}

                
                <!-- OnkoKB Gene Database -->
                {% if oncokb_gene is defined and oncokb_gene is not none %}
                  {% set kb_flase = False %}
                  <tr class="hover:bg-pink-50 border-b">
                    <td class="p-2 font-medium align-top">
                      <img class="w-12 pt-4" alt="OncoKB" src="{{ url_for('static', filename='images/oncokb_logo.png') }}">
                    </td>
                    <td class="p-2 font-medium align-top py-5">
                      <a target="_blank" href="http://oncokb.org/#/gene/{{sel_csq.SYMBOL}}" class="text-blue-600 hover:underline break-words">{{sel_csq.SYMBOL}}</a>
                    </td>
                    <td class="p-2 font-medium text-justify break-words">
                      {% if oncokb_gene.description is defined %}
                        {{ oncokb_gene.description|format_oncokbtext|safe }}
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}

                <!-- IARC Database -->
                {% if iarc_tp53 is defined and iarc_tp53 is not none %}
                  {% set kb_flase = False %}
                  <tr class="hover:bg-pink-50 border-b">
                    <td class="p-2 font-medium align-top">
                      <img class="w-10 h-10 object-contain" alt="IARC TP53" src="{{ url_for('static', filename='images/iarctp53_logo.png') }}">
                      <p class="text-red-500 font-bold align-top">BETA!</p>
                    </td>
                    <td class="p-2 font-medium align-top py-5">
                      <a href="http://p53.iarc.fr/TP53GeneVariations.aspx" class="text-blue-600 hover:underline break-words">IARC Variations</a>
                    </td>
                    <td class="p-2 font-medium text-justify break-words">
                      <div class="text-xs text-gray-800 mb-3">
                        <div>
                          <span class="text-gray-600">Somatic count:</span>
                          <span class="font-semibold">{{ iarc_tp53.n_somatic }}</span>
                        </div>
                        <div>
                          <span class="text-gray-600">Germline count:</span>
                          <span class="font-semibold">{{ iarc_tp53.n_germline }}</span>
                        </div>
                      </div>
                      
                      <div class="text-xs text-gray-800 mb-3">
                        <div>
                          <span class="text-gray-600">Structural motif</span>
                          <span class="font-semibold">{{ iarc_tp53.motif }}</span>
                        </div>
                        <div>
                          <span class="text-gray-600">Domain function</span>
                          <span class="font-semibold">{{ iarc_tp53.domain_func }}</span>
                        </div>
                        <div>
                          <span class="text-gray-600">Residue function</span>
                          <span class="font-semibold">{{ iarc_tp53.residue_func }}</span>
                        </div>
                      </div>

                      <div class="text-xs text-gray-800 mb-3">
                        <div>
                          <span class="text-gray-600">Transactivation class</span>
                          <span class="font-semibold">{{ iarc_tp53.transactivation_class }}</span>
                        </div>
                        <div>
                          <span class="text-gray-600">AGVGD class</span>
                          <span class="font-semibold">{{ iarc_tp53.AGVGD_class }}</span>
                        </div>
                        <div>
                          <span class="text-gray-600">Splicing</span>
                          <span class="font-semibold">{{ iarc_tp53.splice }}</span>
                        </div>
                        <div>
                          <span class="text-gray-600">CpG site</span>
                          <span class="font-semibold">{{ iarc_tp53.cpg }}</span>
                        </div>
                        <div>
                          <span class="text-gray-600">Polymorphism</span>
                          <span class="font-semibold">{{ iarc_tp53.polymorphism }}</span>
                        </div>
                      </div>
                      {% if "topology_count" in iarc_tp53 %}
                        <div class="text-xs mb-2">
                          <table class="table-auto text-xs text-gray-800 bg-transparent">
                            <thead class="capitalize">
                              <tr class="text-left">
                                <th class="p-2 border border-gray-800 font-semibold">Topologies</th>
                                <th class="p-2 border border-gray-800 font-semibold">Counts</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for top, count in iarc_tp53.topology_count.items() %}
                                <tr class="hover:bg-pink-100 text-left align-top">
                                  <td class="p-2 border border-gray-800">{{ top }}</td>
                                  <td class="p-2 border border-gray-800">{{ count }}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      {% endif %}                      
                    </td>
                  <tr>
                {% endif %}
              </tbody>
            </table>
            {% if kb_flase %}
              <em class="block text-center text-gray-500 text-sm italic bg-gray-50 p-4 rounded-b-lg border border-gray-300 shadow-md break-all">No knowledge available.</em>
            {% endif %}
          </div>
        </div>
      
      </div>

    </section>

  </main>
</div>
  

<script type="text/javascript">
    $("#test").select2();

    window.onload = function() {
      $('[data-autoclick="true"]').click();
      $('[data-autoclick="true"]').click();
    };

    function switchVisibility_comments(class_name) {
      var elems = document.querySelectorAll('.' + class_name); // Use querySelectorAll to get a static NodeList
  
      elems.forEach(elem => {
          if (window.getComputedStyle(elem).display === "none") {
              elem.style.display = "table-row";  // Ensure it is visible in table format
          } else {
              elem.style.display = "none"; // Hide it
          }
      });
  }


  function switchVisibility_noncanonicaltranscripts(class_name) {
    var hide_class = "visibility-collapsed";

    var elems = document.getElementsByClassName(class_name);

    for (var i = 0; i < elems.length; i++) {

      if( elems[i].classList.contains(hide_class) ) {
        elems[i].classList.remove(hide_class);
      }
      else {
        elems[i].classList.add(hide_class);
      }
    }
  }     

  function addText(event) {
    var targ = event.target || event.srcElement;
    if (!targ.closest('tr').classList.contains('hidden_comment')) {
      document.getElementById("comment_textarea").value = targ.textContent || targ.innerText;
    }
  }


</script>

{% endblock %}


{% macro complement(base) -%}
  {% if base == "A" %}T{% endif %}
  {% if base == "T" %}A{% endif %}
  {% if base == "C" %}G{% endif %}
  {% if base == "G" %}C{% endif %}
{%- endmacro %}
