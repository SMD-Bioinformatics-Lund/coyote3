{# coyote/blueprints/common/templates/tiered_variant_info.html #}
{% extends "layout.html" %}
{% block title %}Reported Variant â€“ Tier {{ tier }}{% endblock %}

{% block body %}
<div class="flex w-full h-full overflow-hidden">
  <main class="flex flex-col flex-1 overflow-y-auto px-4 py-2">

    <!-- Header -->
    <section class="p-2 ml-2 mt-2">
      <div class="rounded-3xl border border-gray-200 bg-gray-50 backdrop-blur shadow-xl p-6 border-t-4 border-indigo-700 break-all hover:shadow-md transition">
        <div class="flex items-start justify-between gap-6">
          <div class="min-w-0">
            <div class="text-xs uppercase tracking-wider text-gray-600">Reported Variant</div>

            <h1 class="mt-1 text-2xl font-semibold text-gray-900 flex flex-wrap items-center gap-3">
              <span class="truncate">
                {{ variant.get("INFO", {}).get("selected_CSQ", {}).get("SYMBOL", "Unknown") }}
              </span>

              <span class="inline-flex items-center px-3 py-1 rounded-full bg-tier{{tier}} text-white text-sm shadow-md">
                Tier {{ tier }}
              </span>

              {% if variant.get("fp") %}
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-orange-100 text-orange-900 border border-orange-200 text-sm">
                  FP
                </span>
              {% endif %}
              {% if variant.get("interesting") %}
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-teal-100 text-teal-900 border border-teal-200 text-sm">
                  Interesting
                </span>
              {% endif %}
              {% if variant.get("irrelevant") %}
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-200 text-gray-900 border border-gray-200 text-sm">
                  Irrelevant
                </span>
              {% endif %}
            </h1>

            <div class="mt-2 text-sm text-gray-700 space-y-1">
              {% set csq = variant.get("INFO", {}).get("selected_CSQ", {}) or {} %}
              <div class="flex flex-wrap gap-2">
                {% if variant.get("simple_id") %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-200 border border-gray-200 text-xs">
                    simple_id: <span class="ml-1 font-semibold">{{ variant.simple_id }}</span>
                  </span>
                {% endif %}
                {% if variant.get("simple_id_hash") %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-200 border border-gray-200 text-xs">
                    hash: <span class="ml-1 font-semibold">{{ variant.simple_id_hash }}</span>
                  </span>
                {% endif %}
                {% if csq.get("HGVSc") %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-200 border border-gray-200 text-xs">
                    HGVSc: <span class="ml-1 font-semibold">{{ csq.HGVSc }}</span>
                  </span>
                {% endif %}
                {% if csq.get("HGVSp") %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-200 border border-gray-200 text-xs">
                    HGVSp: <span class="ml-1 font-semibold">{{ csq.HGVSp }}</span>
                  </span>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="shrink-0 flex items-center gap-2">
            <a href="{{ url_for('home_bp.edit_sample', sample_id=variant.get('SAMPLE_ID', '')) }}"
               class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 border border-gray-200 text-sm shadow">
              Edit Sample
            </a>
            <a href="{{ url_for('dna_bp.list_variants', sample_id=variant.get('SAMPLE_ID', '')) }}"
                class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 border border-gray-200 text-sm shadow">
              Analysis
            </a>
          </div>
        </div>
      </div>
    </section>

    {% if error %}
      <section class="p-2 ml-2 mt-2">
        <div class="rounded-3xl border border-red-200 bg-red-50 text-red-900 shadow-xl p-4 border-t-4 border-red-600">
          <div class="text-sm font-semibold">Could not load reported variants</div>
          <div class="text-sm mt-1">{{ error }}</div>
        </div>
      </section>
    {% endif %}

    <!-- Summary -->
    <section class="p-2 ml-2 mt-2 grid grid-cols-5 gap-6">
      <div class="col-span-3 rounded-3xl border border-gray-200 bg-gray-50 backdrop-blur shadow-xl p-6 border-t-4 border-teal-700 hover:shadow-md transition">
        <h2 class="text-sm uppercase font-semibold tracking-wider text-gray-900 mb-4">Match Summary</h2>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="rounded-2xl border bg-white p-4 hover:shadow-md transition">
            <div class="text-xs text-gray-500">Matches</div>
            <div class="text-2xl font-semibold">{{ docs|length }}</div>
          </div>
          <div class="rounded-2xl border bg-white p-4 hover:shadow-md transition">
            <div class="text-xs text-gray-500">Gene</div>
            <div class="text-lg font-semibold">{{ variant.get("INFO", {}).get("selected_CSQ", {}).get("SYMBOL", "-") }}</div>
          </div>
        </div>

        <div class="mt-4 text-xs text-gray-600">
          Showing all reported-variant snapshots matching gene and at least one of: simple_id/hash/HGVSc/HGVSp.
        </div>
      </div>

      <div class="col-span-2 rounded-3xl border border-gray-200 bg-gray-50 backdrop-blur shadow-xl p-6 border-t-4 border-purple-700 hover:shadow-md transition">
        <h2 class="text-sm uppercase font-semibold tracking-wider text-gray-900 mb-4">Variant Meta</h2>

        <dl class="grid grid-cols-1 gap-3 text-sm">
          <div>
            <dt class="text-xs text-gray-500">Tier</dt>
            <dd class="font-semibold">{{ tier }}</dd>
          </div>
          <div>
            <dt class="text-xs text-gray-500">simple_id</dt>
            <dd class="font-semibold">{{ variant.get("simple_id") or "-" }}</dd>
          </div>
          <div>
            <dt class="text-xs text-gray-500">simple_id_hash</dt>
            <dd class="font-semibold">{{ variant.get("simple_id_hash") or "-" }}</dd>
          </div>
        </dl>
      </div>
    </section>

    <!-- Results table -->
    <section class="p-2 ml-2 mt-2">
      <div class="rounded-3xl border border-gray-200 bg-gray-50 backdrop-blur shadow-xl p-6 border-t-4 border-indigo-400 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm uppercase font-semibold tracking-wider text-gray-900">Reported Variants (Matched Samples)</h2>

          <div class="text-xs text-gray-600">
            {{ docs|length }} record{{ '' if docs|length == 1 else 's' }}
          </div>
        </div>

        {% if docs and docs|length %}
          <div class="rounded-2xl border bg-white overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="sortable bg-gray-50 text-xs">
                  <tr>
                    <th class="text-left px-3 py-2">Sample</th>
                    <th class="text-left px-3 py-2">Assay</th>
                    <th class="text-left px-3 py-2">Report</th>
                    <th class="text-left px-3 py-2">Reported On</th>
                    <th class="text-left px-3 py-2">Tier</th>
                    <th class="text-left px-3 py-2">Gene</th>
                    <th class="text-left px-3 py-2">HGVSc</th>
                    <th class="text-left px-3 py-2">HGVSp</th>
                    <th class="text-left px-3 py-2">Notes</th>
                    <th class="text-left px-3 py-2 w-20">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in docs %}
                    {% set sample_profile = d.get('sample', {}).get('profile', '')[0]|upper or 'P' %}
                    <tr class="border-t hover:bg-gray-50">
                      <!-- sample -->
                      <td class="px-3 py-2">
                        <div class="font-semibold text-gray-900 flex items-center gap-2">
                          {% if d.get('sample', {}).get('sample_name') %}
                            <a href="{{ url_for('dna_bp.list_variants', sample_id=d.get('sample', {}).get('sample_name')) }}" class="font-semibold text-blue-500 hover:underline">
                              {{ d.get('sample', {}).get('sample_name') }}
                            </a>
                          {% else %}
                            {{ d.sample_oid }}
                          {% endif %}
                          <span class="inline-block px-1.5 py-0.5 rounded-2xl text-white text-xs font-semibold bg-{{ d.get('sample', {}).get('profile') or 'production' }} text-center">
                            {{ sample_profile }}
                          </span>
                        </div>
                      </td>

                      <!-- Assay -->
                      <td class="px-3 py-2">
                        <div class="font-semibold text-gray-900">
                          {{ d.get('annotation', {}).get('assay') or '-' }}
                        </div>
                        {% if d.get('annotation', {}).get('subpanel')  %}
                          <div class="text-xs text-gray-500 break-all">{{ d.get('annotation', {}).get('subpanel', '-') }}</div>
                        {% endif %}
                      </td>

                      <!-- Report -->
                      <td class="px-3 py-2">
                        <div class="text-gray-900 font-medium">
                          {% if d.get('sample', {}).get('sample_name') and d.report_id %}
                            <a href="{{ url_for('home_bp.view_report', sample_id=d.get('sample', {}).get('sample_name'), report_id=d.report_id) }}"
                            class="inline-block bg-blue-400 text-white px-2 py-0.5 rounded-lg text-xs font-bold mx-1 hover:bg-blue-500 transition"
                            >
                              {{ d.report_id }}
                            </a>
                          {% else %}
                            {{ d.report_id or d.report_oid }}
                          {% endif %}
                        </div>
                      </td>

                      <td class="px-3 py-2">
                        {% if d.reported_on %}
                          {{ d.reported_on|human_date }}
                        {% elif d.created_on %}
                          {{ d.created_on|human_date }}
                        {% else %}
                          -
                        {% endif %}
                      </td>

                      <td class="px-3 py-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-tier{{ d.tier }} text-white text-xs shadow">
                          {{ d.tier }}
                        </span>
                      </td>

                      <td class="px-3 py-2">{{ d.gene or '-' }}</td>
                      <td class="px-3 py-2 break-all">{{ d.hgvsc or '-' }}</td>
                      <td class="px-3 py-2 break-all">{{ d.hgvsp or '-' }}</td>

                      <td class="px-3 py-2">
                        <div class="text-xs text-gray-700 whitespace-pre-line">
                          {{ d.note or d.notes or '' }}
                        </div>
                        {% if not (d.note or d.notes) %}
                          <span class="text-xs text-gray-400">-</span>
                        {% endif %}
                      </td>
                      <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                          {% if d.sample_name %}
                            <a href="{{ url_for('dna_bp.list_variants', sample_id=d.sample_name) }}"
                              title="View"
                              class="font-medium text-gray-700 hover:text-blue-600">
                              <img src="{{ url_for('static', filename='icons/heroicons_outline_24/eye.svg') }}" alt="View" class="w-5 cursor-pointer">
                            </a>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% else %}
          <div class="text-sm text-gray-700">
            No reported variant snapshots found for this tier and identity.
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Footer hint -->
    <section class="p-2 ml-2 mt-2 mb-6">
      <div class="rounded-3xl border border-gray-200 bg-gray-50 shadow p-4 text-xs text-gray-600">
        Tip: If this list looks empty unexpectedly, verify that reported snapshot docs store at least one of:
        <span class="font-semibold">simple_id</span>, <span class="font-semibold">simple_id_hash</span>,
        <span class="font-semibold">hgvsc</span>, <span class="font-semibold">hgvsp</span>.
      </div>
    </section>

  </main>
</div>
{% endblock %}
