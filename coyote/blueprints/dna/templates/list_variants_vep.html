{% extends "layout.html" %}

{% block style %}
<style>
  /* CNV Image */
  .cnv-image {
    flex: 1;
    min-width: 48%;  /* Image takes at least 48% */
    max-width: 100%; /* Can expand fully if table is missing */
  }

  /* CNV Table */
  .cnv-table {
    flex: 2;
    min-width: 40%;  /* Table takes at least 50% */
    max-width: 100%; /* Can expand fully if image is missing */
  }

  /* If Only One Exists, It Takes Full Width */
  .cnv-container:has(.cnv-image) .cnv-table:only-child {
    flex: 0 0 100%;
    max-width: 100%;
  }

  .cnv-container:has(.cnv-table) .cnv-image:only-child {
    flex: 0 0 100%;
    max-width: 100%;
  }

  /* Move Table Below on Small Screens */
  @media (max-width: 1024px) {
    .cnv-image,
    .cnv-table {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }


  /* Make Image Float While Table Scrolls */
</style>
{% endblock %}



{% block body %}

{% set all_samples_bam_paths = [] %}
{% set subfolder = {'dir': "None"} %}

{# Collect all BAM paths #}
{% for sample_id, bam_paths in bam_id.items() %}
  {% for path in bam_paths %}
    {% set list1 = path.split('/') %}
    {% if subfolder.update({ 'dir': list1[0] }) %} {% endif %}
    {% set _ = all_samples_bam_paths.append("/R:" ~ path) %}
  {% endfor %}
{% endfor %}

{# Append design BED file if available #}
{# Creating design_bed_url as well #}
{% if subfolder.dir != "None" and subfolder.dir != "tumwgs" %}
  {% set design_bed = "http://localhost:60151/load?file=/R:" ~ subfolder.dir ~ "/BED/design.bed"  %}
  {% set design_bed_url = '<a href="' ~ design_bed ~ '" class="text-blue-600 underline">' ~ "open" ~ '</a>'%}
  {% set _ = all_samples_bam_paths.append("/R:" ~ subfolder.dir ~ "/BED/design.bed") %}
{% else %}
  {% set design_bed_url = '-' %}
{% endif %}


  <!-- FLEX CONTAINER: Sidebar (Fixed) + Main Content (Scrollable) + Filter Content Right Sidebar (Fixed)-->

  <div class="flex w-full h-full overflow-hidden">

    <!-- LEFT SIDEBAR (Fixed Width, Full Height) -->
    <aside class="w-8 bg-transparent text-white flex flex-col">

      {% for dna_section in analysis_sections %}
        {% if dna_section != "BIOMARKER" %}
          <div class="flex border-l-8 border-yellow-400 mt-1">
            <a href="#{{ dna_section }}"
              class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
                <span class="vertical-text">{{ dna_section }}</span>
            </a>
          </div>
        {% endif %}
      {% endfor %}

      <div class="flex border-l-8 border-brown-200 mt-1">
        <a href="#SUMMARY"
          class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">SUMMARY</span>
        </a>
      </div>

      {% if sample.cov %}
        <div class="flex border-l-8 border-orange-400 mt-1">
          <a href="{{ url_for('cov_bp.get_cov', sample_id=sample.name) }}"
            class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
              <span class="vertical-text">COVERAGE</span>
          </a>
        </div>
      {% endif %}

      {% if has_access('preview_report', min_role='user', min_level=9) %}
        <div class="flex border-l-8 border-teal-400  mt-1">
          <a href="{{ url_for('dna_bp.generate_dna_report', sample_id=sample.name) }}"
            class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
              <span class="vertical-text">Preview Report</span>
          </a>
        </div>
      {% endif %}
    </aside>

    <!-- MAIN CONTENT (Scrollable & Auto-Resizing) -->
    <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col">

      <!-- Sample Info Card (Auto-Wrapping, Full Flexbox) -->
      {% include "sample_meta_info.html" %}

      <!-- Selected Gene Panel Card -->
      {% include "selected_gene_panel_div.html" %}

      {% if verification_sample_used %}
        <!-- Verification Sample Card -->
        <section class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
          <div class="overflow-x-auto relative">
            <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Verification Sample</h2>
          </div>
          <div class="mx-2 py-2">
            <p class="text-sm font-semibold text-yellow-700">Verification sample used: {{ verification_sample_used }}</p>
          </div>
        </section>
      {% endif %}

      <!-- SNVs & Indels Card -->
      {% if "SNV" in analysis_sections %}
        {% set variants = display_sections_data.snvs %}
        <section id="SNV" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
          <!-- SNV/Indels Header -->
          <div class="overflow-x-auto relative">
            <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">SNVs/Indels ({{ variants|length }})</h2>
          </div>

          <div class="mx-auto py-2 " id="snvs-content">
            <div class="flex flex-wrap gap-4">
              <!-- SNVs/Indels Table -->
              <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
                <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
                  <h2 class="text-sm font-semibold text-black">Variants Passing Filter Criteria</h2>
                  {% if has_access("download_snvs", min_role="user", min_level=9) %}
                    <img
                      src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}"
                      alt="Export to CSV - SNVs"
                      onclick="exportHTMLTable({ tableId:'snvs-table', filename:'{{ sample.name }}.filtered.snvs.csv' })"
                      class="w-6 h-6 transition-transform transform hover:scale-110"
                    />
                  {% endif %}
                </div>
                <div class="overflow-auto relative">
                  <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="snvs-table">
                    <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                      <tr id="variant-table-header" class="border-b text-left border-gray-800">
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-checkbox" data-nosort="true">
                          <input type="checkbox" id="select-all-table" onclick="toggleSelectAllVariants(this)">
                        </th>
                        <th class="py-3 font-semibold w-3" id="variant-table-header-blacklisted" data-nosort="true"></th>
                        <th class="py-3 font-semibold w-4" id="variant-table-header-comments" data-nosort="true"></th>
                        <th class="py-3 font-semibold w-4" id="variant-table-header-interesting-irrelevant" data-nosort="true"></th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-gene">Gene</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-hgvs">HGVS</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-hgvs">Exon</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-hgvs">Intron</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-type">Type</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-type">Indel Size</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-conseq">Consequence</th>
                        <th class="px-2 py-3 font-semibold max-w-15c" id="variant-table-header-popFreq">PopFreq %</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-tier">Tier</th>
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-chrPos">Chr:Pos</th>
                        {% if assay_group == "solid" %}
                          <th class="py-3 font-semibold" id="variant-table-header-hotspot">Hotspot</th>
                        {% endif %}
                        <th class="px-2 py-3 font-semibold max-w-30c" id="variant-table-header-flags">Flags</th>
                        {% if variants and variants[0].GT %}
                          {% for gt in variants[0].GT|sort(attribute='type') %}
                            {% if gt.type == "case" %}
                              <th data-autoclick="true" class="px-1 py-3 font-semibold max-w-20c break-words whitespace-normal" id="variant-table-header-case">{{ gt.type }} ({{gt.sample}})</th>
                            {% else %}
                              <th class="px-2 py-3 font-semibold max-w-20c break-words whitespace-normal" id="variant-table-header-control">{{ gt.type }} ({{gt.sample}})</th>
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                        <th class="px-2 py-3 font-semibold" id="variant-table-header-view" data-nosort="true">View</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for var in variants %}
                        {% set csq = var.INFO.selected_CSQ %}
                        {% set chr_pos = var.CHROM ~ ":" ~ var.POS %}
                        {% set indel_size = var.ALT|length - var.REF|length %}
                        {# Build the final IGV URL #}
                        {% if all_samples_bam_paths and has_access("view_igv", min_role="user", min_level=9) %}
                          {% set igv_url = "http://localhost:60151/load?file=" ~ all_samples_bam_paths | join(',') ~ "&locus=" ~ chr_pos %}
                          {% set igv_chr_pos = '<a href="' ~ igv_url ~ '">' ~ chr_pos ~ '</a>' %}
                        {% else %}
                          {% set igv_chr_pos = chr_pos %}
                        {% endif %}

                        {% if var.fp == True or ( var.blacklist and var.override_blacklist != true ) or var.irrelevant == True %}
                          <tr class='bg-red-200 opacity-60 hover:bg-red-200 border-t border-gray-400 text-left fp' id="snv-table-row-fp">
                        {% else %}
                          <tr class="border-t border-gray-400 text-left hover:bg-yellow-50" id="snv-table-row">
                        {% endif %}

                        <!-- Checkbox -->
                        <td class="pl-2 py-2.5">
                          <input type="checkbox" class="snv-checkbox" id="snv-table-row-checkbox" data-value="{{ var._id }}">
                        </td>

                        <!-- Blacklisted -->
                        <td id="snv-table-row-blacklisted" class="text-center align-middle">
                          <div class="flex items-center justify-center h-full">
                            {% if var.fp == True %}
                              <span data-export-value="False positive" class="relative inline-block cursor-pointer" onmouseover="showTooltip(event, `<span class='text-red-400 '>Variant is false positive</span>`)">
                                <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-circle.svg') }}">
                              </span>
                            {% elif var.blacklist and var.override_blacklist != true %}
                              <span data-export-value="Blacklisted" class="relative inline-block cursor-pointer "
                                onmouseover="showTooltip(event, `<span class='text-red-400'>Variant is blacklisted</span>`)">
                                <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/no-symbol.svg') }}">
                              </span>
                            {% endif %}
                          </div>
                        </td>

                        <!-- Comments -->
                        <td id="snv-table-row-comments" class="text-center align-middle">
                          <div class="flex items-center justify-center h-full">
                            {% if var.comments|length > 0 %}
                              <span data-export-value="Has Comments" class="relative inline-block cursor-pointer"
                                onmouseover="showTooltip(event, `<span class='text-orange-400'>Variant has comments</span>`)">
                                <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/chat-bubble-left-ellipsis.svg') }}">
                              </span>
                            {% endif %}
                          </div>
                        </td>

                        <!-- Interesting/irrelevant -->
                        <td id="snv-table-row-interesting-irrelevant" class="text-center align-middle">
                          <div class="flex items-center justify-center h-full">
                            {% if var.interesting == True %}
                              <span data-export-value="Interesting" class="relative inline-block cursor-pointer"
                                onmouseover="showTooltip(event, `<span class='text-green-400'>Variant is interesting</span>`)">
                                <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/exclamation-circle.svg') }}">
                            </span>
                            {% endif %}
                            {% if var.irrelevant == True %}
                              <span data-export-value="Irrelevant" class="relative inline-block cursor-pointer"
                                onmouseover="showTooltip(event, `<span class='text-yellow-400'>Variant is irrelevant</span>`)">
                                <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-mark.svg') }}">
                              </span>
                            {% endif %}
                          </div>
                        </td>

                        <!-- Gene -->
                        <td id="snv-table-row-gene">
                          {% if csq.SYMBOL in oncokb_genes %}
                            <a target="_blank" href="https://www.oncokb.org/actionable-genes#hugoSymbol={{csq.SYMBOL}}&sections=Tx" class="text-red-600 underline">{{csq.SYMBOL}}
                          {% else %}
                            <span>{{ csq.SYMBOL }}</span>
                          {% endif %}

                          {{ var.INFO.PANEL | format_panel_flag_snv | safe }}
                        </td>

                        <!-- HGVS -->
                        <td id="snv-table-row-hgvs" class="max-w-25c">

                          <!-- HGVSp Section -->
                          {% if csq.HGVSp and csq.HGVSp != "-" %}
                            <span class="relative cursor-pointer" onmouseover="showTooltip(event, `<span class='break-all inline-flex'>{{ csq.HGVSp|unesc|safe }}</span>`)">
                              <div class="relative flex inline-block">
                                <div id="{{csq.Feature}}-hgvsp-short" class="truncate max-w-15c">
                                  {{ csq.HGVSp|one_letter_p|unesc|safe }}
                                </div>
                                <div id="{{csq.Feature}}-hgvsp-full" class="hidden break-all whitespace-normal">
                                  {{ csq.HGVSp|one_letter_p|unesc|safe }}
                                </div>
                                <button class="ml-1 text-toggle hidden hover:text-blue-500 font-bold transition-transform duration-100 transform hover:scale-105"
                                        data-target="{{csq.Feature}}-hgvsp"
                                        onclick="toggleLongText(this)">
                                  [+]
                                </button>
                              </div>
                            </span>
                          {% else %}
                            -
                          {% endif %}
                          <!-- HGVSc Section -->
                          {% if csq.HGVSc and csq.HGVSc != "-" %}
                            <span class="relative cursor-pointer" onmouseover="showTooltip(event, `<span class='break-all inline-flex'>{{ csq.HGVSc|unesc|safe }}</span>`)">
                              <div class="relative flex inline-block">
                                <div id="{{csq.Feature}}-hgvsc-short" class="truncate max-w-15c">
                                  {{ csq.HGVSc|unesc|safe }}
                                </div>
                                <div id="{{csq.Feature}}-hgvsc-full" class="hidden break-all whitespace-normal">
                                  {{ csq.HGVSc|unesc|safe }}
                                </div>
                                <button class="ml-1 text-toggle hidden hover:text-blue-500 font-bold transition-transform duration-100 transform hover:scale-105"
                                        data-target="{{csq.Feature}}-hgvsc"
                                        onclick="toggleLongText(this)">
                                  [+]
                                </button>
                              </div>
                            </span>
                          {% else %}
                            -
                          {% endif %}
                        </td>

                        <!-- Exon -->
                        <td id="snv-table-row-exon" class="px-1">
                          {{ csq.EXON | default("-", true) | safe }}
                        </td>

                        <!-- Intron -->
                        <td id="snv-table-row-intron" class="px-1">
                          {{ csq.INTRON | default("-", true) | safe }}
                        </td>

                        <!-- Variant Type -->
                        <td class="px-1 lowercase relative" id="snv-table-row-type">
                          {% if var.variant_class in vep_var_class_translations %}
                              <span class="relative inline-block cursor-pointer"
                                    onmouseover="showTooltip(event, `{{ vep_var_class_translations[var.variant_class].desc | escape }}`)">
                                  {{ vep_var_class_translations[var.variant_class].short }}
                              </span>
                          {% else %}
                              <span class="cursor-pointer">
                                  {{ var.variant_class }}
                              </span>
                          {% endif %}
                        </td>

                        <!-- Indel Size -->
                        <td id="snv-table-row-indel-size" class="px-1">
                          {% if indel_size != 0 %}
                            {{ indel_size }} bp {% if indel_size < 0 %}DEL{% else %}INS{% endif %}
                          {% else %}
                            -
                          {% endif %}
                        </td>

                        <!-- Consequence -->
                        <td id="snv-table-row-conseq" class="lowercase h-full items-left align-middle px-1 py-1">
                          {% set consequences = csq.Consequence if csq.Consequence is iterable and csq.Consequence is not string else csq.Consequence.split('&') %}
                          {% for conseq in consequences %}
                            <div class=" inline-block mb-1 cursor-pointer p-1 rounded-full bg-gray-300"
                              onmouseover="showTooltip(event, `{% if conseq in vep_conseq_translations %}
                                <strong>{{ vep_conseq_translations[conseq].display }}</strong><br>
                                {{ vep_conseq_translations[conseq].desc }}<br>
                                <span class='text-yellow-400 font-bold'>Impact: {{ vep_conseq_translations[conseq].impact }}</span>
                              {% else %}
                                {{ conseq }}
                              {% endif %}`)">
                              {% if conseq in vep_conseq_translations %}
                                  {{ vep_conseq_translations[conseq].short }}
                              {% else %}
                                {{ conseq }}
                              {% endif %}
                            </div>
                          {% endfor %}
                        </td>

                        <!-- Population Frequency -->
                        <td class="font-semibold max-w-15c" id="snv-table-row-popFreq">
                          {% if "gnomad_frequency" in var and var.gnomad_frequency != "" %}
                            {{ var.gnomad_frequency|three_dec}}<br>
                          {% else %}
                            -
                          {% endif %}
                        </td>

                        <!-- Tier -->
                        <td class="font-semibold px-1" id="snv-table-row-class">
                          {% if var.classification.class != 999 and var.classification.transcript == csq.Feature %}
                            <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-tier{{ var.classification.class }} text-white shadow-md">
                              {% if assay_group in ["myeloid", "tumwgs"] or "assay" in var.classification %}
                                {{ var.classification.class }}
                              {% else %}
                                *
                              {% endif %}
                            </div>
                          {% elif var.additional_classification is not none %}
                            {% if var.additional_classification.tier %}
                              <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-gray-400 text-white shadow-md">
                                {{ var.additional_classification.tier }}
                              </div>
                            {% endif %}

                          {% elif var.other_classification|length > 0 %}
                            <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-gray-400 text-white shadow-md">
                              ?
                            </div>
                          {% else %}
                              -
                          {% endif %}
                        </td>

                        <!-- Chr:Pos -->
                        <td id="snv-table-row-chrPos" class="px-1">
                          <div class="inline-block px-2 py-1 font-semibold text-white rounded-full transition-all duration-200 ease-in-out hover:bg-blue-400 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300 bg-gray-400">
                              {{ igv_chr_pos|safe }}
                          </div>
                        </td>

                        <!-- Hotspot (Only Display if Assay is 'solid' and Hotspot Exists) -->
                        {% if assay_group == "solid" %}
                          <td  id="snv-table-row-hotspot">
                            {% if var.INFO.HOTSPOT %}
                              <div class="inline-block px-1 py-1 font-semibold text-white rounded-full">
                                {{ var.INFO.HOTSPOT|format_hotspot|safe }}
                              </div>
                            {% else %}

                            {% endif %}
                          </td>
                        {% endif %}

                        <!-- Flags -->
                        <td id="snv-table-row-flags" class="lowercase items-left align-middle px-1 py-1">
                          <div class="flex flex-wrap gap-0.5 items-center">
                              {{ var.FILTER|format_filter|safe }}
                          </div>
                        </td>

                        <!-- GT -->
                        {% for gt in var.GT|sort(attribute='type') %}
                          <td id="snv-table-row-{% if gt.type == 'case' %}case{% else %}control{% endif %}"
                              sorttable_customkey="{{ gt.AF }}" class="px-1 ">
                            <span class="{% if gt.DP < sample.filters.error_cov %} text-red-600 {% elif gt.DP < sample.filters.warn_cov %} text-orange-600 {% else %} text-gray-900 {% endif %}">
                              {{ '%0.1f'| format(100 * gt.AF|float) }}% ({{ gt.VD|int }} / {{ gt.DP|int }})
                          </td>
                        {% endfor %}

                        <!-- View -->
                        <td>
                          <a href="{{ url_for('dna_bp.show_variant', sample_id=sample.name, var_id=var._id) }}"
                              class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">
                            View
                          </a>
                        </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  {% if variants|length == 0 %}
                    <em class="block text-center text-gray-500 text-sm italic bg-gray-50 p-4 rounded-b-lg border border-gray-300 shadow-md">No variants found with current filter settings!</em>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </section>
      {% endif %}


      <!-- CNVs Container -->
      {% set has_cnv_image = sample.cnvprofile is not none %}
      {% if "CNV" in analysis_sections or has_cnv_image %}
        {% set cnvs = display_sections_data.get('cnvs', []) %}
        <section id="CNV" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative w-full">
          <!-- CNVs Header -->
          <div class="overflow-x-auto relative">
            <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">
              CNVs ({{ cnvs|length }})
            </h2>
          </div>

          <!-- Full-width Wrapper -->
          <div class="w-full flex justify-center py-2" id="cnvs-content">
            <!-- Inner Flexible Container -->
            <div class="w-full px-1 bg-transparent">

              <!-- Flex Container for CNV Image & Table -->
              <div class="flex flex-wrap gap-2 w-full bg-transparent cnv-container">

                <!-- CNV Image (Sticky Floating) -->
                {% if has_cnv_image %}
                  <div class="cnv-image bg-transparent py-2 px-1">
                    <!-- Header with Toggle Switch -->
                    <div class="flex justify-between items-center bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 tracking-wide capitalize ">
                      <h2 class="text-sm">
                        CNV Profile
                      </h2>
                      <!-- Toggle Switch -->
                      <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-800">Rotate</span>

                        <!-- Toggle Switch -->
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="cnv-image-rotate-toggle" class="sr-only">

                          <!-- Toggle Background -->
                          <div id="cnv-image-toggle-bg" class="w-16 h-7 rounded-full flex items-center relative transition-all duration-300">

                            <!-- Sliding Knob -->
                            <div id="cnv-image-toggle-knob" class="absolute bg-white h-6 w-6 rounded-full shadow-md transition-transform duration-300"></div>

                            <!-- Labels -->
                            <div class="absolute inset-0 flex justify-between items-center px-2">
                              <span id="cnv-image-deg-0" class="text-white transition-colors mr-1">0°</span>
                              <span id="cnv-image-deg-90" class="text-black transition-colors ml-3">90°</span>
                            </div>

                          </div>
                        </label>

                      </div>
                    </div>
                    <div class="rounded-b-lg shadow-md pt-4 sticky top-0">
                      {% set build = sample.genome_build if "genome_build" in sample else 37 %}
                      <!-- Image Container (Will be updated dynamically) -->
                      <div id="cnv-image-container" class="flex justify-center items-center">
                        <a id="cnv-image-link" href="{{ url_for('dna_bp.show_any_plot', sample_id=sample.name, fn=sample.cnvprofile|basename) }}" target="_blank">
                          <img id="cnv-image-img"
                            class="rounded-lg border border-gray-300 shadow-lg transition duration-300 ease-in-out transform "
                            src="{{ url_for('dna_bp.show_any_plot_rotated', sample_id=sample.name, fn=sample.cnvprofile|basename) }}"
                          >
                        </a>
                      </div>

                      <div class="text-center my-4 pb-2 flex flex-wrap gap-x-4 justify-center">
                        {% for type, sample_id in sample_ids.items() %}
                          <a href="{{app_config.GENS_URI}}/{{ sample_id }}?individual_id={{sample_id}}&case_id={{ sample.name }}&genome_build=38"
                              target="_blank"
                              class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">
                            Open <b>{{ sample_id }}</b> ({{ type }}) in Gens
                          </a><br>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                {% endif %}

                <!-- CNV Table -->
                {% if "CNV" in analysis_sections %}
                  <div class="cnv-table bg-transparent py-2">
                    <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
                      <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg p-2 z-10">
                        <h2 class="text-sm font-semibold text-black">CNV Table</h2>
                        {% if has_access("download_cnvs", min_role="user", min_level=9) %}
                          <img
                            src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}"
                            alt="Export to CSV - CNVs"
                            onclick="exportHTMLTable({ tableId:'cnvs-table', filename:'{{ sample.name }}.filtered.cnvs.csv' })"
                            class="w-6 h-6 transition-transform transform hover:scale-110"
                          />
                        {% endif %}
                      </div>
                      <div class="overflow-auto relative bg-transparent">
                        <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="cnvs-table">
                          <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                            <tr id="cnv-table-header" class="border-b text-left border-gray-800 ">
                              <th class="px-2 py-3 font-semibold" id="cnv-table-header-genes">Genes</th>
                              <th class="px-2 py-3 font-semibold" id="cnv-table-header-region">Region</th>
                              <th class="px-2 py-3 font-semibold" id="cnv-table-header-size">Size (bp)</th>
                              {% if assay_group in ["solid", "gmsonco"] %}
                                <th class="px-2 py-3 font-semibold" id="cnv-table-header-callers">Callers</th>
                              {% endif %}
                                <th class="px-2 py-3 font-semibold" id="cnv-table-header-cn">Copy number</th>
                              {% if sample.purity %}
                                <th class="px-1 py-3 font-semibold w-4" id="cnv-table-header-purity">Purity {{ sample.purity }}</th>
                              {% endif %}
                              {% if assay_group in ["solid", "gmsonco"] %}
                                <th class="px-1 py-3 font-semibold" id="cnv-table-header-sr">SR (ref/alt)</th>
                              {% endif %}
                              <th class="px-1 py-3 font-semibold w-4" id="cnv-table-header-status">Status</th>
                              <th class="px-1 py-3 font-semibold w-4" id="cnv-table-header-view">View</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for cnv in cnvs %}
                              {% if cnv.interesting %}
                                <tr class="bg-green-100 hover:bg-green-200 border-t border-gray-400 text-left" id="cnv-table-row-interesting">
                              {% elif cnv.ratio > 3 and cnv.size > (sample.filters.max_cnv_size|int) or cnv.fp %}
                                <tr class="bg-red-100 border-t border-gray-400 text-left" id="cnv-table-row">
                              {% elif cnv.noteworthy %}
                                <tr class="bg-brown-100 hover:bg-brown-200 border-t border-gray-400 text-left" id="cnv-table-row-noteworthy">
                              {% else %}
                                <tr class="border-t border-gray-400 text-left hover:bg-yellow-50" id="cnv-table-row">
                              {% endif %}

                                <!-- Genes -->
                                {% set cnv_genes_export = namespace(names=[], others=0) %}
                                {% for gene in cnv.genes %}
                                  {% if gene.class %}
                                    {% set _ = cnv_genes_export.names.append(gene.gene) %}
                                  {% else %}
                                    {% set cnv_genes_export.others = cnv_genes_export.others + 1 %}
                                  {% endif %}
                                {% endfor %}

                                <td class="pl-2 py-2.5 break-all pr-2"
                                    id="cnv-table-row-genes"
                                    data-export-value="{{ cnv_genes_export.names|join(', ') }}{% if cnv_genes_export.others > 0 %} + {{ cnv_genes_export.others }} other genes{% endif %}">
                                  {# render the existing view exactly as before #}
                                  {% if "KMT2A" in cnv_genes_export.names or "KMT2D" in cnv_genes_export.names %}
                                    <span class="bg-orange-500">
                                      {{ cnv_genes_export.names|join(', ') }}
                                    </span>
                                  {% else %}
                                    {{ cnv_genes_export.names|join(', ') }}
                                  {% endif %}
                                  {% if cnv_genes_export.others > 0 %}
                                    <span class="text-gray-400 text-xs"><br>+ {{ cnv_genes_export.others }} other genes</span>
                                  {% endif %}
                                </td>

                                <!-- Region -->
                                <td id="cnv-table-row-region">
                                  <div class="inline-block px-2 py-1 text-white rounded-full bg-gray-400">
                                    {{ cnv.chr }}:{{ cnv.start }}-{{ cnv.end }}
                                  </div>
                                </td>

                                <!-- Size -->
                                <td id="cnv-table-row-size">
                                  {{ cnv.size|abs }}
                                </td>

                                <!-- Callers -->
                                {% if assay_group in ["solid", "gmsonco"] %}
                                  <td id="cnv-table-row-callers">
                                    {{ cnv.callers }}
                                  </td>

                                  <!-- Copy Number for solid and gmsonco -->
                                  {% if "gatk" in cnv.callers or "cnvkit" in cnv.callers %}
                                    <td id="cnv-table-row-ratio">
                                      {{ 2*(2**cnv.ratio)|round(2) }} ({{ cnv.ratio }})
                                    </td>

                                    <!-- purity for solid -->
                                    {% if sample.purity %}
                                      {% if cnv.ratio > 0 %}
                                        <td class="w-4" id="cnv-table-row-purity">
                                          {{ (2*(2**cnv.ratio)*1/sample.purity)|round(2) }}
                                        </td>
                                      {% else %}
                                        <td class="w-4" id="cnv-table-row-purity">
                                          {{ (2*(2**cnv.ratio)*sample.purity)|round(2) }}
                                        </td>
                                      {% endif %}
                                    {% endif %}
                                    {% if "manta" in cnv.callers %}
                                      <td id="cnv-table-row-pr">
                                        {{ cnv.PR }}
                                      </td>
                                    {% else %}
                                      <td id="cnv-table-row-pr">
                                        -
                                      </td>
                                    {% endif %}
                                  {% else %}
                                    {% if assay_group == "solid" %}
                                      <td id="cnv-table-row-pr">
                                        -
                                      </td>
                                    {% endif %}
                                    <td id="cnv-table-row-pr">
                                      -
                                    </td>
                                    <td id="cnv-table-row-pr">
                                      {{ cnv.PR }}
                                    </td>
                                  {% endif %}
                                {% else %}
                                  <td id="cnv-table-row-ratio">
                                    {{ 2*(2**cnv.ratio)|round(2) }} ({{ cnv.ratio }})
                                  </td>
                                {% endif %}
                                <td class="w-4" id="cnv-table-row-status">
                                  {% if cnv.interesting %}
                                    report
                                  {% elif cnv.fp %}
                                    false positive
                                  {% elif cnv.noteworthy %}
                                    noteworthy
                                  {% endif %}
                                </td>
                                <td class="w-4" id="cnv-table-row-view">
                                  <a href="{{ url_for('dna_bp.show_cnv', sample_id=sample.name, cnv_id=cnv._id) }}" class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">view</a>
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                        {% if cnvs|length == 0 %}
                          <em class="block text-center text-gray-500 text-sm italic bg-gray-50 p-4 rounded-b-lg border border-gray-300 shadow-md">
                            No cnvs found with the current filter settings!
                            <br>
                          </em>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div> <!-- End Flex Container -->
            </div> <!-- End Inner Dynamic Container -->
          </div> <!-- End Full-width Wrapper -->
        </section>
      {% endif %}

      <!-- Translocations Card -->
      {% if "TRANSLOCATION" in analysis_sections %}
        {% set transloc = display_sections_data.translocs %}
        <section id="TRANSLOCATION" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
          <!-- Translocs Header -->
          <div class="overflow-x-auto relative">
            <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Translocations ({{ transloc|length }})</h2>
          </div>

          <div class="mx-auto py-2 " id="transloc-content">
            <div class="flex flex-wrap gap-4 ">
              <!-- Translocations Table -->
              <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
                <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
                  <h2 class="text-sm font-semibold text-black">Gene fusions passing filter criteria</h2>
                  {% if has_access("download_translocs", min_role="user", min_level=9) %}
                    <img
                      src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}"
                      alt="Export to CSV - translocations"
                      onclick="exportHTMLTable({ tableId:'transloc-table', filename:'{{ sample.name }}.filtered.translocs.csv' })"
                      class="w-6 h-6 transition-transform transform hover:scale-110"
                    />
                  {% endif %}
                </div>
                <div class="overflow-auto relative">
                  <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="transloc-table">
                    <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                      <tr id="transloc-table-header" class="border-b text-left border-gray-800">
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-gene1">Gene 1</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-gene2">Gene 2</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-positions">Positions</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-type">Type</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-hgvs">HGVS</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-panel">Panel</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-status">Status</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-view">View</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for tl in transloc %}
                        {% set ANN = tl.INFO.MANE_ANN or tl.INFO.ANN[0] %}
                        {% set genes = ANN.Gene_Name.split('&') %}
                        {% if tl.interesting %}
                          <tr class="bg-green-100 hover:bg-green-200 border-t border-gray-400 text-left" id="transloc-table-row-interesting">
                        {% else %}
                          <tr class="border-t border-gray-400 text-left hover:bg-yellow-50" id="transloc-table-row">
                        {% endif %}

                          <td class="pl-2 py-2.5" id="transloc-table-row-gene1">
                            {{ genes[0] }}
                          </td>
                          <td id="transloc-table-row-gene2">
                            {{ genes[1] }}
                          </td>
                          <td id="transloc-table-row-positions">
                            {{ tl.CHROM }}:{{ tl.POS }} {{ tl.ALT }}
                          </td>
                          <td id="transloc-table-row-type">
                            {% for annot in ANN.Annotation %}
                              {{ annot }}<br>
                            {% endfor %}
                          </td>
                          <td id="transloc-table-row-hgvs">
                            {{ ANN.HGVSp|unesc }}<br>{{ ANN.HGVSc|unesc }}
                          </td>
                          <td id="transloc-table-row-panel">
                            {{ tl.INFO.PANEL }}
                          </td>
                          <td id="transloc-table-row-status">
                            {% if tl.interesting %}
                              report
                            {% endif %}
                          </td>
                          <td id="transloc-table-row-view">
                            <a href="{{ url_for('dna_bp.show_transloc', sample_id=sample.name, transloc_id=tl._id) }}" class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">view</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                  {% if transloc|length == 0 %}
                    <em class="block text-center text-gray-800 text-sm italic bg-gray-100 p-4 rounded-b-lg border border-gray-300 shadow-md">
                      No translocations found with the current filter settings!
                    </em>
                {% endif %}
              </div>
            </div>
          </div>
        </section>
      {% endif %}

      <!-- Fusion Card -->
      {% if "FUSION" in analysis_sections %} <!-- TODO: CHECK THIS WITH TEST DATA -->
        {% set fusions = display_sections_data.fusions %}
        <section id="FUSION" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
          <!-- Fusions Header -->
          <div class="overflow-x-auto relative">
            <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">DNA Fusions ({{ fusions|length }})</h2>
          </div>

          <div class="mx-auto py-2 " id="fusions-content">
            <div class="flex flex-wrap gap-4 ">
              <!-- Fusions Table -->
              <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
                <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-200 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
                  <h2 class="text-sm font-semibold text-black">DNA fusions passing filter criteria</h2>
                  {% if has_access("download_fusions", min_role="user", min_level=9) %}
                    <img
                      src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}"
                      alt="Export to CSV - fusions"
                      onclick="exportHTMLTable({ tableId:'fusions-table', filename:'{{ sample.name }}.filtered.fusions.csv' })"
                      class="w-6 h-6 transition-transform transform hover:scale-110"
                    />
                  {% endif %}
                </div>
                <div class="overflow-auto relative">
                  <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="fusions-table">
                    <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                      <tr id="fusions-table-header" class="border-b text-left border-gray-800">
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-gene1">Gene 1</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-gene2">Gene 2</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-effect">Effect</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-spanpairs">Spanning pairs</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-unique-spanpairs" data-autoclick="true">Unique spanning reads</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-fusion-points">Fusion points</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-tier">Tier</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-desc">Description</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-callers">Callers</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-view">View</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for fus in fusions %}
                        {% set genes = fus.genes.split('^') %}
                        {% set sel_fus = (fus.calls|selectattr('selected', 'equalto', 1) |list)[0] %}
                        {% if fus.blacklisted or fus.fp %}
                          <tr class="bg-red-200 opacity-60 hover:bg-red-300 border-t border-gray-400 text-left"id="fusions-table-row-blacklisted">
                        {% else %}
                          <tr class="border-t border-gray-400 text-left hover:bg-yellow-50" id="fusions-table-row">
                        {% endif %}
                          <td class="pl-2 py-2.5" id="fusions-table-row-gene1">
                            {{ genes[0] }}
                          </td>
                          <td id="fusions-table-row-gene2">
                            {{ genes[1] }}
                          </td>
                          <td id="fusions-table-row-effect">
                            {{ sel_fus.effect }}
                          </td>
                          <td id="fusions-table-row-spanpairs">
                            {{ sel_fus.spanpairs }}
                          </td>
                          <td id="fusions-table-row-unique-spanpairs">
                            {{ sel_fus.spanreads }}
                          </td>
                          <td id="fusions-table-row-fusion-points">
                            {{ sel_fus.breakpoint1 }}<br>{{ sel_fus.breakpoint2 }}
                          </td>
                          <td class="py-2 px-3 border-b border-gray-300 varlist" sorttable_customkey="{{ fus.classification.class }}"  id="fusions-table-row-tier">
                            {% if fus.classification.class != 999 %}
                              <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-tier{{ fus.classification.class }} text-white shadow-md">
                                {{ fus.classification.class }}
                              </div>
                            {% endif %}
                          </td>
                          <td id="fusions-table-row-desc">
                            {{ sel_fus.desc|format_fusion_desc|safe }}
                          </td>
                          <td id="fusions-table-row-callers">
                            {{ fus.calls|uniq_callers|join("<br>")|safe }}
                          </td>
                          <td id="fusions-table-row-view">
                            <a href="{{ url_for('dna_bp.show_fusion', sample_id=sample.name, id=fus._id) }}" class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">view</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% if fusions|length == 0 %}
                  <em class="block text-center text-gray-800 text-sm italic bg-gray-100 p-4 rounded-b-lg border border-gray-300 shadow-md">
                    No fusions found with the current filter settings!
                  </em>
                {% endif %}
              </div>
            </div>
          </div>
        </section>
      {% endif %}


      <!-- Summary Comments Card -->
      <section id="SUMMARY" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
        <!-- Summary Header -->
        <div class="overflow-x-auto relative">
          <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Summary</h2>
        </div>

        <div class="mx-auto py-2 " id="summary-content">
          <div class="flex flex-wrap gap-4 ">
            <!-- Summary comments Table -->
            <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
              <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-blue-200 to-green-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
                <h2 class="text-sm font-semibold text-black">Summary Comments</h2>
              </div>
              <div class="overflow-auto relative">
                <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="summary-table">
                  <thead class="sortable capitalize tracking-wide rounded-t-lg bg-green-100">
                    <tr id="summary-table-header" class="border-b text-left border-gray-800">
                      <th class="px-2 py-3 font-semibold" id="comments-table-header-who">Who</th>
                      <th class="px-2 py-3 font-semibold" id="comments-table-header-comment">Comment</th>
                      <th class="px-2 py-3 font-semibold" id="comments-table-header-view">Hide/Unhide</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if sample.comments|length > 0 %}
                      {% for comment in sample.comments|sort(attribute='time_created', reverse=True) %}
                        {% if comment.hidden != 1 %}
                          <tr class="hover:bg-green-50 border-t border-gray-400 text-left" id="comment-table-row">
                        {% else %}
                          <tr class="bg-red-200 opacity-60 hover:bg-red-300 border-t border-gray-400 text-left hidden hidden_comment" id="comment-table-row-hidden">
                        {% endif %}
                          <td class="px-2 whitespace-nowrap align-top py-4" id="comments-table-header-who">
                            <b>{{ comment.author }}</b><br><small>{{ comment.time_created|human_date }}</small>
                          </td>
                          <td class="p-2" id="comments-table-header-comment" onclick='addText(event)'>
                            {{ comment.text|format_comment|safe }}
                          </td>
                          <td class="px-2 align-top py-4" id="comments-table-header-view">
                            {% set hidden_exists = 0 %}
                            {% if comment.hidden != 1 %}
                              <form action="{{ url_for('common_bp.hide_sample_comment', sample_id=sample._id) }}#summary" method="post">
                                <input type="hidden" name="comment_id" value="{{ comment._id }}">
                                <input id="hide_comment" type="image" class="w-5 {% if not has_access('hide_sample_comment', min_role='manager', min_level=99) %} opacity-70 select-none cursor-not-allowed pointer-events-none {% endif %}" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye-slash.svg') }}">
                              </form>
                            {% else %}
                              {% set hidden_exists = 1 %}
                              <form action="{{ url_for('common_bp.unhide_sample_comment', sample_id=sample._id) }}#summary" method="post">
                                <input type="hidden" name="comment_id" value="{{ comment._id }}">
                                <input id="unhide_comment" type="image" class="w-5 {% if not has_access('unhide_sample_comment', min_role='manager', min_level=99) %} opacity-70 select-none cursor-not-allowed pointer-events-none {% endif %}" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye.svg') }}">
                              </form>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                      {% if hidden_comments %}
                        <tr>
                          <td colspan=4 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                            <a href="javascript:void(0)" onclick="switchVisibility('hidden_comment')"><b>Show/hide deleted comments</b></a>
                          </td>
                        </tr>
                      {% endif %}
                    {% else %}
                      <tr>
                        <td colspan=4 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                          No comments available.
                        </td>
                      </tr>
                    {% endif %}
                  <tbody>
                </table>
              </div>
            </div>

            <!-- Add Comment Form -->
            {% if has_access('add_sample_comment', min_role='user', min_level=9) %}
              <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
                <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-blue-200 to-green-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
                  <h2 class="text-sm font-semibold text-black">Write New Summary</h2>
                </div>
                <div class="overflow-auto relative" id="comments-box-div">
                  <form action="{{ url_for('common_bp.add_dna_sample_comment', sample_id=sample._id) }}" method="post">
                    <textarea id="comment_textarea"
                              name="sample_comment"
                              placeholder="Type to write a new summary for {{ sample.name }} sample..."
                              class="w-5/6 p-4 border border-gray-400 rounded mx-5 my-4 h-40"></textarea>

                    <!-- Buttons Row -->
                    <div class="flex flex-wrap items-center gap-4 mx-5 mb-5">
                      <input type="submit"
                            value="Save"
                            class="p-2 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg cursor-pointer">

                      <button type="button"
                              onclick="addAIText()"
                              class="p-2 text-black bg-gray-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-gray-500 hover:text-white hover:shadow-lg cursor-pointer">
                        Suggest
                      </button>
                      {% if has_access('preview_report', min_role='user', min_level=9) %}
                        <button type="button"
                                onclick="window.location.href='{{ url_for('dna_bp.generate_dna_report', sample_id=sample.name) }}'"
                                class="p-2 text-black bg-green-400 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-green-500 hover:text-white hover:shadow-lg cursor-pointer">
                          Preview Report
                        </button>
                      {% endif %}
                    </div>
                  </form>

                  <!-- AI suggestion box -->
                  <div id="suggestion" class="hidden">
                    {{ ai_text }}
                  </div>
                </div>
              </div>
            {% endif %}

          </div>
        </div>
      </section>

    </main>


    <!-- Right Filter Sidebar -->
    {% include "variant_sidebars.html" %}

  </div>

  <script>


    function showCheckboxes(id, iconId) {
      let checkboxes = document.getElementById(id);
      let icon = document.getElementById(iconId);

      if (checkboxes.classList.contains("hidden")) {
        checkboxes.classList.remove("hidden");
        if (icon) icon.classList.add("rotate-180"); // Rotates the dropdown arrow
      } else {
        checkboxes.classList.add("hidden");
        if (icon) icon.classList.remove("rotate-180");
      }
    }

    // JavaScript for rotating the cnv image functionality
    document.addEventListener("DOMContentLoaded", function () {
      let toggle = document.getElementById("cnv-image-rotate-toggle");
      let knob = document.getElementById("cnv-image-toggle-knob");
      let bg = document.getElementById("cnv-image-toggle-bg");
      let deg0 = document.getElementById("cnv-image-deg-0");
      let deg90 = document.getElementById("cnv-image-deg-90");
      let imageElement = document.getElementById("cnv-image-img");
      let imageLink = document.getElementById("cnv-image-link");

      // Store original and rotated image URLs
      let originalImage = "{{ url_for('dna_bp.show_any_plot', sample_id=sample.name, fn=sample.cnvprofile|basename) }}";
      let rotatedImage = "{{ url_for('dna_bp.show_any_plot_rotated', sample_id=sample.name,  fn=sample.cnvprofile|basename) }}";

      function updateToggleState() {
          if (toggle.checked) {
              // Move knob to right, change background color, update image
              knob.style.transform = "translateX(36px)";
              bg.style.backgroundColor = "#e4a787";
              deg0.style.color = "white";
              deg90.style.color = "black";

              imageElement.src = rotatedImage;
          } else {
              // Move knob to left, reset background color, update image
              knob.style.transform = "translateX(0px)";
              bg.style.backgroundColor = "#74a9d4";
              deg0.style.color = "black";
              deg90.style.color = "white";

              imageElement.src = originalImage;
          }
      }

        // Ensure slider starts at 90° (checked) on page load
        // toggle.checked = true;
        updateToggleState();

        // Add event listener for toggle change
        toggle.addEventListener("change", updateToggleState);
    });


    function addAIText() {
      var suggestion = document.getElementById("suggestion").innerHTML.trim();
      document.getElementById("comment_textarea").value = suggestion;
    }

    function addText(event) {
      var targ = event.target || event.srcElement;
      if (!targ.closest('tr').classList.contains('hidden_comment')) {
        document.getElementById("comment_textarea").value = targ.textContent || targ.innerText;
      }
    }

    function addText(event) {
      var targ = event.target || event.srcElement;
      if (!targ.closest('tr').classList.contains('hidden_comment')) {
        const textarea = document.getElementById('comment_textarea');
        const text = event.target.innerText.trim();
        textarea.value = text;
      }
    }

    window.onload = function () {
      document.querySelectorAll('[data-autoclick="true"]').forEach(element => element.click());
      document.querySelectorAll('[data-autoclick-once="true"]').forEach(element => element.click());
    };

    var expanded = false;
    function toggleFilters() {
      var filterCard = document.getElementById("filter_card");
      filterCard.style.display = expanded ? "none" : "block";
      expanded = !expanded;
    }


    function show_germlinecnv(button) {
      var germlineDiv = document.getElementById("germline_div");

      if (germlineDiv.style.display === "none") {
          germlineDiv.style.display = "";
          button.classList.remove("bg-gray-400", "hover:bg-gray-500");
          button.classList.add("bg-green-500", "hover:bg-green-600");
      } else {
          germlineDiv.style.display = "none";
          button.classList.remove("bg-green-500", "hover:bg-green-600");
          button.classList.add("bg-gray-400", "hover:bg-gray-500");
      }
    }




    function switchVisibility(class_name, button) {
      var elems = document.getElementsByClassName(class_name);

      // Toggle visibility for all elements with the class
      for (var i = 0; i < elems.length; i++) {
          elems[i].classList.toggle('hidden');
      }

      // Toggle button text and color
      if (button.textContent.includes("Hide")) {
          button.textContent = button.textContent.replace("Hide", "Show");
          button.classList.remove("bg-gray-400", "hover:bg-gray-500");
          button.classList.add("bg-green-500", "hover:bg-green-600");
      } else {
          button.textContent = button.textContent.replace("Show", "Hide");
          button.classList.remove("bg-green-500", "hover:bg-green-600");
          button.classList.add("bg-gray-400", "hover:bg-gray-500");
      }
    }



    // JavaScript for Expand/Collapse functionality
    function toggleCard(cardId) {
      var card = document.getElementById(cardId);
      var arrowIcon = card.parentElement.querySelector('#arrow-icon');

      if (card.classList.contains('hidden')) {
        card.classList.remove('hidden'); // Show the content
        arrowIcon.classList.remove('rotate-180'); // Rotate arrow downwards
      } else {
        card.classList.add('hidden'); // Hide the content
        arrowIcon.classList.add('rotate-180'); // Reset arrow to upwards
      }
    }

    // Export csv function this is a basic function for ow, can be customized and improved later on
    function exportTableToCSV(filename, tableId) {
      // Get the table element by its ID
      const table = document.getElementById(tableId);
      if (!table) {
        console.error(`Table with ID "${tableId}" not found.`);
        return;
      }

      let csv = [];

      // Get all rows from the table
      const rows = table.querySelectorAll('tr');

      // Loop through each row
      rows.forEach((row) => {
        let rowData = [];
        const cells = row.querySelectorAll('th, td'); // Get header and data cells
        cells.forEach((cell) => {
          // Extract text content and replace line breaks with ";"
          let cellContent = cell.innerText.replace(/\n/g, ';').trim();
          rowData.push(cellContent);
        });
        csv.push(rowData.join(',')); // Join cells with a comma
      });

      // Convert the array to a CSV string
      const csvString = csv.join('\n');

      // Create a Blob and download the CSV file
      const blob = new Blob([csvString], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }


    // UNIVERSAL: works for SNVs, CNVs, fusions, coverage, etc.
    function exportHTMLTable({
      tableId,
      filename = "export.csv",
      delimiter = ",",
      includeHeaders = true,
      includeHiddenRows = false,
      onlySelected = false,
      selectedRowsSelector = 'input.row-select:checked',
      includeBOM = true,
      } = {}) {
      const table = document.getElementById(tableId);
      if (!table) return console.error(`Table "${tableId}" not found`);

      // ---------- helpers ----------
      const q  = (sel, ctx=document) => ctx.querySelector(sel);
      const qa = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
      const isVisible = el => includeHiddenRows || !!(el.offsetParent !== null || el.getClientRects().length);
      const S = (s) => (s ?? "").toString().replace(/\r?\n|\r/g, " ").replace(/\s+/g, " ").trim();

      // CSV escaper (quote only when needed)
      function csvEscape(val, delim = delimiter) {
        const s = (val ?? "").toString();
        const need = s.includes('"') || s.includes(delim) || /\r|\n/.test(s);
        return need ? `"${s.replace(/"/g, '""')}"` : s;
      }

      // Guard against Excel auto-conversion WITHOUT formulas (use leading apostrophe)
      function protectExcel(val) {
        const s = (val ?? "").toString().trim();
        if (!s) return s;
        const month = "(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)";
        const fraction      = /^\d+\s*\/\s*\d+$/i;              // 24/25
        const date1         = /^\d{1,2}[-/]\d{1,2}([-/]\d{2,4})?$/; // 06-12, 6/12/24
        const monthDashYear = new RegExp(`^${month}-\\d{1,4}$`, "i"); // Jun-15
        const longDigits    = /^\d{15,}$/;                      // 15+ digits
        const leadingZeros  = /^0\d+$/;                         // 00123
        const timeLike      = /^\d+:\d+(:\d+)?$/;               // 12:34, 1:2:3
        const sci           = /^\d+(\.\d+)?e[+-]?\d+$/i;        // 1e5, 1.2E+10

        const risky = fraction.test(s) || date1.test(s) || monthDashYear.test(s) ||
                      longDigits.test(s) || leadingZeros.test(s) || timeLike.test(s) || sci.test(s);

        // Prefix apostrophe to keep it as text in Excel; no formula.
        return risky ? `'${s}` : s;
      }

      // Strip UI toggles like "[+]"
      const stripToggles = (s) => S((s ?? "").toString().replace(/\[\+\]/g, ""));

      // Clean header text (remove arrows & mojibake)
      function cleanHeaderText(th) {
        if (th.hasAttribute("data-export-skip")) return "";
        const clone = th.cloneNode(true);
        clone.querySelectorAll(".sortarrow,.sorttable_sortfwdind,.sorttable_sortrevind,[aria-hidden='true']").forEach(n => n.remove());
        let txt = S(clone.textContent);
        txt = txt.replace(/[▲△▼▽▴▾▵▿↕⇅]/g, "");      // real arrows
        txt = txt.replace(/â–¼|â–²|â–¾|â–½/g, "");     // mojibake arrows
        return S(txt);
      }

      // Explicit export values
      function explicitValues(root) {
        const vals = [];
        if (root.dataset?.exportValue) vals.push(root.dataset.exportValue);
        qa("[data-export-value]", root).forEach(el => vals.push(el.dataset.exportValue));
        return vals.map(S).filter(Boolean);
      }

      // Prefer hidden/full text blocks (works for HGVS-style cells)
      function fullTexts(root) {
        const vals = [];
        qa('[data-full], .full, [hidden], .hidden, [id$="-full"]', root)
          .forEach(el => vals.push(S(el.textContent)));
        return vals.filter(Boolean);
      }

      // Collect chip/label tokens from LEAF nodes only (no containers)
      function leafTokens(td) {
        const leaves = qa("*", td).filter(el => el.children.length === 0);
        const tokens = leaves.map(el => S(el.textContent)).filter(Boolean);
        // Expand composites like LOSB -> LO | SB (2-char chunks), dedupe, remove empties
        const expanded = [];
        tokens.forEach(tok => {
          if (/^[A-Z]{4,}$/.test(tok) && tok.length % 2 === 0) {
            for (let i = 0; i < tok.length; i += 2) expanded.push(tok.slice(i, i + 2));
          } else {
            expanded.push(tok);
          }
        });
        const out = [];
        const seen = new Set();
        expanded.forEach(t => {
          const v = S(t);
          if (v && !seen.has(v)) { seen.add(v); out.push(v); }
        });
        return out;
      }

      // Icons → get a label from alt/title/aria or known filenames
      function iconLabel(td) {
        const icon = td.querySelector("img,svg,[role='img']");
        if (!icon) return "";
        const aria = icon.getAttribute?.("aria-label");
        const title = icon.getAttribute?.("title");
        const alt = icon.getAttribute?.("alt");
        const svgTitle = icon.tagName === "SVG" ? (icon.querySelector("title")?.textContent) : null;
        const label = aria || title || alt || svgTitle;
        if (label) return S(label);

        // Fallback: map common filenames used in your UI
        const src = icon.getAttribute?.("src") || "";
        if (src.includes("x-circle")) return "False positive";
        if (src.includes("no-symbol")) return "Blacklisted";
        if (src.includes("exclamation-circle")) return "Interesting";
        if (src.includes("x-mark")) return "Irrelevant";
        return "";
      }

      // Extract a single cell's export value (generic)
      function extractCellValue(td) {
        if (td.hasAttribute("data-export-skip")) return "";

        // 1) explicit
        const explicit = explicitValues(td);
        if (explicit.length) return explicit.join(" | ");

        // 2) full/hidden texts
        const full = fullTexts(td);
        if (full.length) return full.join(" | ");

        // 3) chips/labels from leaf nodes
        const chips = leafTokens(td);
        if (chips.length >= 2) return chips.join(" | ");
        if (chips.length === 1) return chips[0];

        // 4) link → visible text
        const a = td.querySelector("a[href]");
        if (a) return S(a.textContent);

        // 5) icons
        const iLabel = iconLabel(td);
        if (iLabel) return iLabel;

        // 6) fallback: plain text
        return S(td.textContent);
      }

      // ---------- headers ----------
      const ths = qa("thead tr th", table);
      const headerTexts = ths.map(cleanHeaderText);
      const skipColIdx = ths.findIndex(th => th.querySelector('input[type="checkbox"]'));

      // ---------- rows ----------
      let rows = qa("tbody tr", table).filter(isVisible);
      if (onlySelected) {
        const selected = new Set(qa(selectedRowsSelector, table).map(cb => cb.closest("tr")).filter(Boolean));
        rows = rows.filter(tr => selected.has(tr));
      }

      const lines = [];

      // header line
      if (includeHeaders && ths.length) {
        const headers = headerTexts
          .map((h, i) => (i === skipColIdx || ths[i].hasAttribute("data-export-skip")) ? "" : h)
          .filter((_, i) => i !== skipColIdx)
          .map(stripToggles)
          .map(protectExcel)           // very rare for headers, but safe
          .map(v => csvEscape(v, delimiter));
        lines.push(headers.join(delimiter));
      }

      // data lines
      rows.forEach(tr => {
        const cells = qa("td,th", tr);
        const rowOut = [];
        for (let i = 0; i < cells.length; i++) {
          if (i === skipColIdx) continue;
          const td = cells[i];
          if (!td) { rowOut.push(""); continue; }

          let v = extractCellValue(td);
          v = stripToggles(v);     // remove [+] anywhere
          v = v.replace(/\s*\|\s*\|\s*/g, " | ");  // collapse double pipes
          v = v.replace(/\s*\|\s*$/g, "");         // trim trailing pipe
          v = v.replace(/^\s*\|\s*/g, "");         // trim leading pipe

          v = protectExcel(v);
          rowOut.push(csvEscape(v, delimiter));
        }
        lines.push(rowOut.join(delimiter));
      });

      // download
      const csv = lines.join("\n");
      const blobParts = includeBOM ? [new Uint8Array([0xef, 0xbb, 0xbf]), csv] : [csv];
      const blob = new Blob(blobParts, { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }




  </script>


{% endblock %}
