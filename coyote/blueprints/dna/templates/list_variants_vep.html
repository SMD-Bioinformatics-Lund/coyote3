{% extends "layout.html" %}

{% block style %}
<style>
  /* CNV Image */
  .cnv-image {
    flex: 1;
    min-width: 30%;  /* Image should be at least 30% */
    max-width: 100%; /* Can expand fully if table is missing */
  }
  
  /* CNV Table */
  .cnv-table {
    flex: 2;
    min-width: 60%;  /* Table should be at least 50% */
    max-width: 100%; /* Can expand fully if image is missing */
  }

  /* If Only One Exists, It Takes Full Width */
  .cnv-container:has(.cnv-image) .cnv-table:only-child {
    flex: 0 0 100%;
    max-width: 100%;
  }
  .cnv-container:has(.cnv-table) .cnv-image:only-child {
    flex: 0 0 100%;
    max-width: 100%;
  }
  
  /* Move Table Below on Small Screens */
  @media (max-width: 1024px) {
    .cnv-image,
    .cnv-table {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
  
  /* Make Image Float While Table Scrolls */
</style>
{% endblock %}



{% block body %}
<!-- FLEX CONTAINER: Sidebar (Fixed) + Main Content (Scrollable) + Filter Content Right Sidebar (Fixed)-->

<div class="flex w-full h-full overflow-hidden">

  <!-- LEFT SIDEBAR (Fixed Width, Full Height) -->
  <aside class="w-8 bg-transparent text-white flex flex-col">
    <div class="flex border-l-8 border-yellow-500 mt-1">
      <a href="#snv-indels" 
        class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
          <span class="vertical-text">SNVs</span>
      </a>
    </div>

    {% if cnvwgs or sample.cnvprofile %}
      <div class="flex border-l-8 border-yellow-500">
        <a href="#cnvs" 
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">CNVs</span>
        </a>
      </div>
    {% endif %}

    {% if transloc %}
      <div class="flex border-l-8 border-yellow-500">
        <a href="#translocs" 
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">TransLocs</span>
        </a>
      </div>
    {% endif %}

    {% if fusions %}
      <div class="flex border-l-8 border-yellow-500 ">
        <a href="#fusions" 
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">Fusions</span>
        </a>
      </div>
    {% endif %}

    <div class="flex border-l-8 border-teal-500 mt-1">
      <a href="#summary" 
        class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
          <span class="vertical-text">Summary</span>
      </a>
    </div>

    <div class="flex border-l-8 border-orange-500 mt-1">
      <a href="#lowcov" 
        class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
          <span class="vertical-text">Low Cov</span>
      </a>
    </div>
  </aside>

  <!-- MAIN CONTENT (Scrollable & Auto-Resizing) -->
  <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col">

    <!-- Sample Info Card (Auto-Wrapping, Full Flexbox) -->
    <section class="bg-blue-50 px-2 py-1 my-2 flex flex-wrap justify-between w-full shadow-lg rounded-xl relative gap-2 z-0" id="sample-info">

      <!-- Sample Name (Will Wrap if Needed) -->
      <div class="text-sm font-semibold text-black flex items-center pl-2">
        Sample:
        <a href="{{ url_for('dna_bp.list_variants', id=sample.name) }}" class="ml-2 font-semibold text-blue-500 hover:underline">
          {{ sample.name }}
        </a>
      </div>

      <!-- Sample Meta Information (Wraps Naturally) -->
      <div id="sample-meta-info" class="pr-2 flex flex-wrap text-xs text-gray-700 font-medium items-center space-x-1">
        
        {% if "subpanel" in sample %}
          <div class="flex items-center">
            <span class="font-semibold ">Type:</span> 
            <span class="ml-1 text-black">{{ sample.subpanel }}</span>
          </div>
        {% endif %}

        {% if assay == "solid" %}
          {% if "purity" in sample %}
            <span class="text-base font-light pb-1">|</span>
            <div class="flex items-center">
              <span class="font-semibold ">Purity:</span> 
              <span class="ml-1 text-black">{{ sample.purity * 100 }}%</span>
            </div>
          {% endif %}

          {% if biomarker and biomarker.count() > 0 %}
            {% for bio in biomarker %}
              {% if "MSIS" in bio %}
                <span class="text-base font-light pb-1">|</span>
                <div class="flex items-center inline-block cursor-pointer" onmouseover="showTooltip(event, `<span class='text-yellow-400'>Total: {{ bio.MSIS.tot }}<br>Somatic: {{ bio.MSIS.som }}</span>`)">
                  <span class="font-semibold ">MSI (Single):</span>
                  <span class="ml-1 text-black">{{ bio.MSIS.perc }}%</span>
                </div>
              {% endif %}

              {% if "MSIP" in bio %}
                <span class="text-base font-light pb-1">|</span>
                <div class="flex items-center inline-block cursor-pointer" onmouseover="showTooltip(event, `<span class='text-yellow-400'>Total: {{ bio.MSIP.tot }}<br>Somatic: {{ bio.MSIP.som }}</span>`)">
                  <span class="font-semibold ">MSI (Paired):</span>
                  <span class="ml-1 text-black">{{ bio.MSIP.perc }}%</span>
                </div>
              {% endif %}

              {% if "HRD" in bio %}
                <span class="text-base font-light pb-1">|</span>
                <div class="flex items-center inline-block cursor-pointer" onmouseover="showTooltip(event, `<span class='text-yellow-400'>TAI: {{ bio.HRD.tai }}<br>HRD: {{ bio.HRD.hrd }}<br>LST: {{ bio.HRD.lst }}</span>`)">
                  <span class="font-semibold ">HRD:</span>
                  <span class="ml-1 text-black">{{ bio.HRD.sum }}</span>
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
    </section>

    <!-- Selected Gene Panel Card -->
    {% include "selected_gene_panel_div.html" %}

    <!-- SNVs & Indels Card -->
    <section id="snv-indels" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
      <!-- SNV/Indels Header -->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">SNVs/Indels ({{ variants|length }})</h2>
      </div>
      
      <div class="mx-auto py-2 " id="snvs-content">
        <div class="flex flex-wrap gap-4">
          <!-- SNVs/Indels Table -->
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Variants Passing Filter Criteria</h2>
              <img 
                src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}" 
                alt="Export to CSV - SNVs" 
                onclick="exportTableToCSV('{{ sample.name }}.filtered.snvs.csv', 'snvs-table')" 
                class="w-6 h-6 transition-transform transform hover:scale-110"
              />
            </div>
            {% if variants|length > 0 %}
              <div class="overflow-auto relative">
                <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="snvs-table">
                  <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                    <tr id="variant-table-header" class="border-b text-left border-gray-800">
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-checkbox" data-nosort="true">
                        <input type="checkbox" id="select-all-table" onclick="toggleSelectAllVariants(this)">
                      </th>
                      <th class="py-3 font-semibold w-3" id="variant-table-header-blacklisted" data-nosort="true"></th>
                      <th class="py-3 font-semibold w-4" id="variant-table-header-comments" data-nosort="true"></th>
                      <th class="py-3 font-semibold w-4" id="variant-table-header-interesting-irrelevant" data-nosort="true"></th>
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-gene">Gene</th>
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-hgvs">HGVS</th>
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-type">Type</th>
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-conseq">Consequence</th>
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-popFreq">PopFreq %</th>
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-tier">Tier</th>
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-chrPos">Chr:Pos</th>
                      {% if assay == "solid" %}
                        <th class="py-3 font-semibold" id="variant-table-header-hotspot">Hotspot</th>
                      {% endif %}
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-flags">Flags</th>
                      {% for gt in variants[0].GT|sort(attribute='type') %}
                        {% if gt.type == "case" %}
                          <th {% if assay == "myeloid" %}data-autoclick="true"{% endif %} class="px-1 py-3 font-semibold" id="variant-table-header-case">{{ gt.type }} ({{gt.sample}})</th>
                        {% else %}
                          <th class="px-2 py-3 font-semibold" id="variant-table-header-control">{{ gt.type }} ({{gt.sample}})</th>
                        {% endif %}
                      {% endfor %}
                      <th class="px-2 py-3 font-semibold" id="variant-table-header-view" data-nosort="true">View</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for var in variants %}
                      {% set csq = var.INFO.selected_CSQ %}
                      {% if var.fp == True or ( var.blacklist and var.override_blacklist != true ) or var.irrelevant == True %}
                        <tr class='bg-red-200 opacity-60 hover:bg-red-300 border-t border-gray-400 text-left fp' id="snv-table-row-fp">
                      {% else %}
                        <tr class="border-t border-gray-400 text-left " id="snv-table-row">
                      {% endif %}

                      <!-- Checkbox -->
                      <td class="pl-2 py-2.5">
                        <input type="checkbox" class="snv-checkbox" id="snv-table-row-checkbox" data-value="{{ var._id }}">
                      </td>

                      <!-- Blacklisted -->
                      <td id="snv-table-row-blacklisted" class="text-center align-middle">
                        <div class="flex items-center justify-center h-full">
                          {% if var.fp == True %}
                            <span class="relative inline-block cursor-pointer" onmouseover="showTooltip(event, `<span class='text-red-400 '>Variant is false positive</span>`)">
                              <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-circle.svg') }}">
                            </span>
                          {% elif var.blacklist and var.override_blacklist != true %}
                            <span class="relative inline-block cursor-pointer "
                              onmouseover="showTooltip(event, `<span class='text-red-400'>Variant is blacklisted</span>`)">
                              <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/no-symbol.svg') }}">
                            </span>
                          {% endif %}
                        </div>
                      </td>

                      <!-- Comments -->
                      <td id="snv-table-row-comments" class="text-center align-middle">
                        <div class="flex items-center justify-center h-full">
                          {% if var.comments|length > 0 %}
                            <span class="relative inline-block cursor-pointer"
                              onmouseover="showTooltip(event, `<span class='text-orange-400'>Variant has comments</span>`)">
                              <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/chat-bubble-left-ellipsis.svg') }}">
                            </span>
                          {% endif %}
                        </div>
                      </td>

                      <!-- Interesting/irrelevant -->
                      <td id="snv-table-row-interesting-irrelevant" class="text-center align-middle">
                        <div class="flex items-center justify-center h-full">
                          {% if var.interesting == True %}
                            <span class="relative inline-block cursor-pointer"
                              onmouseover="showTooltip(event, `<span class='text-green-400'>Variant is irrelevant</span>`)">
                              <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/exclamation-circle.svg') }}">
                          </span>
                          {% endif %}
                          {% if var.irrelevant == True %}
                            <span class="relative inline-block cursor-pointer"
                              onmouseover="showTooltip(event, `<span class='text-yellow-400'>Variant is irrelevant</span>`)">
                              <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-mark.svg') }}">
                            </span>
                          {% endif %}
                        </div>
                      </td>

                      <!-- Gene -->
                      <td id="snv-table-row-gene">
                        {{ csq.SYMBOL }} {{ var.INFO.PANEL|format_panel_flag_snv|safe }}
                      </td>

                      <!-- HGVS -->
                      <td id="snv-table-row-hgvs">
                        <!-- HGVSp Section -->
                        <div class="relative inline-block">
                          {% if csq.HGVSp|length > 15 %}
                            <!-- Truncated version (initial view with ellipsis) -->
                            <div id="hgvsp-short" class="truncate overflow-hidden">
                              {{ csq.HGVSp[:15] }}...
                            </div>

                            <!-- Full text, initially hidden -->
                            <div id="hgvsp-full" class="hidden break-all whitespace-normal">
                              {{ csq.HGVSp }}
                            </div>

                            <!-- Smaller button with a subtle symbol to toggle text visibility -->
                            <button class="ml-1 hover:text-blue-500 focus:outline-none"
                                    onclick="toggleText(this)">
                              [+]
                            </button>
                          {% else %}
                            {{ csq.HGVSp }}
                          {% endif %}
                        </div>
                        <br>
                        <!-- HGVSc Section -->
                        <div class="relative inline-block">
                          {% if csq.HGVSc|length > 15 %}
                            <!-- Truncated version (initial view with ellipsis) -->
                            <div id="hgvs-short" class="truncate overflow-hidden">
                              {{ csq.HGVSc[:15] }}...
                            </div>

                            <!-- Full text, initially hidden -->
                            <div id="hgvs-full" class="hidden break-all whitespace-normal">
                              {{ csq.HGVSc }}
                            </div>

                            <!-- Smaller button with a subtle symbol to toggle text visibility -->
                            <button class="ml-1 hover:text-blue-500 focus:outline-none"
                                    onclick="toggleText(this)">
                              [+]
                            </button>
                          {% else %}
                            {{ csq.HGVSc }}
                          {% endif %}
                        </div>
                      </td>

                      <!-- Variant Type -->
                      <td class="px-1 lowercase relative" id="snv-table-row-type">
                        {% if var.variant_class in vep_var_class_translations %}
                            <span class="relative inline-block cursor-pointer"
                                  onmouseover="showTooltip(event, `{{ vep_var_class_translations[var.variant_class].desc | escape }}`)">
                                {{ vep_var_class_translations[var.variant_class].short }}
                            </span>
                        {% else %}
                            <span class="cursor-pointer">
                                {{ var.variant_class }}
                            </span>
                        {% endif %}
                      </td>

                      <!-- Consequence -->
                      <td id="snv-table-row-conseq" class="lowercase h-full items-left align-middle px-1 ">
                        {% set consequences = csq.Consequence if csq.Consequence is iterable and csq.Consequence is not string else csq.Consequence.split('&') %}
                        {% for conseq in consequences %}
                          <div class=" inline-block mb-1 cursor-pointer p-1 rounded-full bg-gray-300"
                            onmouseover="showTooltip(event, `{% if conseq in vep_conseq_translations %}
                              <strong>{{ vep_conseq_translations[conseq].display }}</strong><br>
                              {{ vep_conseq_translations[conseq].desc }}<br>
                              <span class='text-yellow-400 font-bold'>Impact: {{ vep_conseq_translations[conseq].impact }}</span>
                            {% else %}
                              {{ conseq }}
                            {% endif %}`)">
                            {% if conseq in vep_conseq_translations %}
                                {{ vep_conseq_translations[conseq].short }}
                            {% else %}
                              {{ conseq }}
                            {% endif %}
                          </div>
                        {% endfor %}
                      </td>
                    
                      <!-- Population Frequency -->
                      <td class="font-semibold" id="snv-table-row-popFreq">
                        {% if "gnomad_frequency" in var and var.gnomad_frequency != "" %}
                          {{ '%.3f' | format(100*var.gnomad_frequency)}}<br>
                        {% elif "gnomad_max" in var and var.gnomad_max != "" %}
                          {{ '%.3f' | format(100*var.gnomad_max)}}<br>
                        {% endif %}
                        {% if var.exac_frequency %}
                          ExAC: {{ var.exac_frequency|format_pop_freq(var.ALT)|safe }}<br>
                        {% endif %}
                        {% if var.thousandG_frequency %}
                          1000G: {{ var.thousandG_frequency|format_pop_freq(var.ALT)|safe }}
                        {% endif %}
                      </td>

                      <!-- Tier -->
                      <td class="font-semibold px-1" id="snv-table-row-class">
                        {% if var.classification.class != 999 and var.classification.transcript == csq.Feature %}
                          <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-tier{{ var.classification.class }} text-white shadow-md">
                            {% if assay in ["myeloid", "tumwgs"] or "assay" in var.classification %}
                              {{ var.classification.class }}
                            {% else %}
                              *
                            {% endif %}
                          </div>
                        {% elif var.additional_classification %}
                          <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-gray-400 text-white shadow-md">
                            {{ var.additional_classification.tier }}
                          </div>
                        {% elif var.other_classification|length > 0 %}
                          <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-gray-400 text-white shadow-md">
                            ?
                          </div>
                        {% endif %}
                      </td>

                      <!-- Chr:Pos -->
                      <td id="snv-table-row-chrPos" class="px-1">
                        <div class="inline-block px-2 py-1 font-semibold text-white rounded-full 
                                    {% if assay == 'solid' and csq.mmhotspot %} bg-red-400 
                                    {% else %} bg-gray-400 {% endif %}">
                          {{ var.CHROM }}:{{ var.POS }}
                        </div>
                      </td>

                      <!-- Hotspot (Only Display if Assay is 'solid' and Hotspot Exists) -->
                      {% if assay == "solid" %} 
                        <td  id="snv-table-row-hotspot">
                          {% if var.INFO.HOTSPOT %}
                            <div class="inline-block px-1 py-1 font-semibold text-white rounded-full">
                              {{ var.INFO.HOTSPOT|format_hotspot|safe }}
                            </div>
                          {% else %}
                            
                          {% endif %}
                        </td>
                      {% endif %}

                      <!-- Flags -->
                      <td id="snv-table-row-flags" class="lowercase items-left align-middle px-1">
                        <div class="flex flex-wrap gap-0.5 items-center">
                            {{ var.FILTER|format_filter|safe }}
                        </div>
                      </td>

                      <!-- GT -->
                      {% for gt in var.GT|sort(attribute='type') %}
                        <td id="snv-table-row-{% if gt.type == 'case' %}case{% else %}control{% endif %}" 
                            sorttable_customkey="{{ gt.AF }}" class="px-1 ">
                          <span class="{% if gt.DP < settings.error_cov %} text-red-600 {% elif gt.DP < settings.warn_cov %} text-orange-600 {% else %} text-gray-900 {% endif %}">
                            {{ '%0.1f'| format(100 * gt.AF|float) }}% ({{ gt.VD|int }} / {{ gt.DP|int }})
                        </td>
                      {% endfor %}

                      <!-- View -->
                      <td>
                        <a href="{{ url_for('dna_bp.show_variant', id=var._id) }}" 
                            class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">
                          View
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="p-4 text-center">No variants available.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>


    <!-- CNVs Container -->
    {% set has_cnv_image = sample.cnvprofile is not none %}
    {% set has_cnv_table = cnvwgs %}
    
    {% if has_cnv_table or has_cnv_image %}
      <section id="cnvs" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative w-full">
        <!-- CNVs Header -->
        <div class="overflow-x-auto relative">
          <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">
            CNVs {% if cnvwgs %}({{ cnvwgs|length }}){% endif %}
          </h2>
        </div>
    
        <!-- Full-width Wrapper -->
        <div class="w-full flex justify-center py-2" id="cnvs-content">
          <!-- Inner Flexible Container -->
          <div class="w-full px-1 bg-transparent">
            
            <!-- Flex Container for CNV Image & Table -->
            <div class="flex flex-wrap gap-2 w-full bg-transparent cnv-container">
    
              <!-- CNV Image (Sticky Floating) -->
              {% if has_cnv_image %}
                <div class="cnv-image bg-transparent py-2 px-2">
                  <!-- Header with Toggle Switch -->
                  <div class="flex justify-between items-center bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 tracking-wide capitalize">
                    <h2 class="text-sm">
                      CNV Profile
                    </h2>
                    <!-- Toggle Switch -->
                    <div class="flex items-center space-x-2">
                      <span class="text-sm text-gray-800">Rotate</span>
                      
                      <!-- Toggle Switch -->
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="cnv-image-rotate-toggle" class="sr-only">
                        
                        <!-- Toggle Background -->
                        <div id="cnv-image-toggle-bg" class="w-16 h-7 rounded-full flex items-center relative transition-all duration-300">
                          
                          <!-- Sliding Knob -->
                          <div id="cnv-image-toggle-knob" class="absolute bg-white h-6 w-6 rounded-full shadow-md transition-transform duration-300"></div>
                          
                          <!-- Labels -->
                          <div class="absolute inset-0 flex justify-between items-center px-2">
                            <span id="cnv-image-deg-0" class="text-white transition-colors mr-1">0°</span>
                            <span id="cnv-image-deg-90" class="text-black transition-colors ml-3">90°</span>
                          </div>
                          
                        </div>
                      </label>
                      
                    </div>
                  </div>
              
                  <div class="rounded-b-lg shadow-md p-4 sticky top-0">
                    {% set build = sample.genome_build if "genome_build" in sample else 37 %}
                    <!-- Image Container (Will be updated dynamically) -->
                    <div id="cnv-image-container" class="flex justify-center items-center">
                      <a id="cnv-image-link" href="{{ url_for('dna_bp.show_any_plot', fn=sample.cnvprofile|basename, assay=assay, build=build|int) }}" target="_blank">
                        <img id="cnv-image-img" 
                          class="rounded-lg border border-gray-300 shadow-lg transition duration-300 ease-in-out transform scale-90 hover:scale-95"
                          src="{{ url_for('dna_bp.show_any_plot_rotated', fn=sample.cnvprofile|basename, assay=assay, build=build|int) }}"
                        >
                      </a>
                    </div>
                  </div>    
                </div>
              {% endif %}
            

              <!-- CNV Table -->
              {% if has_cnv_table %}
                <div class="cnv-table bg-transparent py-2">
                  <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
                    <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg p-2 z-10">
                      <h2 class="text-sm font-semibold text-black">CNV Table</h2>
                      <img 
                        src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}" 
                        alt="Export to CSV - CNVs" 
                        onclick="exportTableToCSV('{{ sample.name }}.filtered.cnvs.csv', 'cnvs-table')" 
                        class="w-6 h-6 transition-transform transform hover:scale-110"
                      />
                    </div>
                    <div class="overflow-auto relative bg-transparent">
                      <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="cnvs-table">
                        <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                          <tr id="cnv-table-header" class="border-b text-left border-gray-800 ">
                            <th class="px-2 py-3 font-semibold" id="cnv-table-header-genes">Genes</th>
                            <th class="px-2 py-3 font-semibold" id="cnv-table-header-region">Region</th>
                            <th class="px-2 py-3 font-semibold" id="cnv-table-header-size">Size (bp)</th>
                            {% if assay == "solid" or assay == "gmsonco" %}
                              <th class="px-2 py-3 font-semibold" id="cnv-table-header-callers">Callers</th>
                            {% endif %}
                              <th class="px-2 py-3 font-semibold" id="cnv-table-header-cn">Copy number</th>
                            {% if sample.purity %}
                              <th class="px-1 py-3 font-semibold w-4" id="cnv-table-header-purity">Purity {{ sample.purity }}</th>
                            {% endif %}
                            {% if assay == "solid" or assay == "gmsonco" %}
                              <th class="px-1 py-3 font-semibold" id="cnv-table-header-sr">SR (ref/alt)</th>
                            {% endif %}
                            <th class="px-1 py-3 font-semibold w-4" id="cnv-table-header-status">Status</th>
                            <th class="px-1 py-3 font-semibold w-4" id="cnv-table-header-view">View</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for cnv in cnvwgs %}
                            {% if cnv.interesting %}
                              <tr class="bg-green-100 hover:bg-green-200 border-t border-gray-400 text-left" id="cnv-table-row-interesting">
                            {% elif cnv.ratio > 3 and cnv.size > (sizefilter|int) %}
                              <tr class="bg-red-100 border-t border-gray-400 text-left" id="cnv-table-row">
                            {% else %}
                              <tr class="border-t border-gray-400 text-left" id="cnv-table-row">
                            {% endif %}

                              <!-- Genes -->
                              <td class="pl-2 py-2.5" id="cnv-table-row-genes">
                                {% set non_panel_genes = [0] %}
                                {% for gene in cnv.genes %}
                                  {% if gene.class %}
                                    {{ gene.gene }}<br>
                                  {% else %}
                                    {% if non_panel_genes.append(non_panel_genes.pop() + 1) %}
                                    {% endif %}
                                  {% endif %}
                                {% endfor %}
                                {% if non_panel_genes[0] > 0 %}
                                  <font class='text-gray-400'>+ {{ non_panel_genes[0] }} other genes</font>
                                {% endif %}
                              </td>

                              <!-- Region -->
                              <td id="cnv-table-row-region">
                                <div class="inline-block px-2 py-1 text-white rounded-full bg-gray-400">
                                  {{ cnv.chr }}:{{ cnv.start }}-{{ cnv.end }}
                                </div>
                              </td>

                              <!-- Size -->
                              <td id="cnv-table-row-size">
                                {{ cnv.size|abs }}
                              </td>

                              <!-- Callers -->
                              {% if assay == "solid" or assay == "gmsonco" %}
                                <td id="cnv-table-row-callers">
                                  {{ cnv.callers }}
                                </td>

                                <!-- Copy Number for solid and gmsonco assay -->
                                {% if "gatk" in cnv.callers or "cnvkit" in cnv.callers %}
                                  <td id="cnv-table-row-ratio">
                                    {{ 2*(2**cnv.ratio)|round(2) }} ({{ cnv.ratio }})
                                  </td>

                                  <!-- purity for solid -->
                                  {% if sample.purity %}
                                    {% if cnv.ratio > 0 %}
                                      <td class="w-4" id="cnv-table-row-purity">
                                        {{ (2*(2**cnv.ratio)*1/sample.purity)|round(2) }}
                                      </td>
                                    {% else %}
                                      <td class="w-4" id="cnv-table-row-purity">
                                        {{ (2*(2**cnv.ratio)*sample.purity)|round(2) }}
                                      </td>
                                    {% endif %}
                                  {% endif %}
                                  {% if "manta" in cnv.callers %}
                                    <td id="cnv-table-row-pr">
                                      {{ cnv.PR }}
                                    </td>
                                  {% else %}
                                    <td id="cnv-table-row-pr">
                                      -
                                    </td>
                                  {% endif %}
                                {% else %}
                                  {% if assay == "solid" %}
                                    <td id="cnv-table-row-pr">
                                      -
                                    </td>
                                  {% endif %}
                                  <td id="cnv-table-row-pr">
                                    -
                                  </td>
                                  <td id="cnv-table-row-pr">
                                    {{ cnv.PR }}
                                  </td>
                                {% endif %}
                              {% else %}
                                <td id="cnv-table-row-ratio">
                                  {{ 2*(2**cnv.ratio)|round(2) }} ({{ cnv.ratio }})
                                </td>
                              {% endif %}
                              <td class="w-4" id="cnv-table-row-status">
                                {% if cnv.interesting %}
                                  report
                                {% endif %}
                              </td>
                              <td class="w-4" id="cnv-table-row-view">
                                <a href="{{ url_for('dna_bp.show_cnv', id=cnv._id) }}" class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">view</a>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              {% else %} <!-- TODO: CHeck the cnvs from the config to show this section or not -->
                <em class="block text-center text-gray-500 text-sm italic bg-gray-50 p-4 rounded-b-lg border border-gray-300 shadow-md">
                  No cnvs found with the current filter settings!
                  <br>
                </em>    
              {% endif %}
            </div> <!-- End Flex Container -->
          </div> <!-- End Inner Dynamic Container -->
        </div> <!-- End Full-width Wrapper -->
      </section>
    {% endif %}

    <!-- Translocations Card -->
    {% if transloc %}
      <section id="translocs" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
        <!-- Translocs Header -->
        <div class="overflow-x-auto relative">
          <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Translocations ({{ transloc.count() }})</h2>
        </div>
        
        <div class="mx-auto py-2 " id="transloc-content">
          <div class="flex flex-wrap gap-4 ">
            <!-- Translocations Table -->
            <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
              <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
                <h2 class="text-sm font-semibold text-black">Gene fusions passing filter criteria</h2>
                <img 
                  src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}" 
                  alt="Export to CSV - translocations" 
                  onclick="exportTableToCSV('{{ sample.name }}.filtered.translocs.csv', 'transloc-table')" 
                  class="w-6 h-6 transition-transform transform hover:scale-110"
                />
              </div>
              {% if transloc and transloc.count() > 0 %}
                <div class="overflow-auto relative">
                  <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="transloc-table">
                    <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                      <tr id="transloc-table-header" class="border-b text-left border-gray-800">
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-gene1">Gene 1</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-gene2">Gene 2</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-positions">Positions</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-type">Type</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-hgvs">HGVS</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-panel">Panel</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-status">Status</th>
                        <th class="px-2 py-3 font-semibold" id="transloc-table-header-view">View</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for tl in transloc %}
                        {% set ANN = tl.INFO.MANE_ANN or tl.INFO.ANN[0] %}
                        {% set genes = ANN.Gene_Name.split('&') %}
                        {% if tl.interesting %}
                          <tr class="bg-green-100 hover:bg-green-200 border-t border-gray-400 text-left" id="transloc-table-row-interesting">
                        {% else %}    
                          <tr class="border-t border-gray-400 text-left" id="transloc-table-row">
                        {% endif %}

                          <td class="pl-2 py-2.5" id="transloc-table-row-gene1">
                            {{ genes[0] }}
                          </td>
                          <td id="transloc-table-row-gene2">
                            {{ genes[1] }}
                          </td>
                          <td id="transloc-table-row-positions">
                            {{ tl.CHROM }}:{{ tl.POS }} {{ tl.ALT }}
                          </td>
                          <td id="transloc-table-row-type">
                            {% for annot in ANN.Annotation %}
                              {{ annot }}<br>
                            {% endfor %}
                          </td>
                          <td id="transloc-table-row-hgvs">
                            {{ ANN.HGVSp|unesc }}<br>{{ ANN.HGVSc|unesc }}
                          </td>
                          <td id="transloc-table-row-panel">
                            {{ tl.INFO.PANEL }}
                          </td>
                          <td id="transloc-table-row-status">
                            {% if tl.interesting %}
                              report
                            {% endif %}
                          </td>
                          <td id="transloc-table-row-view">
                            <a href="{{ url_for('dna_bp.show_transloc', id=tl._id) }}" class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">view</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <em class="block text-center text-gray-800 text-sm italic bg-gray-100 p-4 rounded-b-lg border border-gray-300 shadow-md">
                  No translocations found with the current filter settings!
                  <br>
                </em> 
              {% endif %}
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    <!-- Fusion Card -->
    {% if fusions %} <!-- TODO: CHECK THIS WITH TEST DATA -->
      <section id="fusions" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
        <!-- Fusions Header -->
        <div class="overflow-x-auto relative">
          <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">DNA Fusions ({{ fusions|length }})</h2>
        </div>
        
        <div class="mx-auto py-2 " id="fusions-content">
          <div class="flex flex-wrap gap-4 ">
            <!-- Fusions Table -->
            <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
              <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-200 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
                <h2 class="text-sm font-semibold text-black">DNA fusions passing filter criteria</h2>
                <img 
                  src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}" 
                  alt="Export to CSV - fusions" 
                  onclick="exportTableToCSV('{{ sample.name }}.filtered.fusions.csv', 'fusions-table')" 
                  class="w-6 h-6 transition-transform transform hover:scale-110"
                />
              </div>
              {% if fusions and fusions|length > 0 %}
                <div class="overflow-auto relative">
                  <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="fusions-table">
                    <thead class="sortable capitalize tracking-wide rounded-t-lg bg-yellow-100">
                      <tr id="fusions-table-header" class="border-b text-left border-gray-800">
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-gene1">Gene 1</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-gene2">Gene 2</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-effect">Effect</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-spanpairs">Spanning pairs</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-unique-spanpairs" data-autoclick="true">Unique spanning reads</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-fusion-points">Fusion points</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-tier">Tier</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-desc">Description</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-callers">Callers</th>
                        <th class="px-2 py-3 font-semibold" id="fusion-table-header-view">View</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for fus in fusions %}
                        {% set genes = fus.genes.split('^') %}
                        {% set sel_fus = (fus.calls|selectattr('selected', 'equalto', 1) |list)[0] %}
                        {% if fus.blacklisted or fus.fp %}
                          <tr class="bg-red-200 opacity-60 hover:bg-red-300 border-t border-gray-400 text-left"id="fusions-table-row-blacklisted">
                        {% else %}
                          <tr class="border-t border-gray-400 text-left" id="fusions-table-row">
                        {% endif %}
                          <td class="pl-2 py-2.5" id="fusions-table-row-gene1">
                            {{ genes[0] }}
                          </td>
                          <td id="fusions-table-row-gene2">
                            {{ genes[1] }}
                          </td>
                          <td id="fusions-table-row-effect">
                            {{ sel_fus.effect }}
                          </td>
                          <td id="fusions-table-row-spanpairs">
                            {{ sel_fus.spanpairs }}
                          </td>
                          <td id="fusions-table-row-unique-spanpairs">
                            {{ sel_fus.spanreads }}
                          </td>
                          <td id="fusions-table-row-fusion-points">
                            {{ sel_fus.breakpoint1 }}<br>{{ sel_fus.breakpoint2 }}
                          </td>
                          <td class="py-2 px-3 border-b border-gray-300 varlist" sorttable_customkey="{{ fus.classification.class }}"  id="fusions-table-row-tier">
                            {% if fus.classification.class != 999 %}
                              <div class="inline-flex items-center px-3 py-1 font-semibold rounded-full bg-tier{{ fus.classification.class }} text-white shadow-md">
                                {{ fus.classification.class }}
                              </div>
                            {% endif %}
                          </td>
                          <td id="fusions-table-row-desc">
                            {{ sel_fus.desc|format_fusion_desc|safe }}
                          </td>
                          <td id="fusions-table-row-callers">
                            {{ fus.calls|uniq_callers|join("<br>")|safe }}
                          </td>
                          <td id="fusions-table-row-view">
                            <a href="{{ url_for('dna_bp.show_fusion', id=fus._id) }}" class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">view</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </section>
    {% endif %}


    <!-- Summary Comments Card -->
    <section id="summary" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
      <!-- Summary Header -->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Summary</h2>
      </div>

      <div class="mx-auto py-2 " id="summary-content">
        <div class="flex flex-wrap gap-4 ">
          <!-- Summary comments Table -->
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-blue-200 to-green-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Summary Comments</h2>
            </div>
            <div class="overflow-auto relative">
              <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="summary-table">
                <thead class="sortable capitalize tracking-wide rounded-t-lg bg-green-100">
                  <tr id="summary-table-header" class="border-b text-left border-gray-800">
                    <th class="px-2 py-3 font-semibold" id="comments-table-header-who">Who</th>
                    <th class="px-2 py-3 font-semibold" id="comments-table-header-comment">Comment</th>
                    <th class="px-2 py-3 font-semibold" id="comments-table-header-view">Hide/Unhide</th>
                  </tr>
                </thead>
                <tbody>
                  {% if sample.comments|length > 0 %}
                    {% for comment in sample.comments|sort(attribute='time_created', reverse=True) %}
                      {% if comment.hidden != 1 %}
                        <tr class="hover:bg-green-50 border-t border-gray-400 text-left" id="comment-table-row">
                      {% else %}
                        <tr class="bg-red-200 opacity-60 hover:bg-red-300 border-t border-gray-400 text-left hidden hidden_comment" id="comment-table-row-hidden">
                      {% endif %}
                        <td class="px-2 whitespace-nowrap align-top py-4" id="comments-table-header-who">
                          <b>{{ comment.author }}</b><br><small>{{ comment.time_created|human_date }}</small>
                        </td>
                        <td class="p-2" id="comments-table-header-comment" onclick='addText(event)'>
                          {{ comment.text|format_comment|safe }}
                        </td>
                        <td class="px-2 align-top py-4" id="comments-table-header-view">
                          {% set hidden_exists = 0 %}
                          {% if comment.hidden != 1 %}
                            <form action="{{ url_for('common_bp.hide_sample_comment', sample_id=sample._id) }}#summary" method="post">
                              <input type="hidden" name="comment_id" value="{{ comment._id }}">
                              <input id="hide_comment" type="image" class="w-5 hover:scale-105" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye-slash.svg') }}">
                            </form>
                          {% else %}
                            {% set hidden_exists = 1 %}
                            <form action="{{ url_for('common_bp.unhide_sample_comment', sample_id=sample._id) }}#summary" method="post">
                              <input type="hidden" name="comment_id" value="{{ comment._id }}">
                              <input id="unhide_comment" type="image" class="w-5" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye.svg') }}">
                            </form>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                    {% if hidden_comments %}
                      <tr>
                        <td colspan=4 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                          <a href="javascript:void(0)" onclick="switchVisibility('hidden_comment')"><b>Show/hide deleted comments</b></a>
                        </td>
                      </tr>
                    {% endif %}
                  {% else %}
                    <tr>
                      <td colspan=4 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                        No comments available.
                      </td>
                    </tr>
                  {% endif %}
                <tbody>
              </table>
            </div>
          </div>

          <!-- Add Comment Form -->
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-blue-200 to-green-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Write New Summary</h2>
            </div>
            <div class="overflow-auto relative" id="comments-box-div">
              <form action="{{ url_for('common_bp.add_sample_comment', id=sample._id) }}" method="post">
                <textarea id="comment_textarea" name="sample_comment" placeholder="Type to write a new summary for {{ sample.name }} sample..." class="w-5/6 p-4 border border-gray-400 rounded mx-5 my-4 h-40"></textarea><br>
                <input type="submit" value="Save" class="inline-block ml-10 mb-5 px-3 py-2 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg cursor-pointer">
                <button type="button" class="inline-block ml-5 mb-5 px-3 py-2 text-black bg-gray-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-gray-500 hover:text-white hover:shadow-lg cursor-pointer" onclick="addAIText()">Suggest</button>
                <button class="inline-block ml-5 mb-5 px-3 py-2 text-black bg-green-400 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-green-500 hover:text-white hover:shadow-lg cursor-pointer" onclick="window.location.href='preview_report/{{sample.name}}'">Preview report</button>
              </form>
              <div id="suggestion" class="hidden">
                {{ ai_text }}
              </div>
            </div>
          </div>


        </div>
      </div>
    </section>


    <!-- Low Coverage Card old way -->
    <section id="lowcov" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
      <!-- Low Coverage Header -->
      <div class="overflow-x-auto relative">
        <div class="flex justify-between items-center">
          <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Coverage</h2>
          <button class="bg-yellow-500 hover:bg-yellow-700 text-black text-xs mr-2 mt-1 px-5 py-1.5 rounded-md shadow-lg cursor-pointer duration-100 ease-in-out transform hover:scale-101" href='#lowcov' onclick="show_lowcov();">Show</button>
        </div>
      </div>
      
      <div class="mx-auto py-2 " id="lowcov-content">
        <div class="flex flex-wrap gap-4 ">
          <!-- Low Cov locations Table -->
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-red-200 to-orange-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Low Coverage Regions</h2>
              <img 
                src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}" 
                alt="Export to CSV - lowcov" 
                onclick="exportTableToCSV('{{ sample.name }}.filtered.lowcov.csv', 'lowcov-table')" 
                class="w-6 h-6 transition-transform transform hover:scale-110"
              />
            </div>
            <div class="overflow-auto relative">
              <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="lowcov-table">
                <thead class="sortable capitalize tracking-wide rounded-t-lg bg-orange-100">
                  <tr class="border-b text-left border-gray-800" id="lowcov-table-header">
                    <th class="px-2 py-3 font-semibold" id="lowcov-table-header-region">Chromosomal region</th>
                    <th class="px-2 py-3 font-semibold" id="lowcov-table-header-size">Size (bp)</th>
                    <th class="px-2 py-3 font-semibold" id="lowcov-table-header-avgDepth" data-autoclick-once="true">Avg depth (x)</th>
                    <th class="px-2 py-3 font-semibold" id="lowcov-table-header-amplicon">Amplicon</th>
                    <th class="px-2 py-3 font-semibold" id="lowcov-table-header-cosmicIds">COSMIC variants</th>
                  </tr>
                </thead>
                <tbody id="lowcov-table-body" style="display:none">
                  {% for low in low_cov %}
                    {% if low.avg_cov < 500 %}
                      <tr class="bg-red-50 hover:bg-red-100 border-t border-gray-400 text-left" id="lowcov-table-row">
                    {% else %}
                      <tr class="hover:bg-yellow-50 border-t border-gray-400 text-left" id="lowcov-table-row">
                    {% endif %}
                      <td class="pl-2 py-2.5" id="lowcov-table-row-region">{{ low.chr }}:{{ low.start }}-{{ low.end }}</td>
                      <td id="lowcov-table-row-size">{{ low.end - low.start + 1 }}</td>
                      <td id="lowcov-table-row-avgDepth">{{ low.avg_cov|int }}</td>
                      <td id="lowcov-table-row-amplicon">{{ low.amplicon }}</td>
                      <td id="lowcov-table-row-cosmicIds">
                        {% for cosm in low.cosmic %}
                          <span class="block" title="{{ cosm['cnt'] }}">{{ cosm["id"] }} - {{ cosm["cnt"]["haematopoietic_and_lymphoid_tissue"] }}</span>
                        {% endfor %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>


  </main>


  <!-- Right Filter Sidebar -->
  {% include "variant_sidebars.html" %}

</div>

<script>


  function showCheckboxes(id, iconId) {
    let checkboxes = document.getElementById(id);
    let icon = document.getElementById(iconId);
  
    if (checkboxes.classList.contains("hidden")) {
      checkboxes.classList.remove("hidden");
      if (icon) icon.classList.add("rotate-180"); // Rotates the dropdown arrow
    } else {
      checkboxes.classList.add("hidden");
      if (icon) icon.classList.remove("rotate-180");
    }
  }

  // JavaScript for rotating the cnv image functionality
  document.addEventListener("DOMContentLoaded", function () {
    let toggle = document.getElementById("cnv-image-rotate-toggle");
    let knob = document.getElementById("cnv-image-toggle-knob");
    let bg = document.getElementById("cnv-image-toggle-bg");
    let deg0 = document.getElementById("cnv-image-deg-0");
    let deg90 = document.getElementById("cnv-image-deg-90");
    let imageElement = document.getElementById("cnv-image-img");
    let imageLink = document.getElementById("cnv-image-link");

    // Store original and rotated image URLs
    let originalImage = "{{ url_for('dna_bp.show_any_plot', fn=sample.cnvprofile|basename, assay=assay, build=build|int) }}";
    let rotatedImage = "{{ url_for('dna_bp.show_any_plot_rotated', fn=sample.cnvprofile|basename, assay=assay, build=build|int) }}";

    function updateToggleState() {
        if (toggle.checked) {
            // Move knob to right, change background color, update image
            knob.style.transform = "translateX(36px)";
            bg.style.backgroundColor = "#e4a787";
            deg0.style.color = "white";
            deg90.style.color = "black";

            imageElement.src = rotatedImage;
        } else {
            // Move knob to left, reset background color, update image
            knob.style.transform = "translateX(0px)";
            bg.style.backgroundColor = "#74a9d4";
            deg0.style.color = "black";
            deg90.style.color = "white";

            imageElement.src = originalImage;
        }
    }

      // Ensure slider starts at 90° (checked) on page load
      toggle.checked = true;
      updateToggleState();

      // Add event listener for toggle change
      toggle.addEventListener("change", updateToggleState);
  });


  function addAIText() {
    var suggestion = document.getElementById("suggestion").innerHTML.trim();
    document.getElementById("comment_textarea").value = suggestion;
  }

  function addText(event) {
    var targ = event.target || event.srcElement;
    if (!targ.closest('tr').classList.contains('hidden_comment')) {
      document.getElementById("comment_textarea").value = targ.textContent || targ.innerText;
    }
  }

  function addText(event) {
    var targ = event.target || event.srcElement;
    if (!targ.closest('tr').classList.contains('hidden_comment')) {
      const textarea = document.getElementById('comment_textarea');
      const text = event.target.innerText.trim();
      textarea.value = text;
    }
  }
  
  window.onload = function () {
    document.querySelectorAll('[data-autoclick="true"]').forEach(element => element.click());
    document.querySelectorAll('[data-autoclick-once="true"]').forEach(element => element.click());
  };
  
  var expanded = false;
  function toggleFilters() {
    var filterCard = document.getElementById("filter_card");
    filterCard.style.display = expanded ? "none" : "block";
    expanded = !expanded;
  }
  
  function show_lowcov() {
    var lowcovDiv = document.getElementById("lowcov-table-body");
    var button = document.querySelector("button[onclick='show_lowcov();']");

    if (lowcovDiv.style.display === "none" || lowcovDiv.style.display === "") {
        lowcovDiv.style.display = "block";
        button.textContent = "Hide";
    } else {
        lowcovDiv.style.display = "none";
        button.textContent = "Show";
    }
}

  
function show_germlinecnv(button) {
  var germlineDiv = document.getElementById("germline_div");

  if (germlineDiv.style.display === "none" || germlineDiv.style.display === "") {
      germlineDiv.style.display = "block";
      button.classList.remove("bg-gray-400", "hover:bg-gray-500");
      button.classList.add("bg-green-500", "hover:bg-green-600");
  } else {
      germlineDiv.style.display = "none";
      button.classList.remove("bg-green-500", "hover:bg-green-600");
      button.classList.add("bg-gray-400", "hover:bg-gray-500");
  }
}

  

  
  function switchVisibility(class_name, button) {
    var elems = document.getElementsByClassName(class_name);

    // Toggle visibility for all elements with the class
    for (var i = 0; i < elems.length; i++) {
        elems[i].classList.toggle('hidden');
    }

    // Toggle button text and color
    if (button.textContent.includes("Hide")) {
        button.textContent = button.textContent.replace("Hide", "Show");
        button.classList.remove("bg-gray-400", "hover:bg-gray-500");
        button.classList.add("bg-green-500", "hover:bg-green-600");
    } else {
        button.textContent = button.textContent.replace("Show", "Hide");
        button.classList.remove("bg-green-500", "hover:bg-green-600");
        button.classList.add("bg-gray-400", "hover:bg-gray-500");
    }
}

  



  // JavaScript for Expand/Collapse functionality
  function toggleText(button) {
    var shortText = button.previousElementSibling.previousElementSibling;
    var fullText = button.previousElementSibling;

    // Toggle between short and full text
    if (fullText.classList.contains('hidden')) {
      shortText.classList.add('hidden');   // Hide truncated text
      fullText.classList.remove('hidden'); // Show full text
      button.textContent = '[-]';          // Change button text to Collapse
    } else {
      shortText.classList.remove('hidden'); // Show truncated text
      fullText.classList.add('hidden');     // Hide full text
      button.textContent = '[+]';           // Change button text to Expand
    }
  }

  // JavaScript for Expand/Collapse functionality
  function toggleCard(cardId) {
    var card = document.getElementById(cardId);
    var arrowIcon = card.parentElement.querySelector('#arrow-icon');
  
    if (card.classList.contains('hidden')) {
      card.classList.remove('hidden'); // Show the content
      arrowIcon.classList.remove('rotate-180'); // Rotate arrow downwards
    } else {
      card.classList.add('hidden'); // Hide the content
      arrowIcon.classList.add('rotate-180'); // Reset arrow to upwards
    }
  }

  // Export csv function
  function exportTableToCSV(filename, tableId) {
    // Get the table element by its ID
    const table = document.getElementById(tableId);
    if (!table) {
      console.error(`Table with ID "${tableId}" not found.`);
      return;
    }
  
    let csv = [];
    
    // Get all rows from the table
    const rows = table.querySelectorAll('tr');
  
    // Loop through each row
    rows.forEach((row) => {
      let rowData = [];
      const cells = row.querySelectorAll('th, td'); // Get header and data cells
      cells.forEach((cell) => {
        // Extract text content and replace line breaks with ";"
        let cellContent = cell.innerText.replace(/\n/g, ';').trim();
        rowData.push(cellContent);
      });
      csv.push(rowData.join(',')); // Join cells with a comma
    });
  
    // Convert the array to a CSV string
    const csvString = csv.join('\n');
  
    // Create a Blob and download the CSV file
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  
  
  
  

</script>


{% endblock %}