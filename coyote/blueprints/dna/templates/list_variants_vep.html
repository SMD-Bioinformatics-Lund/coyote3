{% extends "layout.html" %}

{% block body %}
{% set translation=config["TRANS"] %}
<div class="mx-auto pt-6 pr-10 pl-10 pb-10" id="main-content">
  <!-- Sample Information -->
  <div class="bg-white shadow-md rounded-lg p-4 mb-4 flex items-center justify-between" id="sample-info">
    <div id="sample-name-info">
      <span class="ml-4 text-sm font-semibold">Sample:</span>
      <a href="{{ url_for('dna_bp.list_variants', id=sample.name) }}" class="text-sm font-semibold text-blue-500 hover:underline">{{ sample.name }}</a>
    </div>
    <div class="flex items-center space-x-2" id="sample-meta-info">
      {% if "subpanel" in sample %}
        <div class="text-sm">Type: <span class="font-semibold"> {{ sample.subpanel }}</span></div>
      {% endif %}
      {% if assay == "solid" %}
        {% if "purity" in sample %}
          <span class="px-1">|</span><div class="text-sm">Purity: <span class="font-semibold"> {{ sample.purity * 100 }}%</span></div>
        {% endif %}
        {% if biomarker and biomarker.count() > 0 %}
          {% for bio in biomarker %}
            {% if "MSIS" in bio %}
              <span class="px-1">|</span><div class="tooltip text-sm">MSI(Single):<span class="tooltiptext">Total: {{ bio.MSIS.tot }} Somatic: {{ bio.MSIS.som }}</span></div> 
              <span class="font-semibold">{{ bio.MSIS.perc }}%</span>
            {% endif %}
            {% if "MSIP" in bio %}
              <span class="px-1">|</span><div class="tooltip text-sm">MSI(Paired):<span class="tooltiptext">Total: {{ bio.MSIP.tot }} Somatic: {{ bio.MSIP.som }}</span></div> 
              <span class="font-semibold">{{ bio.MSIP.perc }}%</span>
            {% endif %}
            {% if "HRD" in bio %}
              <span class="px-1">|</span><div class="tooltip text-sm">HRD:<span class="tooltiptext">TAI: {{ bio.HRD.tai }} HRD: {{ bio.HRD.hrd }} LST: {{ bio.HRD.lst }}</span></div>
              <span class="font-semibold">{{ bio.HRD.sum }}</span>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- Filters/Action Sidebars -->
  {% include "variant_sidebars.html" %}

  <!-- Gene Panel -->
  {% include "selected_gene_panel_div.html" %}

  <!-- SNV/Indels Card -->
  <div id="snvs-div" class="bg-white rounded-lg my-8">
    <!-- SNV/Indels Toggle Button -->
    <div class="flex justify-between items-center bg-green-200 text-black rounded-md px-4 py-2">
      <h2 class="text-base font-semibold tracking-wide uppercase">SNVs/Indels ({{ variants|length }})</h2>
      <button class="focus:outline-none" onclick="toggleCard('snvs-content')">
        <img id="arrow-icon" src="{{ url_for('static', filename='icons/up-arrow-240.png') }}" alt="Toggle SNV Card" class="w-6 h-6 transform transition-transform duration-200 filter invert">
      </button>
    </div>

    <div class="mx-auto py-4 mx-2" id="snvs-content">
      <div class="flex flex-wrap gap-4">
        <!-- SNVs/Indels Table -->
        <div class="flex-grow-0 bg-transparent shadow-md rounded-b-md overflow-auto" id="snvs-table-div-header">
          <div class="flex items-center justify-between bg-gradient-to-b from-green-200 to-white shadow-lg rounded-t-lg">
            <h2 class="text-sm font-semibold tracking-wide p-3 capitalize">
              Variants passing filter criteria
            </h2> 
            <img src="{{ url_for('static', filename='icons/save-100.png') }}" alt="Export to CSV - SNVs" onclick="exportTableToCSV('{{ sample.name }}.filtered.snvs.csv', 'snvs-table')" class="cursor-pointer w-6 h-6 mr-4 transition-transform transform hover:scale-110" id="export-snvs-table"/>
          </div>
          {% if variants|length > 0 %}
            <div class="overflow-auto rounded-b-lg shadow-md" id="snvs-table-div">
              <table class="table-auto text-xs mb-1 sortable" id="snvs-table">
                <thead>
                  <tr class="border-b text-left border-gray-300 capitalize" id="variant-table-header">
                    <th class="p-3 font-semibold" id="variant-table-header-checkbox">
                      <input type="checkbox" id="select-all-table" onclick="toggleSelectAllVariants(this)">
                    </th>
                    <th class="p-3 font-semibold" id="variant-table-header-blacklisted"></th>
                    <th class="p-3 font-semibold" id="variant-table-header-comments"></th>
                    <th class="p-3 font-semibold" id="variant-table-header-interesting-irrelevant"></th>
                    <th class="p-3 font-semibold" id="variant-table-header-gene">Gene</th>
                    <th class="p-3 font-semibold" id="variant-table-header-hgvs">HGVS</th>
                    <th class="p-3 font-semibold" id="variant-table-header-type">Type</th>
                    <th class="p-3 font-semibold" id="variant-table-header-conseq">Consequence</th>
                    <th class="p-3 font-semibold" id="variant-table-header-popFreq">PopFreq</th>
                    <th class="p-3 font-semibold" id="variant-table-header-tier">Tier</th>
                    {% if assay == "swea" or assay == "tumor_exome" %}
                      <th data-autoclick="true" class="p-3 font-semibold" id="variant-table-header-score">Score</th>
                    {% endif %}
                    {% if assay == "swea" or assay == "gmsonco" %}
                      <th class="p-3 font-semibold" id="variant-table-header-enigma">ENIGMA</th>
                    {% endif %}
                    <th class="p-3 font-semibold" id="variant-table-header-chrPos">Chr:Pos</th>
                    {% if assay == "solid" %}
                      <th class="p-3 font-semibold" id="variant-table-header-hotspot">Hotspot</th>
                    {% endif %}
                    <th class="p-3 font-semibold" id="variant-table-header-flags">Flags</th>
                    {% if assay == "swea" %}
                      <th class="p-3 font-semibold" id="variant-table-header-gt"></th>
                    {% endif %}
                    {% for gt in variants[0].GT|sort(attribute='type') %}
                      {% if gt.type == "case" %}
                        <th {% if assay == "myeloid" %}data-autoclick="true"{% endif %} class="p-3 font-semibold" id="variant-table-header-case">{{ gt.type }} ({{gt.sample}})</th>
                      {% else %}
                        <th class="p-3 font-semibold" id="variant-table-header-control">{{ gt.type }} ({{gt.sample}})</th>
                      {% endif %}
                    {% endfor %}
                    <th class="p-3 font-semibold" id="variant-table-header-view">View</th>
                  </tr>
                </thead>
                <tbody>
                  {% for var in variants %}
                    {% set csq = var.INFO.selected_CSQ %}
                    {% if var.fp == True or ( var.blacklist and var.override_blacklist != true ) or var.irrelevant == True %}
                      <tr class='bg-red-200 opacity-40 hover:bg-red-300 border-b text-left fp' id="cnv-table-row-fp">
                    {% else %}
                      <tr class="border-b text-left" id="cnv-table-row">
                    {% endif %}
                      <td class="pl-2">
                        <input type="checkbox" class="snv-checkbox" id="cnv-table-row-checkbox" data-value="{{ var._id }}">
                      </td>
                      <td id="cnv-table-row-blacklisted">
                        {% if var.fp == True %}
                          &nbsp;<img class="w-2" src="{{ url_for('static', filename='images/redcross.png') }}">
                        {% elif var.blacklist and var.override_blacklist != true %}
                          &nbsp;<img class="w-2 pl-2" src="{{ url_for('static', filename='images/blacklist.png') }}">
                        {% endif %}
                      </td>
                      <td id="cnv-table-row-comments">
                        {% if var.comments|length > 0 %}
                          &nbsp;<img class="w-2" src="{{ url_for('static', filename='images/comment.png') }}"> 
                        {% endif %}
                      </td>
                      <td id="cnv-table-row-interesting-irrelevant">
                        {% if var.interesting == True %}
                          &nbsp;<img class="w-2" src="{{ url_for('static', filename='images/interesting.png') }}">
                        {% endif %}
                        {% if var.irrelevant == True %}
                          &nbsp;<img class="w-2" src="{{ url_for('static', filename='images/irrelevant.png') }}">
                        {% endif %}
                      </td>
                      <td class="p-2 font-medium" id="cnv-table-row-gene">
                        {{ csq.SYMBOL }} {{ var.INFO.PANEL|format_panel_flag_snv|safe }}
                      </td>
                      <td class="p-2 font-medium" id="cnv-table-row-hgvs">
                        <!-- HGVSp Section -->
                        <div class="relative inline-block">
                          {% if csq.HGVSp|length > 25 %}
                            <!-- Truncated version (initial view with ellipsis) -->
                            <div id="hgvsp-short" class="truncate overflow-hidden">
                              {{ csq.HGVSp[:25] }}...
                            </div>

                            <!-- Full text, initially hidden -->
                            <div id="hgvsp-full" class="hidden break-all whitespace-normal">
                              {{ csq.HGVSp }}
                            </div>

                            <!-- Smaller button with a subtle symbol to toggle text visibility -->
                            <button class="ml-1 text-xs text-gray-500 hover:text-blue-500 focus:outline-none"
                                    onclick="toggleText(this)">
                              [+]
                            </button>
                          {% else %}
                            {{ csq.HGVSp }}
                          {% endif %}
                        </div>
                        <br>

                        <!-- HGVSc Section -->
                        <div class="relative inline-block">
                          {% if csq.HGVSc|length > 25 %}
                            <!-- Truncated version (initial view with ellipsis) -->
                            <div id="hgvs-short" class="truncate overflow-hidden">
                              {{ csq.HGVSc[:25] }}...
                            </div>

                            <!-- Full text, initially hidden -->
                            <div id="hgvs-full" class="hidden break-all whitespace-normal">
                              {{ csq.HGVSc }}
                            </div>

                            <!-- Smaller button with a subtle symbol to toggle text visibility -->
                            <button class="ml-1 text-xs text-gray-500 hover:text-blue-500 focus:outline-none"
                                    onclick="toggleText(this)">
                              [+]
                            </button>
                          {% else %}
                            {{ csq.HGVSc }}
                          {% endif %}
                        </div>
                      </td>

                      <td class="p-2 font-medium" id="cnv-table-row-type">
                        {{ var.variant_class }}
                      </td>
                      {% if csq.Consequence is iterable and csq.Consequence is not string %}
                        <td class="p-2 font-medium" id="cnv-table-row-conseq">
                        {% for conseq in csq.Consequence %}
                          {% if conseq in translation %}
                            {{ translation[conseq] }}<br>
                          {% else %}
                            {{ conseq }}<br>
                          {% endif %}
                        {% endfor %}
                        </td>
                      {% else %}
                        {% if csq.Consequence in translation %}
                          <td class="p-2 font-medium" id="cnv-table-row-conseq">{{ translation[csq.Consequence] }}</td>
                        {% else %}
                          <td class="p-2 font-medium" id="cnv-table-row-conseq">{{ csq.Consequence.split('&')|join('<br>')|safe }}</td>
                        {% endif %}
                      {% endif %}
                      <td class="p-2 font-bold" id="cnv-table-row-popFreq">
                        {% if "gnomad_frequency" in var and var.gnomad_frequency != "" %}
                          {{ '%.3f' | format(100*var.gnomad_frequency)}}%<br>
                        {% elif "gnomad_max" in var and var.gnomad_max != "" %}
                          {{ '%.3f' | format(100*var.gnomad_max)}}%<br>
                        {% endif %}
                        {% if var.exac_frequency %}
                          ExAC: {{ var.exac_frequency|format_pop_freq(var.ALT)|safe }}<br>
                        {% endif %}
                        {% if var.thousandG_frequency %}
                          1000G: {{ var.thousandG_frequency|format_pop_freq(var.ALT)|safe }}
                        {% endif %}
                      </td>
                      <td class="p-2 font-medium" id="cnv-table-row-class">
                        {% if var.classification.class != 999 and var.classification.transcript == csq.Feature %}
                          <div class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full bg-tier{{ var.classification.class }}">
                          {% if assay == "myeloid" or assay == "tumwgs" or "assay" in var.classification %}
                            {{ var.classification.class }}
                          {% else %}
                            *
                          {% endif %}
                          </div>
                        {% elif var.additional_classification %}
                          <div class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full bg-gray-400">
                            {{var.additional_classification.tier}}
                          </div>
                        {% elif var.other_classification|length > 0 %}
                          <div class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full bg-gray-400">?</div>
                        {% endif %}
                      </td>
                      {% if assay == "swea" or assay == "tumor_exome" %}
                        <td class="p-2 font-medium" id="cnv-table-row-score">
                          <div class="text-center relative z-10 w-24 h-4 m-0 border border-gray-800">
                            <div style="position:absolute;z-index:-1;width:{{ (csq.rank_score|float / 0.8) |int }}%;height:100%;background-color:{% if csq.rank_score > 25 %}#bea{% else %}#eba{% endif %};"></div>{{ '%0.1f'| format(csq.rank_score) }}
                          </div>
                        </td>
                      {% endif %}
                      {% if assay == "swea" or assay == "gmsonco" %}
                        <td class="p-2 font-medium" id="cnv-table-row-enigma">
                          <div {% if var.INFO.ENIGMA_CLNSIG=="Pathogenic" %}class='bg-pink-300 px-1 py-0.5 font-bold inline-block text-red-800 rounded-md'{% endif %}>{{ var.INFO.ENIGMA_CLNSIG }}</div>
                        </td>
                      {% endif %}
                      {% if assay == "solid" %}
                        <td class="p-2 font-medium" id="cnv-table-row-chrPos">
                          <div class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full {% if csq.mmhotspot %}bg-red-400{% else %}bg-gray-400{% endif %}">
                            {{ var.CHROM }}:{{ var.POS }}
                          </div>
                        </td>
                        <td class="p-2 font-medium" id="cnv-table-row-hotspot">
                          {% if var.INFO.HOTSPOT %}
                            <div class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full">
                              {{ var.INFO.HOTSPOT|format_hotspot|safe }}
                            </div>
                          {% endif %}
                        </td>
                      {% else %}
                        <td class="p-2 font-medium" id="cnv-table-row-chrPos">
                          <div class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full bg-gray-400">
                            {{ var.CHROM }}:{{ var.POS }}
                          </div>
                        </td>
                      {% endif %}
                      <td class="p-2 font-medium" id="cnv-table-row-flags">
                        <div class="inline-block px-2 py-1 text-xs font-semibold text-white rounded-full">{{ var.FILTER|format_filter|safe }}</div>
                      </td>
                      {% if assay == "swea" %}
                        <td class="p-2 font-medium" id="cnv-table-row-gt">
                          {% for gt in var.GT|sort(attribute='type') %}
                            {% if gt.type == "case" %}
                              <img class="{% if gt.GT=='0/0' %}filter-grayscale-opacity{% endif %} w-5" src="{{ url_for('static', filename='images/krabba3.png') }}">
                            {% endif %}
                            {% if gt.type == "control" %}
                              <img class="{% if gt.GT=='0/0' %}filter-grayscale-opacity{% endif %} w-5" src="{{ url_for('static', filename='images/blood.png') }}">
                            {% endif %}
                          {% endfor %}
                        </td>
                      {% endif %}
                      {% for gt in var.GT|sort(attribute='type') %}
                        {% if gt.type == "case" %}
                          <td class="p-2 font-medium" id="cnv-table-row-case" sorttable_customkey="{{ gt.AF }}">
                        {% else %}
                          <td class="p-2 font-medium" id="cnv-table-row-control" sorttable_customkey="{{ gt.AF }}">
                        {% endif %}
                          {% if gt.DP < settings.error_cov %}
                            <span class="font-bold" style='color:red; font-weight:bold;'>
                          {% elif gt.DP < settings.warn_cov %}
                            <span class="font-bold" style='color:#dd7700'>
                          {% else %}
                            <span>
                          {% endif %}
                            {{ '%0.1f'| format(100*gt.AF|float) }}% ({{ gt.VD|int }} / {{ gt.DP|int }})
                          </span>
                        </td>
                      {% endfor %}
                      <td class="py-2 px-4 border-b border-gray-300 text-blue-500 hover:underline" id="cnv-table-row-view"><a href="{{ url_for('dna_bp.show_variant', id=var._id) }}">view</a></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <em class="block text-center text-gray-500 text-sm italic bg-gray-100 p-4 rounded-b-lg border border-gray-300 shadow-md">
              No variants found with the current filter settings!
              <br>
            </em>      
          {% endif %}
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- CNV Card -->
  {% if cnvwgs or sample.cnvprofile %}
    <div id="cnv-div" class="bg-white rounded-lg my-8">
      <!-- CNV Toggle Button -->
      <div class="flex justify-between items-center bg-purple-200 text-black rounded-md px-4 py-2">
        <h2 class="text-base font-semibold tracking-wide uppercase">CNVs ({{ cnvwgs|length }})</h2>
        <button class="focus:outline-none" onclick="toggleCard('cnv-content')">
          <img id="arrow-icon" src="{{ url_for('static', filename='icons/up-arrow-240.png') }}" alt="Toggle CNV Card" class="w-6 h-6 transform transition-transform duration-200 filter invert">
        </button>
      </div>

      <!-- CNVs Collapsible Content -->
      <div class="mx-auto py-4 mx-2" id="cnv-content">
        <div class="flex flex-wrap gap-4">

          <!-- CNV Plot -->
          {% if sample.cnvprofile %}
            <div class="flex-grow-0 bg-transparent pr-4" id="cnv-plot-div">
              <h2 class="text-sm bg-gradient-to-b from-purple-200 to-white font-semibold tracking-wide p-3 shadow-lg rounded-t-lg capitalize">
                CNV Profile
              </h2>
              <div class="overflow-auto rounded-b-lg shadow-sm px-6 py-5" id="cnv-plot">
                {% set build = 37 %}
                {% if "genome_build" in sample %}
                  {% set build = sample.genome_build %}
                {% endif %}
                <div class="flex justify-center">
                  <a href="{{ url_for('dna_bp.show_any_plot', fn=sample.cnvprofile|basename , assay=assay, build=build|int ) }}">
                    <img class="rounded-lg border border-gray-300 shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-900" src="{{ url_for('dna_bp.show_any_plot', fn=sample.cnvprofile|basename , assay=assay, build=build|int ) }}"></a>
                </div>
                <div class="text-center my-4">
                  {% if build|int == 38 %}
                    {% for type, sample_id in sample_ids.items() %}
                      <br><a href="http://10.231.229.34/gens/{{sample_id}}?hg_type=38" class="text-blue-500 hover:underline hover:text-blue-800 transition-colors duration-300" target="_blank">Open <b>{{sample_id}}</b> ({{type}}) in Gens</a>
                    {% endfor %}
                  {% else %}
                    <br><a href="http://10.231.229.21/gens/{{ sample.name }}?region=1" class="text-blue-500 hover:underline hover:text-blue-800 transition-colors duration-300" target="_blank">Show in Gens</a>
                  {% endif %}
                </div>
              </div>    
            </div>
          {% endif %}


          <!-- CNV Tables -->
          <div class="flex-grow-0 bg-transparent mr-4 rounded-b-md overflow-auto" id="cnv-table-div-header">
            <div class="flex items-center justify-between bg-gradient-to-b from-purple-200 to-white shadow-lg rounded-t-lg">
              <h2 class="text-sm font-semibold tracking-wide p-3 capitalize">
                Tumor CNVs passing filter criteria 
              </h2> 
              <img src="{{ url_for('static', filename='icons/save-100.png') }}" alt="Export to CSV - CNVs" onclick="exportTableToCSV('{{ sample.name }}.filtered.cnvs.csv', 'cnvs-table')" class="cursor-pointer w-6 h-6 mr-4 transition-transform transform hover:scale-110" id="export-cnvs-table"/>
            </div>
            {% if cnvwgs and cnvwgs|length > 0 %}
              <div class="rounded-b-lg shadow-md overflow-auto" id="cnvs-table-div">
                <table class="table-auto text-xs mb-1 sortable" id="cnvs-table">
                  <thead>
                    <tr class="border-b text-left border-gray-300 capitalize" id="cnv-table-header">
                      <th class="p-3 font-semibold" id="cnv-table-header-genes">Genes</th>
                      <th class="p-3 font-semibold" id="cnv-table-header-region">Region</th>
                      <th class="p-3 font-semibold" id="cnv-table-header-size">Size</th>
                      {% if assay == "solid" or assay == "gmsonco" %}
                        <th class="p-3 font-semibold" id="cnv-table-header-callers">Callers</th>
                      {% endif %}
                        <th class="p-3 font-semibold" id="cnv-table-header-cn">Copy number</th>
                      {% if sample.purity %}
                        <th class="p-3 font-semibold" id="cnv-table-header-purity">Purity {{ sample.purity }}</th>
                      {% endif %}
                      {% if assay == "solid" or assay == "gmsonco" %}
                        <th class="p-3 font-semibold" id="cnv-table-header-sr">SR (ref/alt)</th>
                      {% endif %}
                      <th class="p-3 font-semibold" id="cnv-table-header-status">Status</th>
                      <th class="p-3 font-semibold" id="cnv-table-header-view">View</th>
                    </tr>
                  </thead>
                  <tbody class="mx-2">
                    {#% for cnv in cnvwgs if (cnv.ratio|float < -0.3 or cnv.ratio|float > 0.3) and ((cnv.size|abs < (sizefilter|int) and cnv.size|abs > (sizefilter_min|int)) or cnv.ratio|float > 3) and (cnv.panel_gene|intersect(dispgenes) or dispgenes|length == 0 or assay == "tumwgs") %#}
                    {% for cnv in cnvwgs %}
                      {% if cnv.interesting %}
                        <tr class="bg-green-100 hover:bg-green-200 border-b border-gray-300 text-left" id="cnv-table-row-interesting">
                      {% elif cnv.ratio > 3 and cnv.size > (sizefilter|int) %}
                        <tr class="bg-red-100 border-b text-left" id="cnv-table-row">
                      {% else %}
                        <tr class="border-b text-left" id="cnv-table-row">
                      {% endif %}
                      <td class="p-2 font-medium" id="cnv-table-row-genes">
                        {% set non_panel_genes = [0] %}
                        {% for gene in cnv.genes %}
                          {% if gene.class %}
                            {{ gene.gene }}<br>
                          {% else %}
                            {% if non_panel_genes.append(non_panel_genes.pop() + 1) %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                        {% if non_panel_genes[0] > 0 %}
                          <font class='text-gray-400'>+ {{ non_panel_genes[0] }} other genes</font>
                        {% endif %}
                      </td>
                      <td class="p-2 font-medium" id="cnv-table-row-region">
                        <div class="inline-block px-2 py-1 text-white rounded-full bg-gray-400">
                          {{ cnv.chr }}:{{ cnv.start }}-{{ cnv.end }}
                        </div>
                      </td>
                      <td class="p-2 font-medium" id="cnv-table-row-size">
                        {{ cnv.size|abs }} bp
                      </td>
                      {% if assay == "solid" or assay == "gmsonco" %}
                        <td class="p-2 font-medium" id="cnv-table-row-callers">
                          {{ cnv.callers }}
                        </td>
                        {% if "gatk" in cnv.callers or "cnvkit" in cnv.callers %}
                          <td class="p-2 font-medium" id="cnv-table-row-ratio">
                            {{ 2*(2**cnv.ratio)|round(2) }} ({{ cnv.ratio }})
                          </td>
                          {% if sample.purity %}
                            {% if cnv.ratio > 0 %}
                              <td class="p-2 font-medium" id="cnv-table-row-purity">
                                {{ (2*(2**cnv.ratio)*1/sample.purity)|round(2) }}
                              </td>
                            {% else %}
                              <td class="p-2 font-medium" id="cnv-table-row-purity">
                                {{ (2*(2**cnv.ratio)*sample.purity)|round(2) }}
                              </td>
                            {% endif %}
                          {% endif %}
                          {% if "manta" in cnv.callers %}
                            <td class="p-2 font-medium" id="cnv-table-row-pr">
                              {{ cnv.PR }}
                            </td>
                          {% else %}
                            <td class="p-2 font-medium" id="cnv-table-row-pr">
                              -
                            </td>
                          {% endif %}
                        {% else %}
                          {% if assay == "solid" %}
                            <td class="p-2 font-medium" id="cnv-table-row-pr">
                              -
                            </td>
                          {% endif %}
                          <td class="p-2 font-medium" id="cnv-table-row-pr">
                            -
                          </td>
                          <td class="p-2 font-medium" id="cnv-table-row-pr">
                            {{ cnv.PR }}
                          </td>
                        {% endif %}
                      {% else %}
                        <td class="p-2 font-medium" id="cnv-table-row-ratio">
                          {{ 2*(2**cnv.ratio)|round(2) }} ({{ cnv.ratio }})
                        </td>
                      {% endif %}
                      <td class="p-2 font-medium" id="cnv-table-row-status">
                        {% if cnv.interesting %}
                          report
                        {% endif %}
                      </td>
                      <td class="p-2 font-medium" id="cnv-table-row-view">
                        <a href="{{ url_for('dna_bp.show_cnv', id=cnv._id) }}" class="text-blue-500 hover:underline">view</a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <em class="block text-center text-gray-500 text-sm italic bg-gray-100 p-4 rounded-b-lg border border-gray-300 shadow-md">
                No cnvs found with the current filter settings!
                <br>
              </em>     
            {% endif %}
            </div>
        </div>
      </div>
    </div>
  {% endif %}


  <!-- Translocations Card -->
  {% if transloc %}
    <div id="transloc-div" class="bg-white rounded-lg my-8">
      <!-- Translocations Toggle Button -->
      <div class="flex justify-between items-center bg-blue-200 text-black rounded-md px-4 py-2">
        <h2 class="text-base font-semibold tracking-wide uppercase">Translocations ({{ transloc.count() }})</h2>
        <button class="focus:outline-none" onclick="toggleCard('transloc-content')">
          <img id="arrow-icon" src="{{ url_for('static', filename='icons/up-arrow-240.png') }}" alt="Toggle Transloc Card" class="w-6 h-6 transform transition-transform duration-200 filter invert">
        </button>
      </div>
      <div class="mx-auto py-4 mx-2" id="transloc-content">
        <div class="flex flex-wrap gap-4">
          <!-- Translocations Table -->
          <div class="flex-grow-0 bg-transparent overflow-auto" id="transloc-table-div-header">
            <div class="flex items-center justify-between bg-gradient-to-b from-blue-200 to-white shadow-lg rounded-t-lg">
              <h2 class="text-sm font-semibold tracking-wide p-3 capitalize">
                Gene fusions passing filter criteria
              </h2> 
              <img src="{{ url_for('static', filename='icons/save-100.png') }}" alt="Export to CSV - transloc" onclick="exportTableToCSV('{{ sample.name }}.filtered.transloc.csv', 'transloc-table')" class="cursor-pointer w-6 h-6 mr-4 transition-transform transform hover:scale-110" id="export-transloc-table"/>
            </div>
            {% if transloc and transloc.count() > 0 %}
              <div class="overflow-auto rounded-b-lg shadow-md">
                <table class="table-auto text-xs overflow-hidden mb-1">
                  <thead>
                    <tr class="border-b text-left border-gray-300 capitalize" id="transloc-table-header">
                      <th class="p-3 font-semibold" id="transloc-table-header-gene1">Gene 1</th>
                      <th class="p-3 font-semibold" id="transloc-table-header-gene2">Gene 2</th>
                      <th class="p-3 font-semibold" id="transloc-table-header-positions">Positions</th>
                      <th class="p-3 font-semibold" id="transloc-table-header-type">Type</th>
                      <th class="p-3 font-semibold" id="transloc-table-header-hgvs">HGVS</th>
                      <th class="p-3 font-semibold" id="transloc-table-header-panel">Panel</th>
                      <th class="p-3 font-semibold" id="transloc-table-header-status">Status</th>
                      <th class="p-3 font-semibold" id="transloc-table-header-view">View</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for tl in transloc %}
                      {% set ANN = tl.INFO.MANE_ANN or tl.INFO.ANN[0] %}
                      {% set genes = ANN.Gene_Name.split('&') %}
                      {% if tl.interesting %}
                        <tr class="bg-green-100 hover:bg-green-200 border-b border-gray-300 text-left" id="transloc-table-row-interesting">
                      {% else %}    
                        <tr class="border-b text-left" id="transloc-table-row">
                      {% endif %}
                        <td class="p-2 font-medium" id="transloc-table-row-gene1">
                          {{ genes[0] }}
                        </td>
                        <td class="p-2 font-medium" id="transloc-table-row-gene2">
                          {{ genes[1] }}
                        </td>
                        <td class="p-2 font-medium" id="transloc-table-row-positions">
                          {{ tl.CHROM }}:{{ tl.POS }} {{ tl.ALT }}
                        </td>
                        <td class="p-2 font-medium" id="transloc-table-row-type">
                          {% for annot in ANN.Annotation %}
                            {{ annot }}<br>
                          {% endfor %}
                        </td>
                        <td class="p-2 font-medium" id="transloc-table-row-hgvs">
                          {{ ANN.HGVSp|unesc }}<br>{{ ANN.HGVSc|unesc }}
                        </td>
                        <td class="p-2 font-medium" id="transloc-table-row-panel">
                          {{ tl.INFO.PANEL }}
                        </td>
                        <td class="p-2 font-medium" id="transloc-table-row-status">
                          {% if tl.interesting %}
                            report
                          {% endif %}
                        </td>
                        <td class="p-2 font-medium" id="transloc-table-row-view">
                          <a href="{{ url_for('dna_bp.show_transloc', id=tl._id) }}" class="text-blue-500 hover:underline">view</a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <em class="block text-center text-gray-500 text-sm italic bg-gray-100 p-4 rounded-b-lg border border-gray-300 shadow-md">
                No translocations found with the current filter settings!
                <br>
              </em> 
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}


  <!-- Fusion Card -->
  {% if fusions %}
    <div id="fusion-div" class="bg-white rounded-lg my-8">
      <!-- Fusion Toggle Button -->
      <div class="flex justify-between items-center bg-yellow-200 text-black rounded-md px-4 py-2">
        <h2 class="text-base font-semibold tracking-wide uppercase">DNA Fusions ({{ fusions|length }})</h2>
        <button class="focus:outline-none" onclick="toggleCard('fusion-content')">
          <img id="arrow-icon" src="{{ url_for('static', filename='icons/up-arrow-240.png') }}" alt="Toggle Fusion Card" class="w-6 h-6 transform transition-transform duration-200 filter invert">
        </button>
      </div>

      <div class="mx-auto py-4 mx-2" id="fusion-content">
        <div class="flex flex-wrap gap-4">
          <!-- Fusion Table -->
          {% if fusions|length > 0 %}
            <div class="flex-grow-0 bg-transparent" id="fusion-table-div-header">
              <div class="flex items-center justify-between bg-gradient-to-b from-yellow-200 to-white shadow-lg rounded-t-lg">
                <h2 class="text-sm font-semibold tracking-wide p-3 capitalize">
                  Fusions passing filter criteria
                </h2> 
                <img src="{{ url_for('static', filename='icons/save-100.png') }}" alt="Export to CSV - fusion" onclick="exportTableToCSV('{{ sample.name }}.filtered.fusion.csv', 'fusion-table')" class="cursor-pointer w-6 h-6 mr-4 transition-transform transform hover:scale-110" id="export-fusion-table"/>
              </div>
              <div class="overflow-auto rounded-b-lg shadow-md" id="fusion-table-div">
                <table class="table-auto text-xs overflow-hidden mb-1" id="fusion-table">
                  <thead>
                    <tr class="border-b text-left border-gray-300 capitalize" id="fusion-table-header">
                      <th class="p-3 font-semibold" id="fusion-table-header-gene1">Gene 1</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-gene2">Gene 2</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-effect">Effect</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-spanpairs">Spanning pairs</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-unique-spanpairs" data-autoclick="true">Unique spanning reads</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-fusion-points">Fusion points</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-tier">Tier</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-desc">Description</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-callers">Callers</th>
                      <th class="p-3 font-semibold" id="fusion-table-header-view">View</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for fus in fusions %}
                      {% set genes = fus.genes.split('^') %}
                      {% set sel_fus = (fus.calls|selectattr('selected', 'equalto', 1) |list)[0] %}
                      {% if fus.blacklisted or fus.fp %}
                        <tr class="bg-red-100 opacity-40 hover:bg-red-200 border-b text-left"id="fusions-table-row-blacklisted">
                      {% else %}
                        <tr class="border-b text-left" id="fusions-table-row">
                      {% endif %}
                        <td class="p-2 font-medium" id="fusions-table-row-gene1">
                          {{ genes[0] }}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-gene2">
                          {{ genes[1] }}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-effect">
                          {{ sel_fus.effect }}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-spanpairs">
                          {{ sel_fus.spanpairs }}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-unique-spanpairs">
                          {{ sel_fus.spanreads }}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-fusion-points">
                          {{ sel_fus.breakpoint1 }}<br>{{ sel_fus.breakpoint2 }}
                        </td>
                        <td class="py-2 px-3 border-b border-gray-300 varlist" sorttable_customkey="{{ fus.classification.class }}"  id="fusions-table-row-tier">
                          {% if fus.classification.class != 999 %}
                            <div class="px-1 py-0 w-[11px] text-center border border-gray-600 rounded-[11px]" id="tier{{ fus.classification.class }}">
                              {{ fus.classification.class }}
                            </div>
                          {% endif %}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-desc">
                          {{ sel_fus.desc|format_fusion_desc|safe }}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-callers">
                          {{ fus.calls|uniq_callers|join("<br>")|safe }}
                        </td>
                        <td class="p-2 font-medium" id="fusions-table-row-view">
                          <a href="{{ url_for('dna_bp.show_fusion', id=fus._id) }}" class="text-blue-500 hover:underline">view</a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}


  <!-- Low Coverage Card -->
  <div id="lowcov-div" class="bg-white rounded-lg my-8" style="display:none">
    <!-- Low Coverage Toggle Button -->
    <div class="flex justify-between items-center bg-pink-200 text-black rounded-md px-4 py-2">
      <h2 class="text-base font-semibold tracking-wide uppercase">Coverage</h2>
      <button class="focus:outline-none" onclick="toggleCard('lowcov-content')">
        <img id="arrow-icon" src="{{ url_for('static', filename='icons/up-arrow-240.png') }}" alt="Toggle Coverage Card" class="w-6 h-6 transform transition-transform duration-200 filter invert">
      </button>
    </div>
    <div class="mx-auto py-4 mx-2" id="lowcov-content">
      <div class="flex flex-wrap gap-4">
        <!-- Low Coverage Table -->
        <div class="flex-grow-0 bg-transparent" id="lowcovlist_div">
          <h2 class="text-sm bg-gradient-to-b from-pink-200 to-white font-semibold tracking-wide p-3 shadow-lg rounded-t-lg capitalize">
            Low Coverage Regions
          </h2>
          <div class="overflow-auto rounded-b-lg shadow-md">
            <table class="table-auto text-xs overflow-hidden mb-1">
              <thead>
                <tr class="border-b text-left border-gray-300 capitalize" id="lowcov-table-header">
                  <th class="p-3 font-semibold" id="lowcov-table-header-region">Chromosomal region</th>
                  <th class="p-3 font-semibold" id="lowcov-table-header-size">Size (bp)</th>
                  <th class="p-3 font-semibold" id="lowcov-table-header-avgDepth" data-autoclick-once="true">Avg depth (x)</th>
                  <th class="p-3 font-semibold" id="lowcov-table-header-amplicon">Amplicon</th>
                  <th class="p-3 font-semibold" id="lowcov-table-header-cosmicIds">COSMIC variants</th>
                </tr>
              </thead>
              <tbody class="mx-2">
                {% for low in low_cov %}
                  {% if low.avg_cov < 500 %}
                    <tr class="bg-red-50 hover:bg-red-100 border-b border-gray-300 text-left" id="lowcov-table-row">
                  {% else %}
                    <tr class="hover:bg-yellow-50 border-b border-gray-300 text-left" id="lowcov-table-row">
                  {% endif %}
                    <td class="p-2 font-medium" id="lowcov-table-row-region">{{ low.chr }}:{{ low.start }}-{{ low.end }}</td>
                    <td class="p-2 font-medium" id="lowcov-table-row-size">{{ low.end - low.start + 1 }}</td>
                    <td class="p-2 font-medium" id="lowcov-table-row-avgDepth">{{ low.avg_cov|int }}</td>
                    <td class="p-2 font-medium" id="lowcov-table-row-amplicon">{{ low.amplicon }}</td>
                    <td class="p-2 font-medium" id="lowcov-table-row-cosmicIds">
                      {% for cosm in low.cosmic %}
                        <span class="block" title="{{ cosm['cnt'] }}">{{ cosm["id"] }} - {{ cosm["cnt"]["haematopoietic_and_lymphoid_tissue"] }}</span>
                      {% endfor %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Sample Comments Card -->
  <div id="sample-comments-div" class="bg-white rounded-lg my-8">
    <!-- Comments Toggle Button -->
    <div class="flex justify-between items-center bg-red-200 text-black rounded-md px-4 py-2">
      <h2 class="text-base font-semibold tracking-wide uppercase">Sample Comments</h2>
      <button class="focus:outline-none" onclick="toggleCard('sample-comments-content')">
        <img id="arrow-icon" src="{{ url_for('static', filename='icons/up-arrow-240.png') }}" alt="Toggle Comments Card" class="w-6 h-6 transform transition-transform duration-200 filter invert">
      </button>
    </div>

    <div class="mx-auto py-4 mx-2" id="sample-comments-content">
      <div class="flex flex-wrap gap-4">
        {% if sample.comments|length > 0 %}
          <div class="flex-grow-0 bg-transparent" id="comments-table-div-header">
            <h2 class="text-sm bg-gradient-to-b from-red-200 to-white font-semibold tracking-wide p-3 shadow-lg rounded-t-lg capitalize">
              Comments
            </h2>
            <div class="rounded-b-lg shadow-md" id="comments-table-div">
              <table class="table-auto text-xs mb-1" id="comments-table">
                <thead>
                  <tr class="border-b text-left border-gray-300 capitalize" id="comments-table-header">
                    <th class="p-3 font-semibold" id="comments-table-header-who">Who</th>
                    <th class="p-3 font-semibold" id="comments-table-header-comment">Comment</th>
                    <th class="p-3 font-semibold" id="comments-table-header-view">Hide/Unhide</th>
                  </tr>
                </thead>
                <tbody>
                  {% for comment in sample.comments|sort(attribute='time_created', reverse=True) %}
                    {% if comment.hidden != 1 %}
                      <tr class="border-b text-left" id="comment-table-row">
                    {% else %}
                      <tr class="bg-red-200 opacity-40 border-b text-left hidden hidden_comment" id="comment-table-row-hidden">
                    {% endif %}
                      <td class="px-2 font-medium whitespace-nowrap align-top py-4" id="comments-table-header-who">
                        <b>{{ comment.author }}</b><br><small>{{ comment.time_created|human_date }}</small>
                      </td>
                      <td class="p-2 font-medium" id="comments-table-header-comment" onclick='addText(event)'>
                        {{ comment.text|format_comment|safe }}
                      </td>
                      <td class="px-2 font-medium align-top py-4" id="comments-table-header-view">
                        {% set hidden_exists = 0 %}
                        {% if comment.hidden != 1 %}
                          <form action="{{ url_for('common_bp.hide_sample_comment', sample_id=sample._id) }}" method="post">
                            <input type="hidden" name="comment_id" value="{{ comment._id }}">
                            <input id="hide_comment" type="image" class="w-5" src="{{ url_for('static', filename='images/delete.png') }}">
                          </form>
                        {% else %}
                          {% set hidden_exists = 1 %}
                          <form action="{{ url_for('common_bp.unhide_sample_comment', sample_id=sample._id) }}" method="post">
                            <input type="hidden" name="comment_id" value="{{ comment._id }}">
                            <input id="unhide_comment" type="image" class="w-5" src="{{ url_for('static', filename='images/unhide.png') }}">
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                  {% if hidden_comments %}
                    <tr>
                      <td colspan=4 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                        <a href="javascript:void(0)" onclick="switchVisibility('hidden_comment')"><b>Show/hide deleted comments</b></a>
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}

        <!-- Add comments box -->
        <div class="min-w-50_per flex-grow-1 bg-transparent px-2" id="comments-box-div-header">
          <h2 class="text-base bg-gradient-to-b from-red-200 to-white font-semibold tracking-wide p-3 shadow-lg rounded-t-lg capitalize">
            Add Comments
          </h2>
          <div class="min-w-full overflow-auto rounded-b-lg shadow-md" id="comments-box-div">
            <form action="{{ url_for('common_bp.add_sample_comment', id=sample._id) }}" method="post">
              <textarea id="comment_textarea" name="sample_comment" placeholder="Enter sample comment..." class="w-11/12 p-4 border border-gray-300 rounded mx-5 my-4 h-40"></textarea><br>
              <input type="submit" value="Save comment" class="bg-blue-400 hover:bg-blue-600 text-white font-bold rounded py-1 px-2 my-4 ml-6 mr-2">
              <button type="button" class="bg-gray-400 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded py-1 px-2 my-4 mx-2" onclick="addAIText()">Suggest</button>
            </form>
            <div id="suggestion" class="hidden">
              {{ ai_text }}
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>


</div>

<script>
  function addAIText() {
    var suggestion = document.getElementById("suggestion").innerHTML.trim();
    document.getElementById("comment_textarea").value = suggestion;
  }

  function addText(event) {
    var targ = event.target || event.srcElement;
    if (!targ.closest('tr').classList.contains('hidden_comment')) {
      document.getElementById("comment_textarea").value = targ.textContent || targ.innerText;
    }
  }

  function addText(event) {
    var targ = event.target || event.srcElement;
    if (!targ.closest('tr').classList.contains('hidden_comment')) {
      const textarea = document.getElementById('comment_textarea');
      const text = event.target.innerText.trim();
      textarea.value = text;
    }
  }
  
  window.onload = function () {
    document.querySelectorAll('[data-autoclick="true"]').forEach(element => element.click());
    document.querySelectorAll('[data-autoclick-once="true"]').forEach(element => element.click());
  };
  
  var expanded = false;
  function toggleFilters() {
    var filterCard = document.getElementById("filter_card");
    filterCard.style.display = expanded ? "none" : "block";
    expanded = !expanded;
  }
  
  function show_lowcov() {
    var lowcovDiv = document.getElementById("lowcov-div");
    lowcovDiv.style.display = lowcovDiv.style.display == "none" ? "block" : "none";
  }
  
  function show_germlinecnv() {
    var germlineDiv = document.getElementById("germline_div");
    germlineDiv.style.display = germlineDiv.style.display == "none" ? "block" : "none";
  }
  
  function switchVisibility(class_name) {
    var elems = document.getElementsByClassName(class_name);
    for (var i = 0; i < elems.length; i++) {
      elems[i].classList.toggle('hidden');
    }
  }
  

  function showCheckboxes(id) {
    var checkboxes = document.getElementById(id);
    checkboxes.style.display = checkboxes.style.display === 'block' ? 'none' : 'block';
  }

  // JavaScript for Expand/Collapse functionality
  function toggleText(button) {
    var shortText = button.previousElementSibling.previousElementSibling;
    var fullText = button.previousElementSibling;

    // Toggle between short and full text
    if (fullText.classList.contains('hidden')) {
      shortText.classList.add('hidden');   // Hide truncated text
      fullText.classList.remove('hidden'); // Show full text
      button.textContent = '[-]';          // Change button text to Collapse
    } else {
      shortText.classList.remove('hidden'); // Show truncated text
      fullText.classList.add('hidden');     // Hide full text
      button.textContent = '[+]';           // Change button text to Expand
    }
  }

  // JavaScript for Expand/Collapse functionality
  function toggleCard(cardId) {
    var card = document.getElementById(cardId);
    var arrowIcon = card.parentElement.querySelector('#arrow-icon');
  
    if (card.classList.contains('hidden')) {
      card.classList.remove('hidden'); // Show the content
      arrowIcon.classList.remove('rotate-180'); // Rotate arrow downwards
    } else {
      card.classList.add('hidden'); // Hide the content
      arrowIcon.classList.add('rotate-180'); // Reset arrow to upwards
    }
  }

  // Export csv function
  function exportTableToCSV(filename, tableId) {
    // Get the table element by its ID
    const table = document.getElementById(tableId);
    if (!table) {
      console.error(`Table with ID "${tableId}" not found.`);
      return;
    }
  
    let csv = [];
    
    // Get all rows from the table
    const rows = table.querySelectorAll('tr');
  
    // Loop through each row
    rows.forEach((row) => {
      let rowData = [];
      const cells = row.querySelectorAll('th, td'); // Get header and data cells
      cells.forEach((cell) => {
        // Extract text content and replace line breaks with ";"
        let cellContent = cell.innerText.replace(/\n/g, ';').trim();
        rowData.push(cellContent);
      });
      csv.push(rowData.join(',')); // Join cells with a comma
    });
  
    // Convert the array to a CSV string
    const csvString = csv.join('\n');
  
    // Create a Blob and download the CSV file
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  
  
  
  

</script>


{% endblock %}


