{% extends "layout.html" %}

{% block body %}
{% set translation=config["TRANS"] %}

<div class="flex w-full h-full overflow-hidden">

  <!-- LEFT SIDEBAR (Fixed Width, Full Height) -->
  <aside class="w-8 bg-transparent text-white flex flex-col">

    {% if fusions %}
      <div class="flex border-l-8 border-yellow-400 ">
        <a href="#fusions"
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">Fusions</span>
        </a>
      </div>
    {% endif %}

    {% if sample.classification %}
      <div class="flex border-l-8 border-blue-400">
        <a href="#classification"
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">Class</span>
       </a>
      </div>
    {% endif %}

    {% if sample.expr %}
      <div class="flex border-l-8 border-blue-400">
        <a href="#expression"
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">expression</span>
        </a>
      </div>
    {% endif %}

    <div class="flex border-l-8 border-teal-400 mt-1">
      <a href="#summary"
        class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
          <span class="vertical-text">Summary</span>
      </a>
    </div>

    {% if sample.cov %}
      <div class="flex border-l-8 border-orange-400 mt-1">
        <a href="{{ url_for('cov_bp.get_cov', sample_id=sample.name) }}"
          class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">Coverage</span>
        </a>
      </div>
    {% endif %}

    <div class="flex border-l-8 border-orange-400 ">
      <a href="#lowcov"
        class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
          <span class="vertical-text">Low Cov</span>
      </a>
    </div>
  </aside>

  <!-- MAIN CONTENT (Scrollable & Auto-Resizing) -->
  <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col">

    <!-- Sample Info Card (Auto-Wrapping, Full Flexbox) -->
    {% include "sample_meta_rna_info.html" %}

    <!-- Selected Gene Panel Card -->
    {% include "selected_fusion_panel_div.html" %}

    <!-- Fusion Table -->
    {% if fusions|length %}
    <section id="fusions" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
      <!-- Fusions Header -->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">
          <span id="fusions-count-label">Fusions ({{ fusions|length }})</span>
        </h2>
      </div>

      <!-- Fusions Content -->
      <div class="mx-auto py-2">
        <div class="flex flex-wrap gap-4">
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
            <!-- Sticky Header -->
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Fusions Passing Filter Criteria</h2>
              <img
                src="{{ url_for('static', filename='icons/heroicons_outline_24/document-arrow-down.svg') }}"
                alt="Export to CSV - Fusions"
                onclick="exportTableToCSV('{{ sample.name }}.fusions.csv', 'fusions-table')"
                class="w-6 h-6 transition-transform transform hover:scale-110 cursor-pointer"
              />
            </div>

            <div class="overflow-auto relative">
              <table id="fusions-table" class="w-full shadow-md rounded-b-lg text-xs text-gray-800">
                <thead class="sortable capitalize tracking-wide bg-yellow-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="px-2 py-3 font-semibold">Gene 1</th>
                    <th class="px-2 py-3 font-semibold">Gene 2</th>
                    <th class="px-2 py-3 font-semibold">Effect</th>
                    <th class="px-2 py-3 font-semibold">Spanning Pairs</th>
                    <th class="px-2 py-3 font-semibold">Unique Reads</th>
                    <th class="px-2 py-3 font-semibold">Fusion Points</th>
                    <th class="px-2 py-3 font-semibold">Tier</th>
                    <th class="px-2 py-3 font-semibold">Description</th>
                    <th class="px-2 py-3 font-semibold">Callers</th>
                    <th class="px-2 py-3 font-semibold" data-nosort="true">View</th>
                  </tr>
                </thead>
                <tbody>
                  {% for fus in fusions %}
                    {% set genes = fus.genes.split('^') %}
                    {% set sel_fus = (fus.calls|selectattr('selected', 'equalto', 1) | list)[0] %}
                    <tr class="{% if fus.blacklisted or fus.fp %}bg-red-200 opacity-60 hover:bg-red-300{% else %}hover:bg-gray-100{% endif %} border-t border-gray-400 text-left">
                      <td class="px-2 py-2">{{ genes[0] }}</td>
                      <td class="px-2 py-2">{{ genes[1] }}</td>
                      <td class="px-2 py-2">{{ sel_fus.effect }}</td>
                      <td class="px-2 py-2">{{ sel_fus.spanpairs }}</td>
                      <td class="px-2 py-2">{{ sel_fus.spanreads }}</td>
                      <td class="px-1">{{ sel_fus.breakpoint1 }}<br>{{ sel_fus.breakpoint2 }}</td>
                      <td class="px-2 py-2">
                        {% if fus.classification.class != 999 %}
                          <div class="inline-flex items-center px-2 py-1 font-semibold rounded-full bg-tier{{ fus.classification.class }} text-white shadow-md">
                            {{ fus.classification.class }}
                          </div>
                        {% endif %}
                      </td>

                      <td class="px-2 py-2 w-60 align-top">
                        {% if sel_fus.desc %}
                          <div x-data="{ expanded: false }" class="space-y-1">
                            <div x-show="!expanded" x-cloak>
                              {{ sel_fus.desc | format_fusion_desc_few(1) | safe }}
                              <button
                                @click="expanded = true"
                                class="text-blue-500 text-xs underline ml-1 focus:outline-none">Show more
                              </button>
                            </div>
                            <div x-show="expanded" x-cloak>
                              {{ sel_fus.desc | format_fusion_desc | safe }}
                              <button
                                @click="expanded = false"
                                class="text-blue-500 text-xs underline ml-1 focus:outline-none">Show less
                              </button>
                            </div>
                          </div>
                        {% else %}
                          <span class="italic text-gray-400">No description</span>
                        {% endif %}
                      </td>

                      <td class="px-2 py-2">{{ fus.calls|uniq_callers|join("<br>")|safe }}</td>
                      <td class="px-2 py-2">
                        <a href="{{ url_for('rna_bp.show_fusion', sample_id=sample.name, fusion_id=fus._id) }}"
                          class="inline-block px-1 py-1 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-300">
                          View
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
    {% endif %}

    <div class="flex flex-col md:flex-row gap-4">

    <!-- Expression Table -->
    {% if sample.expr %}
    <section id="expression" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 w-full md:w-1/2">

      <!-- Expression Header -->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">
          Expression of Selected Genes
        </h2>
      </div>

      <!-- Expression Table -->
      <div class="mx-auto py-2">
        <div class="flex flex-wrap gap-4">
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">

            <!-- Sticky Top Info -->
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Gene Expression Metrics</h2>
            </div>

            <div class="overflow-auto relative">
              <table class="w-full table-fixed text-xs text-gray-800">
                <thead class="capitalize tracking-wide bg-yellow-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="px-2 py-3 font-semibold w-1/4">Gene</th>
                    <th class="px-2 py-3 font-semibold w-1/4">TPM</th>
                    <th class="px-2 py-3 font-semibold w-1/4">TPM Mean</th>
                    <th class="px-2 py-3 font-semibold w-1/4">Z-Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for data in sample.expr.sample %}
                    {% if data.hgnc_symbol %}
                    <tr class="hover:bg-gray-100 border-t border-gray-400">
                      <td class="px-2 py-2">{{ data.hgnc_symbol }}</td>
                      <td class="px-2 py-2">{{ '%0.2f'| format(data.sample_expression) }}</td>
                      <td class="px-2 py-2">{{ '%0.2f'| format(data.reference_mean) }}</td>
                      <td class="px-2 py-2">
                        {% set zscore = data.z %}
                        <div class="relative w-full border border-gray-700 rounded-md overflow-hidden text-center text-xs font-medium">
                          <div class="absolute top-0 left-1/2 h-full w-px bg-gray-500"></div>
                          {% if zscore >= 0 %}
                            <div class="absolute top-0 left-1/2 h-full bg-green-300" style="width: {{ zscore * 6 }}px;"></div>
                          {% else %}
                            <div class="absolute top-0 right-1/2 h-full bg-red-300" style="width: {{ -zscore * 6 }}px;"></div>
                          {% endif %}
                          <div class="relative z-10 py-0.5 text-left">{{ '%0.2f'| format(zscore) }}</div>
                        </div>
                      </td>
                    </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </section>
    {% endif %}

    <!-- Classification Table -->
    {% if sample.classification %}
    <section id="classification" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 w-full md:w-1/2">

      <!-- Classification Header -->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">
          Expression-Based Classification ({{ sample.classification.classifier_version }})
        </h2>
      </div>

      <!-- Classification Table -->
      <div class="mx-auto py-2">
        <div class="flex flex-wrap gap-4">
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">

            <!-- Sticky Top Info -->
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-brown-200 to-yellow-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Classifier Scores</h2>
            </div>

            <div class="overflow-auto relative">
              <table class="w-full table-fixed text-xs text-gray-800">
                <thead class="capitalize tracking-wide bg-yellow-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="px-2 py-3 font-semibold w-1/2">Class</th>
                    <th class="px-2 py-3 font-semibold w-1/2">Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for c in sample.classification.classifier_results %}
                  <tr class="hover:bg-gray-100 border-t border-gray-400">
                    <td class="px-2 py-2">{{ c.class }}</td>
                    <td class="px-2 py-2">
                      <div class="relative w-full border border-gray-700 rounded-md overflow-hidden text-center text-xs font-medium">
                        <div class="absolute top-0 left-0 h-full bg-blue-300" style="width: {{ (c.score * 100)|string }}%;"></div>
                        <div class="relative z-10 py-0.5">{{ '%0.2f' | format(c.score) }}</div>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </section>
    {% endif %}
    </div>


    <!-- Summary Comments Card -->
    <section id="summary" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
      <!-- Summary Header -->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Summary</h2>
      </div>
      {% set summary_add_comment_action = url_for('common_bp.add_sample_comment', sample_id=sample._id) %}
      {% set summary_preview_url = url_for('rna_bp.generate_rna_report', sample_id=sample.name) %}
      {% set summary_show_add_form = true %}
      {% set summary_enforce_acl = false %}
      {% set summary_comment_cell_has_id = true %}
      {% set summary_button_row_margin = 'mb' %}
      {% include "components/summary_comments_card.html" %}
    </section>

  </main>

  <!-- Right Filter Sidebar -->
  {% include "fusion_sidebars.html" %}
</div>


<script>
  {% include "components/list_page_common_js.html" %}
  {% include "components/summary_markdown_editor_js.html" %}

  function show_lowcov() {
    var lowcovDiv = document.getElementById("lowcovlist_div");
    lowcovDiv.style.display = lowcovDiv.style.display == "none" ? "block" : "none";
  }

  function show_germlinecnv() {
    var germlineDiv = document.getElementById("germline_div");
    germlineDiv.style.display = germlineDiv.style.display == "none" ? "block" : "none";
  }

  function switchVisibility(class_name) {
    var elems = document.getElementsByClassName(class_name);
    for (var i = 0; i < elems.length; i++) {
      elems[i].classList.toggle('hidden');
    }
  }

  // Filter sidebar toggle (guarded; elements may be absent on RNA page variants)
  const filterToggle = document.getElementById('filter-toggle');
  const filterClose = document.getElementById('filter-close');
  const filterSidebar = document.getElementById('filter-sidebar');

  if (filterToggle && filterSidebar) {
    filterToggle.addEventListener('click', function() {
      filterSidebar.classList.toggle('translate-x-full');
    });
  }

  if (filterClose && filterSidebar) {
    filterClose.addEventListener('click', function() {
      filterSidebar.classList.add('translate-x-full');
    });
  }

</script>

<style>
  .multiselect {
    width: 100%;
  }

  .selectBox {
    position: relative;
  }

  .selectBox select {
    width: 100%;
  }

  .overSelect {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
  }

  .checkboxes {
    display: none;
    border-bottom: 1px #bbb solid;
    border-left: 1px #bbb solid;
    border-right: 1px #bbb solid;
    border-radius: 0 0 3px 3px;
    background-color: #fff;
  }

  .checkboxes label {
    display: block;
  }

  .checkboxes label:hover {
    background-color: #f7f7ff;
  }

  {% include "components/summary_markdown_editor_styles.html" %}
</style>



{% endblock %}
