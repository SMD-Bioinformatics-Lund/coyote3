{% extends "layout.html" %} 

{% block body %} 
{% set translation=config["TRANS"] %} 

<div class="flex w-full h-full overflow-hidden">

  <!-- LEFT SIDEBAR (Fixed Width, Full Height) -->
  <aside class="w-8 bg-transparent text-white flex flex-col">

    {% if fusions %}
      <div class="flex border-l-8 border-yellow-400 ">
        <a href="#fusions" 
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">Fusions</span>
        </a>
      </div>
    {% endif %}

    {% if sample.classification %}
      <div class="flex border-l-8 border-yellow-400">
        <a href="#classification" 
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">Class</span>
       </a>
      </div>
    {% endif %}

    {% if sample.expr %}
      <div class="flex border-l-8 border-yellow-400">
        <a href="#expression" 
          class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">expression</span>
        </a>
      </div>
    {% endif %}
  
    <div class="flex border-l-8 border-teal-400 mt-1">
      <a href="#summary" 
        class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
          <span class="vertical-text">Summary</span>
      </a>
    </div>

    {% if sample.cov %}
      <div class="flex border-l-8 border-orange-400 mt-1">
        <a href="{{ url_for('cov_bp.get_cov', sample_id=sample.name) }}" 
          class="relative bg-gray-500 text-white text-xs text-center py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
            <span class="vertical-text">Coverage</span>
        </a>
      </div>
    {% endif %}

    <div class="flex border-l-8 border-orange-400 ">
      <a href="#lowcov" 
        class="relative bg-gray-500 text-white text-xs text-center mt-1 py-1 px-0.5 transition-all duration-300 ease-in-out transform hover:translate-x-1">
          <span class="vertical-text">Low Cov</span>
      </a>
    </div>
  </aside>

  <!-- MAIN CONTENT (Scrollable & Auto-Resizing) -->
  <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col">

    <!-- Sample Info Card (Auto-Wrapping, Full Flexbox) -->
    {% include "sample_meta_info.html" %}
    
    <!-- Selected Gene Panel Card -->
    {% include "selected_gene_panel_div.html" %}

    <!-- Fusion Table -->
    {% if fusions|length %}
      <section id="fusions" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
      
        <!-- Fusions Header -->
        <div class="overflow-x-auto relative">
          <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Fusions passing filter criteria</h2>
        </div>

        <!-- Fusions Content -->
        <div class="overflow-auto">
          <table class="min-w-full mt-4 table-auto text-xs sortable">
            <thead>
              <tr class="bg-gradient-to-r from-green-300 to-blue-300 text-black">
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Gene 1</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Gene 2</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Effect</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Spanning pairs</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Unique spanning reads</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Fusion points</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Tier</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Description</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">Callers</th>
                <th class="py-2 px-3 border-b-2 text-center uppercase font-semibold">View</th>
              </tr>
            </thead>
            <tbody>
              {% for fus in fusions %}
                {% set genes = fus.genes.split('^') %}
                {% set sel_fus = (fus.calls|selectattr('selected', 'equalto', 1) |list)[0] %}
                {% if fus.blacklisted or fus.fp %}
                <tr class='bg-red-200 opacity-40 even:bg-red-200 odd:bg-red-200 hover:bg-red-300 border-b border-gray-300'>
                  {% else %}
                <tr>
                  {% endif %}
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ genes[0] }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ genes[1] }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ sel_fus.effect }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ sel_fus.spanpairs }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ sel_fus.spanreads }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ sel_fus.breakpoint1 }}<br>{{ sel_fus.breakpoint2 }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300 varlist" sorttable_customkey="{{ fus.classification.class }}">
                    {% if fus.classification.class != 999 %}
                      <div class="px-1 py-0 w-[11px] text-center border border-gray-600 rounded-[11px]" id="tier{{ fus.classification.class }}">
                        {{ fus.classification.class }}
                      </div>
                    {% endif %}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ sel_fus.desc|format_fusion_desc|safe }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    {{ fus.calls|uniq_callers|join("<br>")|safe }}
                  </td>
                  <td class="py-2 px-3 border-b border-gray-300">
                    <a href='/rna/fusion/{{ fus._id }}' class="text-blue-500 hover:underline">view</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </section>
    {% endif %}

    <!-- Classification Table -->
    {% if sample.classification %}
     <section id="classification" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">

      <!-- Class Header-->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Expression-based classification ({{sample.classification.classifier_version}})</h2>
      </div>

      <!-- Class Content-->
      <div class="overflow-auto">
        <table class="min-w-full mt-4 table-auto text-xs sortable">
          <thead>
            <tr class="bg-gradient-to-r from-green-300 to-blue-300 text-black">
              <th class="py-2 px-3 border-b-2 text-left uppercase font-semibold">Class</th>
              <th class="py-2 px-3 border-b-2 text-left uppercase font-semibold">Score</th>
            </tr>
          </thead>
          <tbody>
            {% for c in sample.classification.classifier_results %}
            <tr >
              <td class="py-2 px-3 border-b border-gray-300">{{ c.class }}</td>
              <td class="py-2 px-3 border-b border-gray-300">
                <div style="text-align: center;
                            position: relative;
                            z-index: 1;
                            width: 200px;
                            height: 100%;
                            margin: 0px 0px;
                            border: 1px solid rgb(50, 50, 50);">
                            <div style="position:absolute;z-index:-1;width:{{ (c.score * 100)|string }}%;height:100%;background-color:#acf;"></div>
                          {{ '%0.2f'| format(c.score) }}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endif %}

    <!-- Expression Table -->
    {% if sample.expr %}
     <section id="expression" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">

      <!-- Class Header-->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Expression of selected genes</h2>
      </div>

      <!-- Class Content-->
      <div class="overflow-auto">
        <table class="min-w-full mt-4 table-auto text-xs sortable">
          <thead>
            <tr class="bg-gradient-to-r from-green-300 to-blue-300 text-black">
              <th class="py-2 px-3 border-b-2 text-left uppercase font-semibold">Gene</th>
              <th class="py-2 px-3 border-b-2 text-left uppercase font-semibold">TPM</th>
              <th class="py-2 px-3 border-b-2 text-left uppercase font-semibold">TPM mean</th>
              <th class="py-2 px-3 border-b-2 text-left uppercase font-semibold">Z-Score</th>
            </tr>
          </thead>
          <tbody>
            {% for data in sample.expr.sample %}
              {% if data.hgnc_symbol %}
              <tr>
                {% set zscore = data.z %}
                <td class="py-2 px-3 border-b border-gray-300">{{ data.hgnc_symbol }}</td>
                <td class="py-2 px-3 border-b border-gray-300">{{ '%0.2f'| format(data.sample_expression) }}</td>
                <td class="py-2 px-3 border-b border-gray-300">{{ '%0.2f'| format(data.reference_mean)}}</td>
                <td> 
                  {% if zscore >= 0 %}
                  <div
                  style="
                    text-align: left;
                    padding-left: 2px;
                    position: relative;
                    z-index: 1;
                    width: 200px;
                    height: 100%;
                    margin: 0px 0px;
                    border: 1px solid rgb(50, 50, 50);
                  "
                >
                  <div
                    style="
                      position: absolute;
                      left: 100px;
                      z-index: 0;
                      width: 1px;
                      height: 100%;
                      background-color: #555;
                    "
                  ></div>
                  <div
                    style="position:absolute;left:101px;z-index:-1;width:{{ 2+ zscore * 6 }}px;height:100%;background-color:#8E8;"
                  ></div>
                  {{ '%0.2f'| format(zscore) }}
                </div>
                  {% else %}
                  <div
                  style="
                    text-align: left;
                    padding-left: 2px;
                    position: relative;
                    z-index: 1;
                    width: 200px;
                    height: 100%;
                    margin: 0px 0px;
                    border: 1px solid rgb(50, 50, 50);
                  "
                >
                  <div
                    style="
                      position: absolute;
                      left: 100px;
                      z-index: 0;
                      width: 1px;
                      height: 100%;
                      background-color: #555;
                    "
                  ></div>
                  <div
                    style="position:absolute;left:{{ 100+zscore*6 }}px;z-index:-1;width:{{ -zscore * 6 +1 }}px;height:100%;background-color:#faa;"
                  ></div>
                  {{ '%0.2f'| format(zscore) }}
                </div>
                  {% endif %}
                </td>
              </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>

    </section>
    {% endif %}    
    


    <!-- Summary Comments Card -->
    <section id="summary" class="bg-blue-50 shadow-lg rounded-xl px-2 py-1 my-2 relative">
      <!-- Summary Header -->
      <div class="overflow-x-auto relative">
        <h2 class="text-base font-semibold text-black tracking-wide mt-1 uppercase px-2">Summary</h2>
      </div>

      <div class="mx-auto py-2 " id="summary-content">
        <div class="flex flex-wrap gap-4 ">
          <!-- Summary comments Table -->
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-blue-200 to-green-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Summary Comments</h2>
            </div>
            <div class="overflow-auto relative">
              <table class="w-full shadow-md rounded-b-lg text-xs text-gray-800" id="summary-table">
                <thead class="sortable capitalize tracking-wide rounded-t-lg bg-green-100">
                  <tr id="summary-table-header" class="border-b text-left border-gray-800">
                    <th class="px-2 py-3 font-semibold" id="comments-table-header-who">Who</th>
                    <th class="px-2 py-3 font-semibold" id="comments-table-header-comment">Comment</th>
                    <th class="px-2 py-3 font-semibold" id="comments-table-header-view">Hide/Unhide</th>
                  </tr>
                </thead>
                <tbody>
                  {% if sample.comments|length > 0 %}
                    {% for comment in sample.comments|sort(attribute='time_created', reverse=True) %}
                      {% if comment.hidden != 1 %}
                        <tr class="hover:bg-green-50 border-t border-gray-400 text-left" id="comment-table-row">
                      {% else %}
                        <tr class="bg-red-200 opacity-60 hover:bg-red-300 border-t border-gray-400 text-left hidden hidden_comment" id="comment-table-row-hidden">
                      {% endif %}
                        <td class="px-2 whitespace-nowrap align-top py-4" id="comments-table-header-who">
                          <b>{{ comment.author }}</b><br><small>{{ comment.time_created|human_date }}</small>
                        </td>
                        <td class="p-2" id="comments-table-header-comment" onclick='addText(event)'>
                          {{ comment.text|format_comment|safe }}
                        </td>
                        <td class="px-2 align-top py-4" id="comments-table-header-view">
                          {% set hidden_exists = 0 %}
                          {% if comment.hidden != 1 %}
                            <form action="{{ url_for('common_bp.hide_sample_comment', sample_id=sample._id) }}#summary" method="post">
                              <input type="hidden" name="comment_id" value="{{ comment._id }}">
                              <input id="hide_comment" type="image" class="w-5 hover:scale-105" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye-slash.svg') }}">
                            </form>
                          {% else %}
                            {% set hidden_exists = 1 %}
                            <form action="{{ url_for('common_bp.unhide_sample_comment', sample_id=sample._id) }}#summary" method="post">
                              <input type="hidden" name="comment_id" value="{{ comment._id }}">
                              <input id="unhide_comment" type="image" class="w-5" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye.svg') }}">
                            </form>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                    {% if hidden_comments %}
                      <tr>
                        <td colspan=4 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                          <a href="javascript:void(0)" onclick="switchVisibility('hidden_comment')"><b>Show/hide deleted comments</b></a>
                        </td>
                      </tr>
                    {% endif %}
                  {% else %}
                    <tr>
                      <td colspan=4 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                        No comments available.
                      </td>
                    </tr>
                  {% endif %}
                <tbody>
              </table>
            </div>
          </div>

          <!-- Add Comment Form -->
          <div class="w-full bg-transparent shadow-md rounded-lg overflow-hidden">
            <div class="sticky top-0 flex items-center justify-between bg-gradient-to-b from-blue-200 to-green-100 shadow-lg rounded-t-lg border-b border-gray-400 p-2 z-10">
              <h2 class="text-sm font-semibold text-black">Write New Summary</h2>
            </div>
            <div class="overflow-auto relative" id="comments-box-div">
              <form action="{{ url_for('common_bp.add_sample_comment', id=sample._id) }}" method="post">
                <textarea id="comment_textarea"
                          name="sample_comment"
                          placeholder="Type to write a new summary for {{ sample.name }} sample..."
                          class="w-5/6 p-4 border border-gray-400 rounded mx-5 my-4 h-40"></textarea>
          
                <!-- Buttons Row -->
                <div class="flex flex-wrap items-center gap-4 mx-5 mb-5">
                  <input type="submit"
                        value="Save"
                        class="p-2 text-black bg-blue-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-blue-500 hover:text-white hover:shadow-lg cursor-pointer">
          
                  <button type="button"
                          onclick="addAIText()"
                          class="p-2 text-black bg-gray-300 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-gray-500 hover:text-white hover:shadow-lg cursor-pointer">
                    Suggest
                  </button>
          
                  <button type="button"
                          onclick="window.location.href='preview_report/{{ sample.name }}'"
                          class="p-2 text-black bg-green-400 rounded-md shadow-md transition-all duration-200 ease-in-out hover:bg-green-500 hover:text-white hover:shadow-lg cursor-pointer">
                    Preview Report
                  </button>
                </div>
              </form>
          
              <!-- AI suggestion box -->
              <div id="suggestion" class="hidden">
                {{ ai_text }}
              </div>
            </div>
          </div>
          


        </div>
      </div>
    </section>

  </main>

  <!-- Right Filter Sidebar -->
  {% include "fusion_sidebars.html" %}
</div>


<script>
  function addAIText() {
    var suggestion = document.getElementById("suggestion").innerHTML.trim();
    document.getElementById("comment_textarea").value = suggestion;
  }

  function addText(event) {
    var targ = event.target || event.srcElement;
    if (!targ.closest('tr').classList.contains('hidden_comment')) {
      document.getElementById("comment_textarea").value = targ.textContent || targ.innerText;
    }
  }

  function addText(event) {
    var targ = event.target || event.srcElement;
    if (!targ.closest('tr').classList.contains('hidden_comment')) {
      const textarea = document.getElementById('comment_textarea');
      const text = event.target.innerText.trim();
      textarea.value = text;
    }
  }
  
  window.onload = function () {
    document.querySelectorAll('[data-autoclick="true"]').forEach(element => element.click());
    document.querySelectorAll('[data-autoclick-once="true"]').forEach(element => element.click());
  };
  
  var expanded = false;
  function toggleFilters() {
    var filterCard = document.getElementById("filter_card");
    filterCard.style.display = expanded ? "none" : "block";
    expanded = !expanded;
  }
  
  function show_lowcov() {
    var lowcovDiv = document.getElementById("lowcovlist_div");
    lowcovDiv.style.display = lowcovDiv.style.display == "none" ? "block" : "none";
  }
  
  function show_germlinecnv() {
    var germlineDiv = document.getElementById("germline_div");
    germlineDiv.style.display = germlineDiv.style.display == "none" ? "block" : "none";
  }
  
  function switchVisibility(class_name) {
    var elems = document.getElementsByClassName(class_name);
    for (var i = 0; i < elems.length; i++) {
      elems[i].classList.toggle('hidden');
    }
  }
  
  // Filter sidebar toggle
  document.getElementById('filter-toggle').addEventListener('click', function() {
    document.getElementById('filter-sidebar').classList.toggle('translate-x-full');
  });
  
  document.getElementById('filter-close').addEventListener('click', function() {
    document.getElementById('filter-sidebar').classList.add('translate-x-full');
  });
  
  function showCheckboxes(id) {
    var checkboxes = document.getElementById(id);
    checkboxes.style.display = checkboxes.style.display === 'block' ? 'none' : 'block';
  }
  

</script>

<style>
  .multiselect {
    width: 100%;
  }

  .selectBox {
    position: relative;
  }

  .selectBox select {
    width: 100%;
  }

  .overSelect {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
  }

  .checkboxes {
    display: none;
    border-bottom: 1px #bbb solid;
    border-left: 1px #bbb solid;
    border-right: 1px #bbb solid;
    border-radius: 0px 0px 3px 3px;
    background-color: #fff;
  }

  .checkboxes label {
    display: block;
  }

  .checkboxes label:hover {
    background-color: #f7f7ff;
  }
</style>

{% endblock %}
