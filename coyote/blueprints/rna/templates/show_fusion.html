{% extends "layout.html" %}

{% block body %}

{# check permissions for the tier #}
{% set rna_tier_disabled = not has_access('assign_tier', min_role='manager', min_level=99) %}
{% set rna_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if rna_tier_disabled else "" %}
{% set rna_tier_disabled_attr = "disabled" if rna_tier_disabled else "" %}

{# check permissions for remove variant tier #}
{% set can_remove_tier = has_access('remove_tier', min_role='manager', min_level=99) %}
{% set can_remove_global_tier = has_access('remove_tier_global', min_role='admin') %}
{% set remove_tier_disabled = not can_remove_tier %}
{% set remove_global_tier_disabled = not can_remove_global_tier %}
{% set remove_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if remove_tier_disabled else "" %}
{% set remove_global_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if remove_global_tier_disabled else "" %}
{% set remove_tier_attr = "disabled" if remove_tier_disabled else "" %}
{% set remove_global_tier_attr = "disabled" if remove_global_tier_disabled else "" %}


{# check permissions for dna variant actions buttons #}
{% set fusion_actions_disabled = not has_access('manage_snvs', min_role='user', min_level=9) %}
{% set fusion_actions_class = "opacity-70 select-none cursor-not-allowed pointer-events-none" if fusion_actions_disabled else "" %}
{% set fusion_actions_attr = "disabled" if fusion_actions_disabled else "" %}



{% set sel_fus = (fusion.calls|selectattr('selected', 'equalto', 1) |list)[0] %}


<div class="flex w-full h-full overflow-hidden bg-blue-50">
  <!-- Fusion Wall left side bar -->
  <aside class="w-80 bg-transparent text-black flex flex-col overflow-y-auto shadow-lg rounded-lg mr-2 ml-1 left-0 h-full border-r-2 border-t-2 border-brown-400">
    <!-- Fusion Wall -->
    <div class="flex justify-center items-center bg-gradient-to-b from-brown-300 to-brown-200 py-2 rounded-t-md shadow-lg">
      <img src="{{ url_for('static', filename='icons/heroicons_outline_24/bookmark.svg') }}" alt="Tag Icon" class="w-4 h-4 mr-2 opacity-80">
      <h2 class="text-sm font-semibold capitalize tracking-wide text-black">Fusion Wall</h2>
    </div>

    <!-- Table Container -->
    <div class="overflow-auto shadow-lg bg-transparent p-0">
      <table class="table-auto bg-blue-50 w-full text-xs text-black border-collapse">
        <tbody class="break-all">
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Gene 1 (5'):</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="http://www.cbioportal.org/ln?q={{ fusion.gene1 }}" class="text-blue-600 underline">{{ fusion.gene1 }}</a>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Gene 2 (3'):</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="http://www.cbioportal.org/ln?q={{ fusion.gene2 }}" class="text-blue-600 underline">{{ fusion.gene2 }}</a>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Breakpoint:</th>
            <td class="p-1 text-right font-medium">{{sel_fus.breakpoint1}}<br>{{sel_fus.breakpoint2}}
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Chromosome:</th>
            <td class="p-1 text-right font-medium">
              {% if sel_fus.breakpoint1 and sel_fus.breakpoint2 %}
                {{ sel_fus.breakpoint1.split(':')[0] }}<br>{{ sel_fus.breakpoint2.split(':')[0] }}
              {% else %}
                -
              {% endif %}
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Mitelman:</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="https://mitelmandatabase.isb-cgc.org/mb_search" class="text-blue-600 underline">link</a>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Atlas of GCOH:</th>
            <td class="p-1 text-right font-medium"><a href="https://pubmed.ncbi.nlm.nih.gov/?term={{fusion.gene1}}%09{{fusion.gene2}}&btnG=Google+Search&domains=atlasgeneticsoncology.org&sitesearch=atlasgeneticsoncology.org&btnI" target="_blank" class="text-blue-500 hover:underline text-s">link</a></td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Pubmed:</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="https://pubmed.ncbi.nlm.nih.gov/?term={{fusion.gene1}}%3A%3A{{fusion.gene2}}" class="text-blue-600 underline">{{fusion.gene1}}::{{fusion.gene2}}</a></td>
          </tr>
        </tbody>
      </table>
	  </div>
  </aside>


  <main class="flex-1 bg-transparent overflow-y-auto py-2 px-1 flex flex-col">

    <!-- sample info -->
    {% include "sample_meta_rna_info.html" %}

    <section class="bg-gray-100 p-2 my-2 flex flex-wrap justify-between w-full shadow-lg rounded-xl relative gap-2 z-0 border-l-8 border-r-8 border-purple-400 whitespace-normal break-all" id="variant-info">

      <!-- Fusion Info Left Section -->
      <div class="flex flex-col ml-2 mr-4">
        <h2 class="text-base font-bold">{{ fusion.gene1 }}-{{ fusion.gene2}}</h2>
        <p class="text-sm font-normal py-1 my-1">
          Called by: {{ fusion.fusion_callers|join(', ') }}
        </p>
      </div>

      <!-- Right Section Tier info --> <!-- Change this with tooltip -->
      <div class="flex flex-col text-right ml-2 mr-4 overflow-x-auto">
        <h2 class="text-base font-bold pb-1">
          Classify Fusion
        </h2>
        <div class="flex flex-wrap items-center justify-end">
          <!-- Tier Buttons -->
          <form action="{{ url_for('dna_bp.classify_fusion', sample_id=sample.name, fus_id=fusion._id) }}" method="post">
            <input type="hidden" name="assay_group" value="{{ assay_group }}">
            <input type="hidden" name="subpanel" value="{{ subpanel }}">
            <input type="hidden" name="gene1" value="{{ fusion.gene1 }}">
						<input type="hidden" name="gene2" value="{{ fusion.gene2 }}">
						<input type="hidden" name="fusionpoints" value="{{sel_fus.breakpoint1}}^{{sel_fus.breakpoint2}}">

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 1 %}
                  bg-gray-300 transition-all duration-300 ease-in-out transform hover:translate-y-1 hover:bg-orange-500
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class }}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier1"
              type="submit"
              value="Tier I"
              name="tier1"
              title="Tier I: Strong Clinical Significance"
              {{ rna_tier_disabled_attr }}
              />

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 2 %}
                  bg-gray-300 hover:bg-yellow-400 transition-all duration-300 ease-in-out transform hover:translate-y-1
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class}}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier2"
              type="submit"
              name="tier2"
              value="Tier II"
              title="Tier II: Potential Clinical Significance"
              {{ rna_tier_disabled_attr }}
            />

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 3 %}
                  bg-gray-300 hover:bg-blue-500 transition-all duration-300 ease-in-out transform hover:translate-y-1
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class}}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier3"
              type="submit"
              name="tier3"
              value="Tier III"
              title="Tier III: Unknown Clinical Significance"
              {{ rna_tier_disabled_attr }}
            />

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg  cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 4 %}
                  bg-gray-300 hover:bg-green-600 transition-all duration-300 ease-in-out transform hover:translate-y-1
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class}}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier4"
              type="submit"
              name="tier4"
              value="Tier IV"
              title="Tier IV: Benign"
              {{ rna_tier_disabled_attr }}
            />
          </form>

          <!-- Remove Tier Info -->
          {% if latest_classification.class != 999 %}
          <form id="form" action="{{ url_for('dna_bp.remove_classified_variant', sample_id=sample.name ,fus_id=fusion._id) }}" method="post" class="inline-flex items-center space-x-2" >
            <input type="hidden" name="gene1" value="{{ fusion.gene1 }}">
            <input type="hidden" name="gene2" value="{{ fusion.gene2 }}">
            <input type="hidden" name="fusionpoints" value="{{sel_fus.breakpoint1}}^{{sel_fus.breakpoint2}}">
            <input type="hidden" name="assay_group" value="{{ assay_group }}">
            <input type="hidden" name="subpanel" value="{{ subpanel }}">
            {% if latest_classification and 'assay' in latest_classification %}
              <input
                class="m-1 bg-gray-300 text-black text-sm px-2 py-1 rounded-md shadow-lg cursor-pointer hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:translate-y-1 whitespace-normal break-all {{ remove_tier_classes }}"
                title="Remove {{ assay_group }} classifications"
                id="remove"
                type="submit"
                value="❌ Tier"
                onclick="return confirm('This will remove all tiering for {{ assay_group }}, proceed?')"
                {{ remove_tier_attr }}
              >
              {% elif current_user.is_admin %}
                <input
                  class="m-1 bg-gray-300 text-black text-sm px-2 py-1 rounded-md shadow-lg cursor-pointer hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:translate-y-1 whitespace-normal break-all {{ remove_global_tier_classes }}"
                  title="Remove historic non-assay classifications"
                  id="remove"
                  type="submit"
                  value="❌ Tier"
                  onclick="return confirm('This will remove all historic tiering without any assays assigned, proceed?')"
                  {{ remove_global_tier_attr }}
                >
              {% endif %}
          </form>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Top buttons for links and actions -->
    <section class="relative gap-2 z-0 mt-2 ml-1 bg-gray-100 py-1 shadow-lg rounded-xl border-l-8 border-r-8 border-blue-400" id="variant-actions-buttons">
      <div class="flex flex-wrap items-start justify-end ml-auto mr-4 gap-2">
        <div class="relative">
          <div class="absolute top-0 left-0 w-full h-1 bg-yellow-400 break-all"></div>
          {% if fusion.fp == true %}
            <form action="{{ url_for('rna_bp.unmark_false_fusion', sample_id=sample.name, fus_id=fusion._id) }}" method="post">
              <input class="relative bg-yellow-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-gray-200 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{ fusion_actions_class }}" type="submit" name="mark_fp" value="Unmark False Positive" {{ fusion_actions_attr }}>
            </form>
          {% else %}
            <form action="{{ url_for('rna_bp.mark_false_fusion', sample_id=sample.name, fus_id=fusion._id) }}" method="post">
              <input class="relative bg-gray-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-yellow-100 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{ fusion_actions_class }}" type="submit" name="mark_fp" value="Mark as False Positive" {{ fusion_actions_attr }}>
            </form>
          {% endif %}
        </div>
      </div>
    </section>


    <!-- fusion information cards -->
    <section class="bg-transparent p-2 my-2 flex flex-col items-start relative gap-4 w-full" id="fusion-information-cards">
      <!-- Fusion table -->
      <div class="flex flex-col gap-y-4 w-full max-w-none">
        <div class="bg-gray-50 w-full shadow-md rounded-lg mb-1 pagination" id="fusion-alternate-transcripts-info" data-rows-per-page="15" pagination-button-color="purple" pagination-button-text-color="black">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-purple-400 to-purple-200 p-2 shadow-md rounded-t-lg break-all">Fusion calls from different fusion callers</h2>
          <div class="rounded-b-lg overflow-x-auto">
            <table class="w-full text-xs text-gray-800">
              <thead class="capitalize tracking-wide rounded-t-lg bg-gray-100">
                <tr class="border-b text-left border-gray-800">
                  <th class="px-1 py-2 font-semibold">Gene 1</th>
                  <th class="px-1 py-2 font-semibold">Gene 2</th>
                  <th class="px-1 py-2 font-semibold">Breakpoints</th>
                  <th class="px-1 py-2 font-semibold">Effect</th>
                  <th class="px-1 py-2 font-semibold">Spanning Pairs</th>
                  <th class="px-1 py-2 font-semibold">Spanning Reads</th>
                  <th class="px-1 py-2 font-semibold">Longest Anchor</th>
                  <th class="px-1 py-2 font-semibold">Caller</th>
                  <th class="px-1 py-2 font-semibold">Description</th>
                  <th class="px-1 py-2 font-semibold">Status</th>
                </tr>
              </thead>
              <tbody x-data="{ expandedRow: null }">
                  {% for call in fusion.calls %}
                  <tr class="{% if call.selected == 1 %}bg-gray-50 hover:bg-gray-100 font-semibold{% else %}hover:bg-gray-50{% endif %} border-t border-gray-300">
                    <td class="px-2 py-2">{{ fusion.gene1 }}</td>
                    <td class="px-2 py-2">{{ fusion.gene2 }}</td>
                    <td class="px-2 py-2 whitespace-nowrap">{{ call.breakpoint1 }}<br>{{ call.breakpoint2 }}</td>
                    <td class="px-2 py-2">{{ call.effect }}</td>
                    <td class="px-2 py-2">{{ call.spanpairs }}</td>
                    <td class="px-2 py-2">{{ call.spanreads }}</td>
                    <td class="px-2 py-2">{{ call.longestanchor }}</td>
                    <td class="px-2 py-2">{{ call.caller }}</td>
                    <td class="px-2 py-2 w-60 align-top">
                    {% if call.desc %}
                      <div class="space-y-1">
                        <div x-show="expandedRow !== {{ loop.index }}" x-cloak>
                          {{ call.desc | format_fusion_desc_few(1) | safe }}
                          <button
                            @click="expandedRow = {{ loop.index }}"
                            class="text-blue-500 text-xs underline ml-1 focus:outline-none">Show more</button>
                        </div>
                        <div x-show="expandedRow === {{ loop.index }}" x-cloak>
                          {{ call.desc | format_fusion_desc | safe }}
                          <button
                            @click="expandedRow = null"
                            class="text-blue-500 text-xs underline ml-1 focus:outline-none">Show less</button>
                        </div>
                      </div>
                    {% else %}
                      <span class="italic text-gray-400">No description</span>
                    {% endif %}
                    </td>

                    <td class="px-2 py-2 text-center">
                      {% if call.selected == 1 %}
                        <span class="text-green-700 font-bold">Selected</span>
                      {% else %}
                        <a href="{{ url_for('rna_bp.pick_fusioncall', sample_id=sample.name, fus_id=fusion._id, callidx=loop.index, num_calls=fusion.calls|length) }}"
                          class="text-blue-500 hover:underline text-sm">Pick</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- other information cards -->
    <section class="bg-transparent p-2 my-2 flex flex-wrap items-start relative gap-4" id="fusion-detail-cards">
      <!-- Comment box, other tiering and pon -->
      <div class="flex flex-col gap-y-4 min-w-[450px] max-w-xl">
        <!-- Comment box -->
        {% if has_access("add_variant_comment", min_role="user", min_level=9) %}
          <div class="bg-transparent min-w-[400px] w-full max-w-xl" id="commenting-box-card">
            <h2 class="text-sm font-semibold bg-gradient-to-b from-indigo-400 to-indigo-200 p-2 shadow-md rounded-t-lg break-all">Add new comment/annotation</h2>
            <div id="commenting_box" class="rounded-b-lg border border-gray-400 shadow-md p-2 overflow-x-auto">
              <form action="{{ url_for('dna_bp.add_fusion_comment', sample_id=sample.name, fus_id=fusion._id) }}" method="post">
                <textarea id="comment_textarea" name="text" placeholder="Enter fusion comment/annotation..." class="h-40 w-full p-2 border border-gray-300 rounded-lg focus:bg-yellow-50 mb-4"></textarea><br>
                <input type="hidden" name="gene1" value="{{ fusion.gene1 }}">
                <input type="hidden" name="gene2" value="{{ fusion.gene2 }}">
                <input type="hidden" name="fusionpoints" value="{{sel_fus.breakpoint1}}^{{sel_fus.breakpoint2}}">
                <input type="submit" value="Save" class="bg-blue-500 text-white py-1 px-2 mx-1 mb-1 rounded-lg cursor-pointer shadow-md">&nbsp;&nbsp;
                {% if has_access("add_global_variant_comment", min_role="admin") %}
                  <label class="items-center">
                    <input type="checkbox" name="global" value="global" class="form-checkbox text-blue-500">
                    <span class="ml-2">Use as global annotation</span>
                  </label>
                {% endif %}
                <input type="hidden" name="assay_group" value="{{ assay_group }}">
                <input type="hidden" name="subpanel" value="{{ sample.get('subpanel', '') }}">
              </form>
            </div>
          </div>
        {% endif %}

        <!-- Other Tiering Information -->
        <div class="bg-gray-50 max-w-xl w-full shadow-md rounded-lg mb-1 pagination" data-rows-per-page="2" pagination-button-color="orange" pagination-button-text-color="black" id="other-tiering-info">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-orange-400 to-orange-200 p-2 shadow-md rounded-t-lg break-all">Other Tiering</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if other_classifications %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-orange-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold ">Assay</th>
                    <th class="p-3 font-semibold ">Diagnosis</th>
                    <th class="p-3 font-semibold ">Tier</th>
                  </tr>
                </thead>
                <tbody id="other-tiering-info-body" class="{% if other_classifications|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for var in other_classifications %}
                    <tr class="hover:bg-orange-50 border-t border-gray-400 text-left align-top">
                      <td class="p-2 font-medium">{{var.assay}}</td>
                      <td class="p-2">
                        {% if "subpanel" in var %}
                          {{ var.subpanel }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="p-2">{{var.class}}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-orange-50 break-all">Other tiering information is not available</em>
            {% endif %}
          </div>
        </div>

        <!-- Fusion in Other Sample Data -->
        <div class="bg-gray-50 max-w-xl w-full shadow-md rounded-lg mb-1" id="variant-in-other-sample-data">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-blue-400 to-blue-200 p-2 shadow-md rounded-t-lg break-all">Fusion in Other Samples</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if in_other %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-blue-200">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold">Sample</th>
                    <th class="p-3 font-semibold">Assay Group</th>
                    <th class="p-3 font-semibold">Spanning Reads</th>
                    <th class="p-3 font-semibold">Spanning Pairs</th>
                    <th class="p-3 font-semibold">Marked</th>
                  </tr>
                </thead>
                <tbody id="variant-in-other-sample-data-body" class="{% if in_other|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for doc in in_other %}
                    {% set clean_sample = doc.sample_name.split('p')[0] %}
                    {% set sample_gt = doc.GT | selectattr("sample", "equalto", clean_sample) | first %}
                    <tr class="hover:bg-blue-50 border-t border-gray-400 text-left align-top">
                      <td class="p-2">
                          <a href="{{ url_for('rna_bp.list_fusions', sample_id=doc.sample_name) }}" class="text-blue-500 hover:underline">
                            {{ doc.sample_name }}
                          </a>
                      </td>
                      <td class="p-2">
                        <div class="inline-block mb-1 cursor-pointer p-1 rounded-full bg-gray-300">
                          <span>{{ assay_group_mappings.get(doc.assay, doc.assay) }}</span>
                        </div>
                      </td>
                      <td class="p-2">
                        {% if doc.spanning_reads is not none %}
                          {{ doc.spanning_reads }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="p-2">
                        {% if doc.spanning_pairs is not none %}
                          {{ doc.spanning_pairs }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="p-2 text-center align-middle">
                        <div class="flex items-center gap-2 justify-center h-full">
                          {% if doc.fp == true %}
                          <span class="relative inline-block cursor-pointer font-bold" onmouseover="showTooltip(event, `<span class='text-red-400 '>Variant marked as false positive</span>`)">
                            <img class="w-4 h-4" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-circle.svg') }}">
                          </span>
                          {% endif %}
                          {% if doc.interesting == True %}
                            <span class="relative inline-block cursor-pointer"
                              onmouseover="showTooltip(event, `<span class='text-green-400'>Variant marked as interesting</span>`)">
                              <img class="w-3 h-3" src="{{ url_for('static', filename='icons/heroicons_outline_24/exclamation-circle.svg') }}">
                          </span>
                          {% endif %}
                          {% if doc.irrelevant == True %}
                            <span class="relative inline-block cursor-pointer font-bold"
                              onmouseover="showTooltip(event, `<span class='text-yellow-400'>Variant marked as irrelevant</span>`)">
                              <img class="w-4 h-4" src="{{ url_for('static', filename='icons/heroicons_outline_24/x-mark.svg') }}">
                            </span>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-blue-50 break-all">Fusion is not found in other samples.</em>
            {% endif %}
          </div>
        </div>


      </div>

      <div class="flex flex-col gap-y-4 max-w-xl items-start">
        <!-- Fusion annotations (All) -->
        {% if has_access(min_role='user', min_level=9) %}
          <div class="bg-gray-50 w-full max-w-xl pagination shadow-md rounded-lg mb-1" data-rows-per-page="2" pagination-button-color="green" pagination-button-text-color="black" id="variant-annotations-all">
            <h2 class="text-sm font-semibold bg-gradient-to-b from-green-400 to-green-200 p-2 shadow-lg rounded-t-lg break-all">Fusion Annotations (All)</h2>
            <div class="rounded-b-lg overflow-x-auto">
              {% if annotations|length > 0 %}
                <table class="w-full max-w-xl table-auto text-xs text-gray-800 mb-1">
                  <thead class="capitalize tracking-wide rounded-t-lg bg-green-100">
                    <tr class="border-b text-left border-gray-800">
                      <th class="p-3 font-semibold w-1/6">Who</th>
                      <th class="p-3 font-semibold w-4/6">Annotation</th>
                      <th class="p-3 font-semibold w-1/6">Assay</th>
                    </tr>
                  </thead>
                  <tbody id="variant-annotations-all-body" class="{% if annotations|length > 1 %}border-b border-gray-400 {% endif %}">
                    {% for anno in annotations|sort(attribute='time_created', reverse=True) %}
                      {% if loop.first == True %}
                        <tr class="hover:bg-green-100 border-t border-gray-400 text-left align-top">
                          <td class="p-2 font-medium">{{ anno.author }}<br><small>{{ anno.time_created|human_date }}</small></td>
                          <td class="p-2" onclick="addText(event)">{{ anno.text|format_comment|safe }}</td>
                          <td class="p-2">
                            {% if "assay" in anno %}
                              {{ anno.assay }}<br><small>{{ anno.subpanel }}</small>
                            {% else %}
                              historic
                            {% endif %}
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md break-all">No fusion annotations (all) available.</em>
              {% endif %}
            </div>
          </div>
        {% endif %}

        <!-- Fusion annotations (Assay) -->
        <div class="bg-gray-50 w-full max-w-xl pagination shadow-md rounded-lg mb-1" data-rows-per-page="2" pagination-button-color="blue" pagination-button-text-color="black" id="variant-annotations-assay">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-blue-400 to-blue-200 p-2 shadow-md rounded-t-lg break-all">Fusion Annotations (Assay)</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if annotations_interesting|length > 0 %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-blue-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold w-1/6">Who</th>
                    <th class="p-3 font-semibold w-4/6">Annotation</th>
                    <th class="p-3 font-semibold w-1/6">Assay</th>
                  </tr>
                </thead>
                <tbody id="variant-annotations-assay-body" class="{% if annotations_interesting|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for assay_sub, key in annotations_interesting.items() %}
                    <tr class="hover:bg-blue-100 border-t border-gray-400 text-left align-top">
                      <td class="p-2 font-medium">{{ key.author }}<br><small>{{ key.time_created|human_date }}</small></td>
                      <td class="p-2" onclick="addText(event)">{{ key.text|format_comment|safe }}</td>
                      <td class="p-2">
                        {% if "assay" in key %}
                          {{ key.assay }}<br><small>{{ key.subpanel }}</small>
                        {% else %}
                          historic
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-blue-100 break-all">No fusion annotations (Assay) available.</em>
            {% endif %}
          </div>
        </div>

        <!-- Sample Specific Fusion comments -->
        <div class="bg-gray-50 w-full max-w-xl shadow-md rounded-lg mb-1" id="fusion-comments">
          <h2 class="text-sm font-semibold bg-gradient-to-b from-yellow-400 to-yellow-200 p-2 shadow-md rounded-t-lg break-all">Sample-Specific Fusion Comments</h2>
          <div class="rounded-b-lg overflow-x-auto">
            {% if fusion.comments|length > 0 %}
              <table class="w-full max-w-xl table-auto text-xs text-gray-800">
                <thead class="capitalize tracking-wide rounded-t-lg bg-yellow-100">
                  <tr class="border-b text-left border-gray-800">
                    <th class="p-3 font-semibold w-1/6">Who</th>
                    <th class="p-3 font-semibold w-4/6">Comment</th>
                    <th class="p-3 font-semibold w-1/6">Action</th>
                  </tr>
                </thead>
                <tbody id="fusion-comments-body" class="{% if fusion.comments|length > 1 %}border-b border-gray-400 {% endif %}">
                  {% for comment in fusion.comments|sort(attribute='time_created', reverse=True) %}
                    {% if comment.hidden != 1 %}
                      <tr class="hover:bg-yellow-50 border-t border-gray-400 text-left align-top">
                    {% else %}
                      <tr class="bg-red-100 hover:bg-red-200 opacity-30 border-t border-gray-400 text-left align-top hidden hidden_comment">
                    {% endif %}
                      <td class="p-2 font-medium">{{ comment.author }}<br><small>{{ comment.time_created|human_date }}</small></td>
                      <td class="p-2" onclick="addText(event)">{{ comment.text|format_comment|safe }}</td>
                      <td class="p-2">
                        {% if comment.hidden != 1 %}
                          <form action="{{ url_for('rna_bp.hide_fusion_comment', sample_id=sample.name, fus_id=fusion._id) }}" method="POST">
                            <input type="hidden" name="comment_id" value="{{ comment._id }}">
                            <input id="hide_comment" type="image" class="w-5 {% if not has_access('hide_variant_comment', min_role='manager', min_level=99) %} opacity-70 select-none cursor-not-allowed pointer-events-none {% endif %}" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye-slash.svg') }}">
                          </form>
                        {% else %}
                          <form action="{{ url_for('rna_bp.unhide_fusion_comment', sample_id=sample.name, fus_id=fusion._id) }}" method="POST">
                            <input type="hidden" name="comment_id" value="{{ comment._id }}">
                            <input id="unhide_comment" type="image" class="w-5 {% if not has_access('unhide_variant_comment', min_role='manager', min_level=99) %} opacity-70 select-none cursor-not-allowed pointer-events-none {% endif %}" src="{{ url_for('static', filename='icons/heroicons_outline_24/eye.svg') }}">
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                  {% if hidden_comments %}
                    <tr>
                      <td colspan=3 class="py-2 px-4 border-t border-gray-300 text-center text-sm text-gray-800">
                        <a href="javascript:void(0);" onclick="switchVisibility_comments('hidden_comment')">
                          Show/Hide Deleted Comments
                        </a>
                      </td>
                    </tr>
                {% endif %}
                </tbody>
              </table>
            {% else %}
              <em class="block text-center text-gray-600 text-sm italic p-4 rounded-b-lg border border-gray-300 shadow-md hover:bg-yellow-50 break-all">No sample-specific fusion comments available.</em>
            {% endif %}
          </div>
        </div>





      </div>



    </section>

  </main>

</div>




<script type="text/javascript">
  $("#test").select2();

  window.onload = function() {
    $('[data-autoclick="true"]').click();
    $('[data-autoclick="true"]').click();
  };

  function switchVisibility_comments(class_name) {
    var elems = document.querySelectorAll('.' + class_name); // Use querySelectorAll to get a static NodeList

    elems.forEach(elem => {
        if (window.getComputedStyle(elem).display === "none") {
            elem.style.display = "table-row";  // Ensure it is visible in table format
        } else {
            elem.style.display = "none"; // Hide it
        }
    });
}


function switchVisibility_noncanonicaltranscripts(class_name) {
  var hide_class = "visibility-collapsed";

  var elems = document.getElementsByClassName(class_name);

  for (var i = 0; i < elems.length; i++) {

    if( elems[i].classList.contains(hide_class) ) {
      elems[i].classList.remove(hide_class);
    }
    else {
      elems[i].classList.add(hide_class);
    }
  }
}

function addText(event) {
  var targ = event.target || event.srcElement;
  if (!targ.closest('tr').classList.contains('hidden_comment')) {
    document.getElementById("comment_textarea").value = targ.textContent || targ.innerText;
  }
}


</script>















{% endblock%}
