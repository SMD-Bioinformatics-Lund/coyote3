{% extends "layout.html" %}

{% block body %}

{# check permissions for dna cnv actions buttons #}
{% set fusion_actions_disabled = not has_access('manage_translocs', min_role='user', min_level=9) %}
{% set fusion_actions_class = "opacity-70 select-none cursor-not-allowed pointer-events-none" if fusion_actions_disabled else "" %}
{% set fusion_actions_attr = "disabled" if fusion_actions_disabled else "" %}

{# check permissions for the tier #}
{% set rna_tier_disabled = not has_access('assign_tier', min_role='manager', min_level=99) %}
{% set rna_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if rna_tier_disabled else "" %}
{% set rna_tier_disabled_attr = "disabled" if rna_tier_disabled else "" %}

{# check permissions for remove variant tier #}
{% set can_remove_tier = has_access('remove_tier', min_role='manager', min_level=99) %}
{% set can_remove_global_tier = has_access('remove_tier_global', min_role='admin') %}
{% set remove_tier_disabled = not can_remove_tier %}
{% set remove_global_tier_disabled = not can_remove_global_tier %}
{% set remove_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if remove_tier_disabled else "" %}
{% set remove_global_tier_classes = "opacity-70 select-none cursor-not-allowed pointer-events-none" if remove_global_tier_disabled else "" %}
{% set remove_tier_attr = "disabled" if remove_tier_disabled else "" %}
{% set remove_global_tier_attr = "disabled" if remove_global_tier_disabled else "" %}


{# check permissions for dna variant actions buttons #}
{% set fusion_actions_disabled = not has_access('manage_snvs', min_role='user', min_level=9) %}
{% set fusion_actions_class = "opacity-70 select-none cursor-not-allowed pointer-events-none" if fusion_actions_disabled else "" %}
{% set fusion_actions_attr = "disabled" if fusion_actions_disabled else "" %}



{% set sel_fus = (fusion.calls|selectattr('selected', 'equalto', 1) |list)[0] %}


<div class="flex w-full h-full overflow-hidden bg-blue-50">
  <!-- Fusion Wall left side bar -->
  <aside class="w-80 bg-transparent text-black flex flex-col overflow-y-auto shadow-lg rounded-lg mr-2 ml-1 left-0 h-full border-r-2 border-t-2 border-brown-400">
    <!-- Fusion Wall -->
    <div class="flex justify-center items-center bg-gradient-to-b from-brown-300 to-brown-200 py-2 rounded-t-md shadow-lg">
      <img src="{{ url_for('static', filename='icons/heroicons_outline_24/bookmark.svg') }}" alt="Tag Icon" class="w-4 h-4 mr-2 opacity-80">
      <h2 class="text-sm font-semibold capitalize tracking-wide text-black">Fusion Wall</h2>
    </div>

    <!-- Table Container -->
    <div class="overflow-auto shadow-lg bg-transparent p-0">
      <table class="table-auto bg-blue-50 w-full text-xs text-black border-collapse">
        <tbody class="break-all">
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Gene 1 (5'):</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="http://www.cbioportal.org/ln?q={{ fusion.gene1 }}" class="text-blue-600 underline">{{ fusion.gene1 }}</a>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Gene 2 (3'):</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="http://www.cbioportal.org/ln?q={{ fusion.gene2 }}" class="text-blue-600 underline">{{ fusion.gene2 }}</a>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Breakpoint:</th>
            <td class="p-1 text-right font-medium">{{sel_fus.breakpoint1}}<br>{{sel_fus.breakpoint2}}
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Chromosome:</th>
            <td class="p-1 text-right font-medium">
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Mitelman:</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="https://mitelmandatabase.isb-cgc.org/mb_search" class="text-blue-600 underline">link</a>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Atlas of GCOH:</th>
            <td class="p-1 text-right font-medium"><a href="https://pubmed.ncbi.nlm.nih.gov/?term={{fusion.gene1}}%09{{fusion.gene2}}&btnG=Google+Search&domains=atlasgeneticsoncology.org&sitesearch=atlasgeneticsoncology.org&btnI" target="_blank" class="text-blue-500 hover:underline text-s">link</a></td>
          </tr>
          <tr class="hover:bg-brown-100 shadow-md rounded-lg">
            <th class="p-1 font-semibold text-left w-1/2">Pubmed:</th>
            <td class="p-1 text-right font-medium"><a target="_blank" href="https://pubmed.ncbi.nlm.nih.gov/?term={{fusion.gene1}}%3A%3A{{fusion.gene2}}" class="text-blue-600 underline">{{fusion.gene1}}::{{fusion.gene2}}</a></td>
          </tr>
        </tbody>
      </table>
	  </div>
  </aside>


  <main class="flex-1 bg-transparent overflow-y-auto py-2 px-1 flex flex-col">

    <!-- sample info -->
    {% include "sample_meta_rna_info.html" %}

    <section class="bg-gray-100 p-2 my-2 flex flex-wrap justify-between w-full shadow-lg rounded-xl relative gap-2 z-0 border-l-8 border-r-8 border-purple-400 whitespace-normal break-all" id="variant-info">

      <!-- Fusion Info Left Section -->
      <div class="flex flex-col ml-2 mr-4">
        <h2 class="text-base font-bold">{{ fusion.gene1 }}-{{ fusion.gene2}}</h2>
      </div>

      <!-- Right Section Tier info --> <!-- Change this with tooltip -->
      <div class="flex flex-col text-right ml-2 mr-4 overflow-x-auto">
        <h2 class="text-base font-bold pb-1">
          Classify Fusion
        </h2>
        <div class="flex flex-wrap items-center justify-end">
          <!-- Tier Buttons -->
          <form action="{{ url_for('dna_bp.classify_variant', sample_id=sample.name, var_id=fusion._id) }}" method="post">
            <input type="hidden" name="assay_group" value="{{ assay_group }}">
            <input type="hidden" name="subpanel" value="{{ subpanel }}">
            <input type="hidden" name="gene1" value="{{ fusion.gene1 }}">
						<input type="hidden" name="gene2" value="{{ fusion.gene2 }}">
						<input type="hidden" name="fusionpoints" value="{{sel_fus.breakpoint1}}^{{sel_fus.breakpoint2}}">

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 1 %}
                  bg-gray-300 transition-all duration-300 ease-in-out transform hover:translate-y-1 hover:bg-orange-500
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class }}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier1"
              type="submit"
              value="Tier I"
              name="tier1"
              title="Tier I: Strong Clinical Significance"
              {{ rna_tier_disabled_attr }}
              />

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 2 %}
                  bg-gray-300 hover:bg-yellow-400 transition-all duration-300 ease-in-out transform hover:translate-y-1
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class}}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier2"
              type="submit"
              name="tier2"
              value="Tier II"
              title="Tier II: Potential Clinical Significance"
              {{ rna_tier_disabled_attr }}
            />

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 3 %}
                  bg-gray-300 hover:bg-blue-500 transition-all duration-300 ease-in-out transform hover:translate-y-1
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class}}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier3"
              type="submit"
              name="tier3"
              value="Tier III"
              title="Tier III: Unknown Clinical Significance"
              {{ rna_tier_disabled_attr }}
            />

            <input class="m-1 text-black text-sm px-3 py-1.5 rounded-md shadow-lg  cursor-pointer whitespace-normal break-all
                {% if latest_classification.class != 4 %}
                  bg-gray-300 hover:bg-green-600 transition-all duration-300 ease-in-out transform hover:translate-y-1
                {% else %}
                  cursor-not-allowed font-bold text-white bg-tier{{ latest_classification.class}}
                {% endif %}
                {{ rna_tier_classes }}"
              id="tier4"
              type="submit"
              name="tier4"
              value="Tier IV"
              title="Tier IV: Benign"
              {{ rna_tier_disabled_attr }}
            />
          </form>

          <!-- Remove Tier Info -->
          {% if latest_classification.class != 999 %}
          <form id="form" action="{{ url_for('dna_bp.remove_classified_variant', sample_id=sample.name ,var_id=fusion._id) }}" method="post" class="inline-flex items-center space-x-2" >
            <input type="hidden" name="gene1" value="{{ fusion.gene1 }}">
            <input type="hidden" name="gene2" value="{{ fusion.gene2 }}">
            <input type="hidden" name="fusionpoints" value="{{sel_fus.breakpoint1}}^{{sel_fus.breakpoint2}}">
            <input type="hidden" name="assay_group" value="{{ assay_group }}">
            <input type="hidden" name="subpanel" value="{{ subpanel }}">
            {% if latest_classification and 'assay' in classification %}
              <input
                class="m-1 bg-gray-300 text-black text-sm px-2 py-1 rounded-md shadow-lg cursor-pointer hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:translate-y-1 whitespace-normal break-all {{ remove_tier_classes }}"
                title="Remove {{ assay_group }} classifications"
                id="remove"
                type="submit"
                value="❌ Tier"
                onclick="return confirm('This will remove all tiering for {{ assay_group }}, proceed?')"
                {{ remove_tier_attr }}
              >
              {% elif current_user.is_admin %}
                <input
                  class="m-1 bg-gray-300 text-black text-sm px-2 py-1 rounded-md shadow-lg cursor-pointer hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:translate-y-1 whitespace-normal break-all {{ remove_global_tier_classes }}"
                  title="Remove historic non-assay classifications"
                  id="remove"
                  type="submit"
                  value="❌ Tier"
                  onclick="return confirm('This will remove all historic tiering without any assays assigned, proceed?')"
                  {{ remove_global_tier_attr }}
                >
              {% endif %}
          </form>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Top buttons for links and actions -->
    <section class="relative gap-2 z-0 mt-2 ml-1 bg-gray-100 py-1 shadow-lg rounded-xl border-l-8 border-r-8 border-blue-400" id="variant-actions-buttons">
      <div class="flex flex-wrap items-start justify-end ml-auto mr-4 gap-2">
        <div class="relative">
          <div class="absolute top-0 left-0 w-full h-1 bg-yellow-400 break-all"></div>
          {% if fusion.fp == true %}
            <form action="{{ url_for('rna_bp.unmark_false_fusion', id=fusion._id) }}" method="post">
              <input class="relative bg-yellow-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-gray-200 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_fp" value="Unmark False Positive" {{ fusion_actions_attr }}>
            </form>
          {% else %}
            <form action="{{ url_for('rna_bp.mark_false_fusion', id=fusion._id) }}" method="post">
              <input class="relative bg-gray-300 text-black text-xs text-center p-2 mb-1 rounded-b-md shadow-lg cursor-pointer hover:bg-yellow-100 transition-all duration-300 ease-in-out transform hover:translate-y-1 block whitespace-normal break-all {{variant_actions_class}}" type="submit" name="mark_fp" value="Mark as False Positive" {{ fusion_actions_attr }}>
            </form>
          {% endif %}
        </div>
      </div>
    </section>



  </main>

</div>




















{% endblock%}
