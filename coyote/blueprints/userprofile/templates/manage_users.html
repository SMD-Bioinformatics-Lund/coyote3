{% extends "layout.html" %}
{% block title %}Manage Users{% endblock %}
{% block body %}

<div class="flex w-full h-full overflow-hidden">
  <main class="flex-1 bg-transparent overflow-y-auto p-4 flex flex-col">
    
    <!-- Manage Users Section -->
    <section id="manage-users-section" class="p-2 ml-2 mt-2">
      <div class="justify-start">
        <div class="w-4/5 bg-blue-50 shadow-3xl rounded-2xl p-4 relative overflow-hidden">
          <!-- Header -->
          <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 px-2 py-2">
            <h2 class="text-base font-semibold text-black tracking-wide uppercase">Manage Users</h2>
            <div class="relative w-full md:w-64">
              <input type="text" id="search-input" class="w-full border border-gray-300 rounded-lg py-2 pl-4 pr-10 text-sm text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="Search users">
              <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                <img src="{{ url_for('static', filename='icons/heroicons_outline_24/magnifying-glass.svg') }}" alt="search user" class="h-5 w-5 text-gray-500 cursor-pointer" onclick="document.getElementById('search-input').focus()">
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="overflow-x-auto rounded-2xl shadow-3xl relative pagination"  id="users-list" data-rows-per-page="15" pagination-button-color="blue" pagination-button-text-color="black">
            <table id="users-list-table" class="min-w-full bg-transparent shadow-lg rounded-2xl text-xs my-2 overflow-hidden">
              <thead class="rounded-t-2xl overflow-hidden border-gray-800">
                <tr class="border-b text-left border-gray-800 bg-blue-200 uppercase tracking-wider shadow-xl rounded-t-2xl">
                  <th class="p-2 font-normal">Username</th>
                  <th class="p-2 font-normal">Full Name</th>
                  <th class="p-2 font-normal">Email</th>
                  <th class="p-2 font-normal">Role</th>
                  <th class="p-2 font-normal">Actions</th>
                </tr>
              </thead>
              <tbody id="users-list-body" class="text-gray-800 rounded-b-2xl overflow-hidden">
                {% for user in users %}
                  <tr class="border-t border-gray-400 hover:bg-blue-100 text-left last:rounded-b-2xl">
                    <td class="p-2 font-medium">{{ user._id }}</td>
                    <td class="p-2 font-medium">{{ user.fullname }}</td>
                    <td class="p-2 font-medium">{{ user.email }}</td>
                    <td class="p-2 font-medium">{{ user.role }}</td>
                    <td class="p-2 font-medium whitespace-nowrap">
                      <a href="{{ url_for('profile_bp.update_user', user_id=user._id) }}"
                        class="text-indigo-600 hover:text-indigo-800 font-medium mr-3">Update</a>
                      <button onclick="confirmDelete('{{ url_for('profile_bp.delete_user', user_id=user._id) }}')"
                              class="text-red-500 hover:text-red-700 font-medium">Delete</button>
                    </td>
                  </tr>
                {% else %}
                  <tr class="border-b border-gray-300">
                    <td colspan="5" class="p-2 font-medium text-center">No users found.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        <div>
      <div>
    </section>
  </main>
</div>

<!-- Delete Confirmation Model -->
<div id="deleteModel" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md border border-gray-200">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Confirm Deletion</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to delete this user?</p>
    <div class="flex justify-end gap-3">
      <button id="cancelButton"
              class="bg-gray-400 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded transition">
        Cancel
      </button>
      <a id="confirmButton"
        class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded transition">
        Delete
      </a>
    </div>
  </div>
</div>



<script>
    function confirmDelete(url) {
        const model = document.getElementById('deleteModel');
        const confirmButton = document.getElementById('confirmButton');
        model.classList.remove('hidden');
        confirmButton.setAttribute('href', url);
    }

    document.getElementById('cancelButton').addEventListener('click', function() {
        document.getElementById('deleteModel').classList.add('hidden');
    });



    const input = document.getElementById('search-input');
    const body = document.getElementById('users-list-body');
    const container = document.getElementById('users-list');
    const rowsPerPage = parseInt(container.dataset.rowsPerPage) || 15;
    const originalRows = [...body.querySelectorAll('tr')].map(r => r.cloneNode(true));
    const id = body.id;
  
    input.addEventListener('input', () => {
      const term = input.value.toLowerCase().trim();
  
      // Remove any existing pagination controls
      container.querySelectorAll('[data-prev], [data-next], [data-page-info]').forEach(el => el.parentElement?.remove());
  
      // Filter rows or reset
      const filtered = term
        ? originalRows.filter(row =>
            [...row.querySelectorAll('td')].slice(0, 4).some(td =>
              td.textContent.toLowerCase().includes(term)
            )
          )
        : originalRows;
  
      // Replace table body with filtered or full rows
      body.innerHTML = '';
      filtered.forEach(row => body.appendChild(row));
  
      // Trigger pagination if needed
      filtered.length > rowsPerPage ? initializePagination() : displayPage(1, id, rowsPerPage);
    });
</script>
    
{% endblock %}
