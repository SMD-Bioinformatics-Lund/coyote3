{% set curr_page = request.path.split("/")[-1] %}
{% extends "layout.html" %}
{% block title %}Main Screen{% endblock %}
{% block search %}
<form action="" method="POST" class="relative">
  {{ form.hidden_tag() }}
  <div class="absolute inset-y-0 right-0 flex items-center pr-16 mr-20">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-6 text-gray-700 cursor-pointer transition-transform duration-300 transform hover:scale-125 hover:text-blue-500" viewBox="0 0 20 20" fill="currentColor" onclick="document.getElementById('search-input').focus()">
      <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l5.386 5.386a1 1 0 01-1.414 1.414l-5.386-5.386zM8 14A6 6 0 108 2a6 6 0 000 12z" clip-rule="evenodd" />
    </svg>
  </div>
  <input type="text" name="sample_search" id="search-input" class="search-bar border border-gray-400 rounded py-1 pl-1 pr-12 mr-32 focus:outline-none focus:border-blue-500" placeholder="Search samples" size="33">
</form>
{% endblock %}
{% block body %}
<div class="side-buttons">
  <div class="side-button analysed">
    <a href="{{ url_for(request.endpoint, assay=assay, status='done') }}" class="block w-full h-full text-center py-2 px-1">Analysed</a>
  </div>
  <div class="side-button pending">
    <a href="{{ url_for(request.endpoint, assay=assay, status='live') }}" class="block w-full h-full text-center py-2 px-1">Pending</a>
  </div>
</div>

<div class="mx-auto ml-16 p-5">
  <div class="flex justify-start">
    <div class="w-4/5 ml-15%">
      {% if not status or status == "live" %}
      <div class="overflow-x-auto">
        <span class="text-lg font-semibold">Live Samples</span>
        <table class="min-w-full bg-white shadow-lg rounded-lg my-4 text-sm border border-gray-200 z-50">
          <thead>
            <tr class="bg-gray-200 border-b border-gray-300 text-gray-800 text-left uppercase tracking-wider">
              <th class="py-2 px-4 font-normal">Sample ID</th>
              <th class="py-2 px-4 font-normal"></th>
              <th class="py-2 px-4 font-normal">Group</th>
              <th class="py-2 px-4 font-normal">Diagnosis</th>
              <th class="py-2 px-4 font-normal">BAM</th>
              <th class="py-2 px-4 font-normal">QC</th>
              <th class="py-2 px-4 font-normal">When added</th>
            </tr>
          </thead>
          <tbody id="pagination-table-body" class="text-gray-700">
            {% for sample in live_samples %}
              <tr class="border-b border-gray-300">
                <td class="py-2 px-4">
                  {% if sample.groups|join('') == 'fusion' or sample.groups|join('') == 'solidRNA_GMSv5' %}
                    <a href="{{ url_for('rna_bp.list_fusions', id=sample.name) }}" class="text-blue-500 hover:underline">{{ sample.name }}</a>
                  {% else %}
                    <a href="{{ url_for('dna_bp.list_variants', id=sample.name) }}" class="text-blue-500 hover:underline">{{ sample.name }}</a>
                  {% endif %}
                  {% if sample.comments|selectattr('hidden', 'equalto', 0)|list|length > 0 %}
                    *
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {% if "num_samples" in sample %}
                    {% for n in range(sample.num_samples) %}
                      &#9679;
                    {% endfor %}
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {% for grp in sample.groups %}
                    {{ grp }}
                  {% endfor %}
                </td>
                <td class="py-2 px-4">
                  {% if "subpanel" in sample %}
                    {{ sample.subpanel }}
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {% if sample.bam is defined %}
                    <a href="{{ sample.bam }}" class="text-blue-500 hover:underline">BAM</a>
                    <a href="{{ sample.bam }}.bai" class="text-blue-500 hover:underline">BAI</a>
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {% if sample.QC is defined %}
                    {% for qc in sample.QC|sort(attribute='sample_id') %}
                      {% if "500" in qc.pct_above_x %}
                        <a href="sampleqc/{{ sample._id }}" class="text-blue-500 hover:underline">{{ '%0.0f'|format(qc.pct_above_x["500"]|float) }}%</a>
                      {% elif "tot_reads" in qc and "mapped_pct" in qc %}
                        <a href="sampleqc/{{ sample._id }}" class="text-blue-500 hover:underline">{{ '%0.0f'|format((qc.tot_reads/1000000)|float) }} M</a>
                      {% else %}
                        <a href="sampleqc/{{ sample._id }}" class="text-blue-500 hover:underline">0%</a>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {{ sample.time_added|human_date }}
                </td>
              </tr>
            {% else %}
              <tr class="border-b border-gray-300">
                <td colspan="6" class="py-2 px-4 text-center">No live samples.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <!-- Pagination Controls -->
        <div class="flex justify-between mt-4">
          <button id="prev-page" class="bg-blue-500 text-white py-1 px-2 rounded disabled:opacity-50" onclick="prevPage()">Previous</button>
          <div id="page-info" class="text-sm"></div>
          <button id="next-page" class="bg-blue-500 text-white py-1 px-2 rounded disabled:opacity-50" onclick="nextPage()">Next</button>
        </div>
      </div>
      {% endif %}
      {% if status == "done" %}
      <div class="overflow-x-auto mt-6">
        <span class="text-lg font-semibold">Reported samples (<a href="?all=1" class="text-blue-500 hover:underline">show all</a>)</span>
        <table class="min-w-full bg-white shadow-lg rounded-lg my-4 text-sm border border-gray-200 z-50">
          <thead>
            <tr class="bg-gray-200 border-b border-gray-300 text-gray-800 text-left uppercase tracking-wider">
              <th class="py-2 px-4 font-normal">Sample ID</th>
              <th class="py-2 px-4 font-normal"></th>
              <th class="py-2 px-4 font-normal">Group</th>
              <th class="py-2 px-4 font-normal">Diagnosis</th>
              <th class="py-2 px-4 font-normal">When added</th>
              <th class="py-2 px-4 font-normal">Last report</th>
              <th class="py-2 px-4 font-normal">BAM</th>
              <th class="py-2 px-4 font-normal">QC</th>
              <th class="py-2 px-4 font-normal">Reports</th>
            </tr>
          </thead>
          <tbody id="pagination-table-body" class="text-gray-700">
            {% for sample in done_samples|sort(attribute="last_report_time_created", reverse=True) %}
              <tr class="border-b border-gray-300">
                <td class="py-2 px-4">
                  <a href="{{ url_for('dna_bp.list_variants', id=sample.name) }}" class="text-blue-500 hover:underline">{{ sample.name }}</a>
                </td>
                <td class="py-2 px-4">
                  {% if "num_samples" in sample %}
                    {% for n in range(sample.num_samples) %}
                      &#9679;
                    {% endfor %}
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {% for grp in sample.groups %}
                    {{ grp }}
                  {% endfor %}
                </td>
                <td class="py-2 px-4">
                  {% if "subpanel" in sample %}
                    {{ sample.subpanel }}
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {{ sample.time_added|human_date }}
                </td>
                <td class="py-2 px-4">
                  {{ sample.last_report_time_created|human_date }}
                </td>
                <td class="py-2 px-4">
                  {% if sample.bam is defined %}
                    <a href="{{ sample.bam }}" class="text-blue-500 hover:underline">BAM</a>
                    <a href="{{ sample.bam }}.bai" class="text-blue-500 hover:underline">BAI</a>
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {% if sample.QC is defined %}
                    {% for qc in sample.QC|sort(attribute='sample_id') %}
                      {% if "500" in qc.pct_above_x %}
                        <a href="sampleqc/{{ sample._id }}" class="text-blue-500 hover:underline">{{ '%0.0f'|format(qc.pct_above_x["500"]|float) }}%</a>
                      {% elif "tot_reads" in qc and "mapped_pct" in qc %}
                        <a href="sampleqc/{{ sample._id }}" class="text-blue-500 hover:underline">{{ '%0.0f'|format((qc.tot_reads/1000000)|float) }} M</a>
                      {% else %}
                        <a href="sampleqc/{{ sample._id }}" class="text-blue-500 hover:underline">0%</a>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </td>
                <td class="py-2 px-4">
                  {% for rep in sample.reports %}
                    <a href="{{rep.filepath}}" class="text-blue-500 hover:underline">{{ rep.report_num }}</a>
                  {% endfor %}
                </td>
            </tr>
            {% else %}
              <tr class="border-b border-gray-300">
                <td colspan="8" class="py-2 px-4 text-center">No samples.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <!-- Pagination Controls -->
        <div class="flex justify-between mt-4">
          <button id="prev-page" class="bg-blue-500 text-white py-1 px-2 rounded disabled:opacity-50" onclick="prevPage()">Previous</button>
          <div id="page-info" class="text-sm"></div>
          <button id="next-page" class="bg-blue-500 text-white py-1 px-2 rounded disabled:opacity-50" onclick="nextPage()">Next</button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  const rowsPerPage = 10;
  let currentPage = 1;
  const tableBody = document.getElementById('pagination-table-body');
  const rows = Array.from(tableBody.getElementsByTagName('tr'));
  const pageInfo = document.getElementById('page-info');

  function displayPage(page) {
    const start = (page - 1) * rowsPerPage;
    const end = page * rowsPerPage;

    rows.forEach((row, index) => {
      if (index >= start && index < end) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });

    pageInfo.textContent = `Page ${page} of ${Math.ceil(rows.length / rowsPerPage)}`;
    document.getElementById('prev-page').disabled = page === 1;
    document.getElementById('next-page').disabled = page === Math.ceil(rows.length / rowsPerPage);
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      displayPage(currentPage);
    }
  }

  function nextPage() {
    if (currentPage < Math.ceil(rows.length / rowsPerPage)) {
      currentPage++;
      displayPage(currentPage);
    }
  }

  // Initialize pagination
  displayPage(currentPage);
</script>
{% endblock %}
