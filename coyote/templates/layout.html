{% if 'done' in request.path or 'live' in request.path %}
  {% set curr_page = request.path.split("/")[-2] %}
{% elif '/panels/' in request.path or 'tumwgs' in request.path or 'rna' in request.path %}
  {% set curr_page = request.path.split("/")[-1] %}
{% elif 'samples' in request.path %}
  {% set curr_page = 'samples' %}
{% else %}
  {% set curr_page = request.path.split("/")[-1] %}
{% endif %}

<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}COYOT3{% endblock %}</title>

    <!-- Tailwind CSS -->
    <link href="{{ url_for('static', filename='css/tailwind.2.2.19.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.tailwind.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='icons/favicon.ico') }}" rel="shortcut icon">

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/jquery-3.1.1.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/select2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sortableTable.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pagination.js') }}"></script>


    <style>
      .vertical-text {
        writing-mode: vertical-lr; /* Rotates text while keeping button upright */
        text-orientation: mixed;
      }
    </style>
    {% block style %}{% endblock %}
    {% block javascript %}{% endblock %}
  </head>

  <body class="bg-gradient-to-t from-blue-100 to-indigo-100 text-sm overflow-hidden w-full border-t-4 border-indigo-400">

    <!-- FLASH MESSAGES -->
    <div id="alert-container" class="fixed top-20 right-10 z-50 space-y-3">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash-message flex items-center bg-{{ category }}-100 border-l-4 border-{{ category }}-500 text-{{ category }}-900 px-4 py-2 rounded-xl shadow-2xl relative z-50 transform transition-all duration-500 ease-in-out translate-x-full opacity-0 backdrop-blur-lg">
              <img src="{{ url_for('static', filename='icons/heroicons_outline_24/exclamation-circle.svg') }}" alt="Alert" class="h-6 w-6 mr-3 text-{{ category }}-500 transition-transform duration-300 transform hover:scale-125 hover:rotate-12">
              <span class="flex-1 text-sm font-semibold tracking-wide">{{ message }}</span>
              <button type="button" class="ml-4 p-2 rounded-full bg-{{ category }}-200 hover:bg-{{ category }}-300 transition duration-300 close-btn">
                <img src="{{ url_for('static', filename='icons/heroicons_outline_24/x-mark.svg') }}" alt="Close" class="h-5 w-5 transition-transform duration-300 transform hover:scale-125 hover:rotate-12">
              </button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>


    <!-- CONTAINER: Full Page Structure -->
    <div class="flex flex-col h-screen w-full">
      <!-- HEADER (LOGO + USER INFO) -->
      <header class="text-black py-1 px-8 flex justify-between items-center w-full z-50">
        <a href="{{ url_for('dashboard_bp.dashboard') }}" class="flex items-center space-x-2 tracking-wide text-3xl font-bold">
          <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Coyote Logo" class="h-12 w-20 transition-transform duration-300 transform hover:scale-110 hover:rotate-12">
          <span >COYOT3 <span class="px-1 pt-2 text-xs tracking-tight font-normal align-baseline">v{{config['APP_VERSION']}}</span></span>
        </a>

        {% if current_user.is_authenticated %}
          <div class="relative">
            <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none mx-8">
              <img class="h-8 w-8 rounded-full transition-transform duration-300 transform hover:scale-110 hover:rotate-6 bg-transparent" src="{{ url_for('static', filename='icons/user-512.png') }}">
              <span class="text-black font-bold">{{ current_user.get_fullname() }}</span>
            </button>

            <!-- Dropdown Menu -->
            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-40 bg-indigo-50 rounded-lg shadow-lg">
              <a href="{{ url_for('dashboard_bp.dashboard') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Dashboard</a>
              <a href="{{ url_for('genepanels_bp.display_genepanels') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Gene Panels</a>
              <a href="{{ url_for('profile_bp.profile') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Profile</a>
              <a href="{{ url_for('profile_bp.change_password', username=current_user.get_id()) }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Change Password</a>
              {% if current_user.is_admin() %}
                <a href="{{ url_for('profile_bp.manage_users') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Manage Users</a>
                <a href="{{ url_for('profile_bp.create_user') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Create User</a>
              {% endif %}
              <a href="{{ url_for('login_bp.logout') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Logout</a>
            </div>
          </div>
        {% endif %}
      </header>

      <!-- NAVBAR (Below Header, No Absolute Positioning) -->
      <nav class="bg-indigo-300 shadow-lg text-black px-2 py-1.5 flex space-x-4 pl-14 w-full border-b-4 border-indigo-400">
        {% set navbar = {
          'home': 'HOME',
          'samples': 'SAMPLES',
          'panels': 'PANELS',
          'tumwgs': 'TUMWGS',
          'rna': 'RNA'
        } %}
      
        {% if "/panels" in request.path %}
          {% set navbar = {
            'home': 'HOME',
            'samples': 'SAMPLES',
            'myeloid_GMSv1': 'MYELOID',
            'solid_GMSv3': 'SOLID',
            'PARP_inhib': 'PARP'
          } %}
        {% elif "/rna" in request.path %}
          {% set navbar = {
            'home': 'HOME',
            'samples': 'SAMPLES',
            'fusion': 'MYELOID',
            'solidRNA_GMSv5': 'SOLID'
          } %}
        {% elif "/tumwgs" in request.path %}
          {% set navbar = {
            'home': 'HOME',
            'samples': 'SAMPLES',
            'tumwgs-solid': 'PEDIATRIC SOLID',
            'tumwgs-hema': 'HEMATOLOGY'
          } %}
        {% endif %}
        
        {% for name, menu_label in navbar.items() %}
          {% if name == 'home' %}
            {% set url = url_for('dashboard_bp.dashboard') %}
          {% elif name == 'samples' %}
            {% set url = url_for('home_bp.home_screen') %}
          {% elif name == 'panels' %}
            {% set url = url_for('home_bp.panels_screen', assay='myeloid_GMSv1') %}
          {% elif '/panels' in request.path %}
            {% set url = url_for('home_bp.panels_screen', assay=name) %}
          {% elif name == 'rna' %}
          {% set url = url_for('home_bp.rna_screen', assay='fusion') %}
          {% elif '/rna' in request.path %}
            {% set url = url_for('home_bp.rna_screen', assay=name) %}
          {% elif name == 'tumwgs' %}
            {% set url = url_for('home_bp.tumwgs_screen', assay='tumwgs-solid') %}
          {% elif '/tumwgs' in request.path %}
            {% set url = url_for('home_bp.tumwgs_screen', assay=name) %}
          {% else %}
            {% set url = url_for('home_bp.main_screen', assay=name) %}
          {% endif %}
          {% if name == curr_page %}
            <a href="{{ url }}" class="active text-black font-bold">{{ menu_label }}</a>
          {% else %}
            <a href="{{ url }}" class="text-gray-600 hover:text-gray-900">{{ menu_label }}</a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- MAIN CONTENT (SCROLLABLE GRID LAYOUT) -->

      {% block body %}{% endblock %}


    </div>

    <!-- Reusable Confirmation modal -->
    <div id="actionModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
      <div class="bg-blue-50 rounded-xl shadow-xl p-6 w-full max-w-md border border-gray-200">
        <h2 id="actionModalTitle" class="text-xl font-semibold text-gray-800 mb-4">Confirm Action</h2>
        <p id="actionModalMessage" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
        <div class="flex justify-center gap-3">
          <button id="actionModalCancel"
                  class="bg-gray-400 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition">
            Cancel
          </button>
          <a id="actionModalConfirm"
            href="#"
            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition">
            Confirm
          </a>
        </div>
      </div>
    </div>


    <script>

      // JavaScript for Action Modal
      function showActionModal({ url, title = "Confirm Action", message = "Are you sure you want to proceed?", confirmText = "Confirm", confirmColor = "blue" }) {
        const modal = document.getElementById('actionModal');
        const titleEl = document.getElementById('actionModalTitle');
        const messageEl = document.getElementById('actionModalMessage');
        const confirmBtn = document.getElementById('actionModalConfirm');
    
        // Set modal content dynamically
        titleEl.textContent = title;
        messageEl.innerHTML = message;
        confirmBtn.textContent = confirmText;
        confirmBtn.setAttribute('href', url);
    
        // Dynamic confirm button color
        confirmBtn.className = `bg-${confirmColor}-600 hover:bg-${confirmColor}-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition`;
    
        modal.classList.remove('hidden');
      }
    
      document.getElementById('actionModalCancel').addEventListener('click', () => {
        document.getElementById('actionModal').classList.add('hidden');
      });
      

      // JavaScript for User Dropdown Menu
      document.addEventListener('DOMContentLoaded', function() {
        var userMenuButton = document.getElementById('userMenuButton');
        var userDropdown = document.getElementById('userDropdown');

        userMenuButton.addEventListener('click', function(event) {
          event.stopPropagation();
          userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        window.addEventListener('click', function() {
          if (!userDropdown.classList.contains('hidden')) {
            userDropdown.classList.add('hidden');
          }
        });

        // Prevent dropdown from closing when clicking inside
        userDropdown.addEventListener('click', function(event) {
          event.stopPropagation();
        });
      });



        // Flash Message Animation
        document.addEventListener("DOMContentLoaded", function () {
          const alerts = document.querySelectorAll(".flash-message");
          alerts.forEach((alert, index) => {
            let timeoutId;
      
            function startTimeout() {
              timeoutId = setTimeout(() => {
                alert.classList.remove("translate-x-0", "opacity-100");
                alert.classList.add("translate-x-full", "opacity-0");
                setTimeout(() => alert.style.display = "none", 500);
              }, 7000 + index * 100); // currently set tot 7 sec
            }
      
            setTimeout(() => {
              alert.classList.remove("translate-x-full", "opacity-0");
              alert.classList.add("translate-x-0", "opacity-100");
              startTimeout();
            }, 100 + index * 100);
      
            alert.addEventListener("mouseenter", () => clearTimeout(timeoutId));
            alert.addEventListener("mouseleave", startTimeout);
      
            alert.querySelector(".close-btn").addEventListener("click", function () {
              clearTimeout(timeoutId);
              alert.classList.remove("translate-x-0", "opacity-100");
              alert.classList.add("translate-x-full", "opacity-0");
              setTimeout(() => alert.style.display = "none", 500);
            });
          });
        });
      

      // JavaScript for Tooltip functionality
      function showTooltip(event, content) {
        let tooltip = document.getElementById("global-tooltip");

        if (!tooltip) {
            tooltip = document.createElement("div");
            tooltip.id = "global-tooltip";
            tooltip.className = "fixed bg-black text-white text-xs rounded-md shadow-lg p-2 w-auto max-w-xs opacity-0 transition-all duration-200 z-50 pointer-events-none";
            document.body.appendChild(tooltip);
        }

        tooltip.innerHTML = content;
        tooltip.style.opacity = "1";
        tooltip.style.pointerEvents = "auto";

        let x = event.clientX + 15;
        let y = event.clientY + 15;

        // Prevent tooltip from overflowing right edge
        if (x + tooltip.offsetWidth > window.innerWidth) {
            x = event.clientX - tooltip.offsetWidth - 15;
        }
        // Prevent tooltip from overflowing bottom edge
        if (y + tooltip.offsetHeight > window.innerHeight) {
            y = event.clientY - tooltip.offsetHeight - 15;
        }

        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;

        // Hide tooltip when mouse leaves the element
        event.target.addEventListener("mouseleave", function hideTooltip() {
            tooltip.style.opacity = "0";
            tooltip.style.pointerEvents = "none";
            event.target.removeEventListener("mouseleave", hideTooltip);
        });
      }


      // JavaScript for hiding and showing long text 
      function toggleLongText(button) {
        const target = button.dataset.target;
        const short = document.getElementById(`${target}-short`);
        const full = document.getElementById(`${target}-full`);
      
        const isShortVisible = !short.classList.contains('hidden');
        short.classList.toggle('hidden', isShortVisible);
        full.classList.toggle('hidden', !isShortVisible);
      
        button.innerText = isShortVisible ? '[−]' : '[+]';
      }
      
      // Check overflow for all toggle targets
      window.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.text-toggle').forEach(button => {
          const target = button.dataset.target;
          const shortEl = document.getElementById(`${target}-short`);
          if (shortEl && shortEl.scrollWidth > shortEl.clientWidth) {
            button.classList.remove('hidden');
          }
        });
      });

      // JavaScript for autoclick keys tables
      window.onload = function () {
        $('[data-autoclick="true"]').click();
        $('[data-autoclick="true"]').click();
      };

    </script>
    {% block script %}{% endblock %}
    {% block footer %}{% endblock %}
  </body>
</html>
