


<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}COYOT3{% endblock %}</title>

    <!-- Tailwind CSS -->
    <link href="{{ url_for('static', filename='css/tailwind.2.2.19.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.tailwind.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='icons/favicon.ico') }}" rel="shortcut icon">

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/jquery-3.1.1.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/select2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sortableTable.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pagination.js') }}"></script>


    <style>
      .vertical-text {
        writing-mode: vertical-lr; /* Rotates text while keeping button upright */
        text-orientation: mixed;
      }
    </style>
    {% block style %}{% endblock %}
    {% block javascript %}{% endblock %}
  </head>

  <body class="bg-gradient-to-t from-blue-100 to-indigo-100 text-sm overflow-hidden w-full border-t-4 border-indigo-400">

    <!-- FLASH MESSAGES -->
    <div id="alert-container" class="fixed top-20 right-10 z-50 space-y-3">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash-message flex items-center bg-{{ category }}-100 border-l-4 border-{{ category }}-500 text-{{ category }}-900 px-4 py-2 rounded-xl shadow-2xl relative z-50 transform transition-all duration-500 ease-in-out translate-x-full opacity-0 backdrop-blur-lg">
              <img src="{{ url_for('static', filename='icons/heroicons_outline_24/exclamation-circle.svg') }}" alt="Alert" class="h-6 w-6 mr-3 text-{{ category }}-500 transition-transform duration-300 transform hover:scale-125 hover:rotate-12">
              <span class="flex-1 text-sm font-semibold tracking-wide">{{ message }}</span>
              <button type="button" class="ml-4 p-2 rounded-full bg-{{ category }}-200 hover:bg-{{ category }}-300 transition duration-300 close-btn">
                <img src="{{ url_for('static', filename='icons/heroicons_outline_24/x-mark.svg') }}" alt="Close" class="h-5 w-5 transition-transform duration-300 transform hover:scale-125 hover:rotate-12">
              </button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>


    <!-- CONTAINER: Full Page Structure -->
    <div class="flex flex-col h-screen w-full">
      <!-- HEADER (LOGO + USER INFO) -->
      <header class="text-black py-1 px-8 flex justify-between items-center w-full z-50">
        <a href="{{ url_for('dashboard_bp.dashboard') }}" class="flex items-center space-x-2 tracking-wide text-3xl font-bold">
          <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Coyote Logo" class="h-12 w-20 transition-transform duration-300 transform hover:scale-110 hover:rotate-12">
          <span >COYOT3 <span class="px-1 pt-2 text-xs tracking-tight font-normal align-baseline">v{{config['APP_VERSION']}}</span></span>
        </a>

        {% if current_user.is_authenticated %}
          <div class="relative">
            <button id="userMenuButton" class="flex items-center space-x-2 focus:outline-none mx-8">
              <img class="h-8 w-8 rounded-full transition-transform duration-300 transform hover:scale-110 hover:rotate-6 bg-transparent" src="{{ url_for('static', filename='icons/user-512.png') }}">
              <span class="text-black font-bold">{{ current_user.fullname }}</span>
            </button>

            <!-- Dropdown Menu -->
            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-40 bg-indigo-50 rounded-lg shadow-lg">
              <a href="{{ url_for('dashboard_bp.dashboard') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Dashboard</a>
              <a href="{{ url_for('profile_bp.profile') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Profile</a>
              {% if password_changed_enabled %}
                <a href="{{ url_for('profile_bp.change_password', username=current_user.username) }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100 ">Change Password</a>
              {% endif %}
              {% if has_access(min_role="manager", min_level=99) %}
                <a href="{{ url_for('admin_bp.admin_home') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Admin DB</a>
              {% endif %}
              <a href="{{ url_for('login_bp.logout') }}" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">Logout</a>
            </div>
          </div>
        {% endif %}
      </header>

      <!-- NAVBAR (Below Header, No Absolute Positioning) -->
      {# Setup data and logic #}
      {# Get assay groups from config #}
      {% set assay_groups = config.get("ASSAY_GROUPS", {}) %}
      {% set user_groups = current_user.groups or [] %}
      {% set curr_path = request.path %}
      {% set curr_page = curr_path.split('/')[-1] %}

      {% set curr_group = '' %}
      {% for group_name, group in assay_groups.items() %}
        {% if curr_page in group.assays %}
          {% set curr_group = group_name %}
        {% endif %}
      {% endfor %}

      

      <nav class="bg-indigo-300 border-b-4 border-indigo-400 text-sm font-medium text-gray-800">
        <div class="mx-auto p-1 ml-10">
      
          <!-- Top navigation -->
          <div class="flex flex-wrap items-center gap-x-2">
            <!-- Static links -->
            <a href="{{ url_for('dashboard_bp.dashboard') }}"
                class="px-2 py-0.5 rounded-2xl hover:bg-indigo-100 hover:text-black transition
                {% if request.path == url_for('dashboard_bp.dashboard') %} bg-orange-200 text-black font-bold {% endif %}">
                HOME
            </a>
            <a href="{{ url_for('home_bp.home_screen') }}"
                class="px-2 py-0.5 rounded-2xl hover:bg-indigo-100 hover:text-black transition
                {% if request.path == url_for('home_bp.home_screen') %}  bg-orange-200 text-black font-bold {% endif %}">
                SAMPLES
            </a>
            <a href="{{ url_for('genepanels_bp.display_genepanels') }}"
                class="px-2 py-0.5 rounded-2xl hover:bg-indigo-100 hover:text-black transition
                {% if request.path == url_for('genepanels_bp.display_genepanels') %}  bg-orange-200 text-black font-bold {% endif %}">
                GENE-LISTS
            </a>
      
            <!-- Separator -->
            <div class="h-6 w-0.5 bg-gray-800 mx-2"></div>

      
            <!-- Group buttons -->
            {% for group_name, group in assay_groups.items() %}
              {% set assays = group.assays %}
              {% set has_access = assays.keys()|select('in', user_groups)|list %}
              {% if has_access %}
                <button
                  class="group-toggle px-2 py-0.5 rounded-2xl hover:bg-indigo-100 hover:text-black transition
                  {% if curr_page in assays.keys() or curr_group == group_name %}  bg-orange-200 text-black font-bold {% endif %}"
                  data-group="{{ group_name }}">
                  {{ group.label }}
                </button>
              {% endif %}
            {% endfor %}
          </div>
      
          <!-- Assay links for current group -->
          {% for group_name, group in assay_groups.items() %}
            {% set assays = group.assays %}
            {% set show_group = (group_name == curr_group) %}
            {% if assays.keys()|select('in', user_groups)|list %}
              <div class="mt-3 flex flex-wrap gap-1 pl-3 ml-64 group-assays"
                    data-group="{{ group_name }}"
                    style="display: {% if show_group %}flex{% else %}none{% endif %};">
                {% for assay_key, assay in assays.items() %}
                  {% if assay_key in user_groups %}
                    <a href="{{ url_for(assay.url, assay=assay_key) }}"
                        class="px-2 py-0.5 text-xs rounded-2xl hover:bg-indigo-100 hover:text-black transition
                        {% if curr_page == assay_key %}  bg-orange-200 text-black font-semibold {% endif %}">
                        {{ assay.label }}
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </nav>
      
      
    <!-- MAIN CONTENT (SCROLLABLE GRID LAYOUT) -->

      {% block body %}{% endblock %}


    </div>

    <!-- Reusable Confirmation modal -->
    <div id="actionModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
      <div class="bg-blue-50 rounded-xl shadow-xl p-6 w-full max-w-md border border-gray-200">
        <h2 id="actionModalTitle" class="text-xl font-semibold text-gray-800 mb-4">Confirm Action</h2>
        <p id="actionModalMessage" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
        <div class="flex justify-center gap-3">
          <button id="actionModalCancel"
                  class="bg-gray-400 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition">
            Cancel
          </button>
          <a id="actionModalConfirm"
            href="#"
            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition">
            Confirm
          </a>
        </div>
      </div>
    </div>


    <script>

      // JavaScript for Select2 Nav bar
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".group-toggle").forEach(button => {
          button.addEventListener("click", () => {
            const group = button.dataset.group;
    
            document.querySelectorAll(".group-assays").forEach(g => {
              g.style.display = g.dataset.group === group ? "flex" : "none";
            });
    
            document.querySelectorAll(".group-toggle").forEach(b => {
              b.classList.remove("bg-orange-100", "text-black");
            });
            button.classList.add("bg-orange-100", "text-black");
          });
        });
      });

      // JavaScript for Action Modal
      function showActionModal({ url, title = "Confirm Action", message = "Are you sure you want to proceed?", confirmText = "Confirm", confirmColor = "blue" }) {
        const modal = document.getElementById('actionModal');
        const titleEl = document.getElementById('actionModalTitle');
        const messageEl = document.getElementById('actionModalMessage');
        const confirmBtn = document.getElementById('actionModalConfirm');
    
        // Set modal content dynamically
        titleEl.textContent = title;
        messageEl.innerHTML = message;
        confirmBtn.textContent = confirmText;
        confirmBtn.setAttribute('href', url);
    
        // Dynamic confirm button color
        confirmBtn.className = `bg-${confirmColor}-600 hover:bg-${confirmColor}-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition`;
    
        modal.classList.remove('hidden');
      }
    
      document.getElementById('actionModalCancel').addEventListener('click', () => {
        document.getElementById('actionModal').classList.add('hidden');
      });
      

      // JavaScript for User Dropdown Menu
      document.addEventListener('DOMContentLoaded', function() {
        var userMenuButton = document.getElementById('userMenuButton');
        var userDropdown = document.getElementById('userDropdown');

        userMenuButton.addEventListener('click', function(event) {
          event.stopPropagation();
          userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        window.addEventListener('click', function() {
          if (!userDropdown.classList.contains('hidden')) {
            userDropdown.classList.add('hidden');
          }
        });

        // Prevent dropdown from closing when clicking inside
        userDropdown.addEventListener('click', function(event) {
          event.stopPropagation();
        });
      });



        // Flash Message Animation
        document.addEventListener("DOMContentLoaded", function () {
          const alerts = document.querySelectorAll(".flash-message");
          alerts.forEach((alert, index) => {
            let timeoutId;
      
            function startTimeout() {
              timeoutId = setTimeout(() => {
                alert.classList.remove("translate-x-0", "opacity-100");
                alert.classList.add("translate-x-full", "opacity-0");
                setTimeout(() => alert.style.display = "none", 500);
              }, 7000 + index * 100); // currently set tot 7 sec
            }
      
            setTimeout(() => {
              alert.classList.remove("translate-x-full", "opacity-0");
              alert.classList.add("translate-x-0", "opacity-100");
              startTimeout();
            }, 100 + index * 100);
      
            alert.addEventListener("mouseenter", () => clearTimeout(timeoutId));
            alert.addEventListener("mouseleave", startTimeout);
      
            alert.querySelector(".close-btn").addEventListener("click", function () {
              clearTimeout(timeoutId);
              alert.classList.remove("translate-x-0", "opacity-100");
              alert.classList.add("translate-x-full", "opacity-0");
              setTimeout(() => alert.style.display = "none", 500);
            });
          });
        });
      

      // JavaScript for Tooltip functionality
      function showTooltip(event, content) {
        let tooltip = document.getElementById("global-tooltip");

        if (!tooltip) {
            tooltip = document.createElement("div");
            tooltip.id = "global-tooltip";
            tooltip.className = "fixed bg-black text-white text-xs rounded-md shadow-lg p-2 w-auto max-w-xs opacity-0 transition-all duration-200 z-50 pointer-events-none";
            document.body.appendChild(tooltip);
        }

        tooltip.innerHTML = content;
        tooltip.style.opacity = "1";
        tooltip.style.pointerEvents = "auto";

        let x = event.clientX + 15;
        let y = event.clientY + 15;

        // Prevent tooltip from overflowing right edge
        if (x + tooltip.offsetWidth > window.innerWidth) {
            x = event.clientX - tooltip.offsetWidth - 15;
        }
        // Prevent tooltip from overflowing bottom edge
        if (y + tooltip.offsetHeight > window.innerHeight) {
            y = event.clientY - tooltip.offsetHeight - 15;
        }

        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;

        // Hide tooltip when mouse leaves the element
        event.target.addEventListener("mouseleave", function hideTooltip() {
            tooltip.style.opacity = "0";
            tooltip.style.pointerEvents = "none";
            event.target.removeEventListener("mouseleave", hideTooltip);
        });
      }


      // JavaScript for hiding and showing long text 
      function toggleLongText(button) {
        const target = button.dataset.target;
        const short = document.getElementById(`${target}-short`);
        const full = document.getElementById(`${target}-full`);
      
        const isShortVisible = !short.classList.contains('hidden');
        short.classList.toggle('hidden', isShortVisible);
        full.classList.toggle('hidden', !isShortVisible);
      
        button.innerText = isShortVisible ? '[−]' : '[+]';
      }
      
      // Check overflow for all toggle targets
      window.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.text-toggle').forEach(button => {
          const target = button.dataset.target;
          const shortEl = document.getElementById(`${target}-short`);
          if (shortEl && shortEl.scrollWidth > shortEl.clientWidth) {
            button.classList.remove('hidden');
          }
        });
      });

      // JavaScript for autoclick keys tables
      window.onload = function () {
        $('[data-autoclick="true"]').click();
        $('[data-autoclick="true"]').click();
      };

    </script>
    {% block script %}{% endblock %}
    {% block footer %}{% endblock %}
  </body>
</html>
